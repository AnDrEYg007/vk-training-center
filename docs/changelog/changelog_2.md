# Оглавление (Версии 1.19.0 - 1.32.0)

Этот раздел содержит краткий обзор ключевых изменений, сгруппированных по категориям.

### Улучшения бэкенда и логики
- **Точность тегирования** (v1.31.0): Улучшена логика автоматического присвоения тегов для предотвращения ложных срабатываний.
- **Рефакторинг и модульность** (v1.29.0, v1.21.0, v1.20.0): Проведена крупная реорганизация сервисного слоя и схем данных бэкенда для повышения читаемости и поддержки.
- **Надежность публикаций** (v1.28.0, v1.24.0): Внедрена универсальная проверка конфликтов времени и реализована надежная система "Системных Публикаций" с фоновым трекером.
- **Корректность данных** (v1.22.0): Исправлена логика обновления UI после удаления опубликованных постов.

### Улучшения UI/UX и производительности
- **Устранение багов** (v1.32.0, v1.25.0): Исправлена рассинхронизация UI на вкладке "Предложенные посты" и устранен визуальный баг с "подпрыгиванием" кнопок в сайдбаре.
- **Редизайн и новые возможности** (v1.27.0, v1.26.0): Переработан интерфейс создания поста для большей интуитивности и добавлено гранулярное обновление данных в календаре.
- **Оптимизация галереи** (v1.23.0): Обеспечено мгновенное отображение загруженных фотографий без ручного обновления.
- **Исправление ошибок** (v1.20.0): Устранена ошибка `setIsCheckingForUpdates is not a function`.

### Документация
- **Регламент и план тестирования** (v1.30.0): Создан исчерпывающий гайд по всему функционалу, связанному с опубликованными постами, для обеспечения стабильности при будущих доработках.

---
# Журнал изменений (Changelog) - Часть 2

Этот файл содержит историю версий и описание основных изменений в приложении "VK Content Helper", начиная с версии 1.19.0.

## Версия 1.57.0 - 2024-08-03

- **Архитектурное улучшение: Рефакторинг и оптимизация карточки поста (`PostCard`)**
  - **Что сделано:** Проведен глубокий рефакторинг компонента `PostCard` для улучшения его структуры, производительности и устранения бага с "морганием" изображений.
  - **Как работает сейчас:**
    1.  **Выделение логики в хук:** Вся сложная логика по определению доступных действий и их адаптивному распределению вынесена в новый кастомный хук `usePostCardActions`.
    2.  **Декомпозиция на дочерние компоненты:** Все визуальные блоки (`ImageGrid`, `AttachmentsDisplay`, `PostTags`) были вынесены в отдельные, мемоизированные дочерние компоненты.
  - **Что это дает:**
    -   **Устранение "моргания":** Этот рефакторинг полностью решает проблему, при которой изображения "моргали" при изменении состояния родительского компонента (например, при переключении видимости тегов). Теперь дочерние компоненты являются "стабильными", и React может их корректно обновлять, а не перемонтировать.
    -   **Чистота кода:** Основной компонент `PostCard` стал значительно чище и проще для понимания, так как он теперь в основном отвечает за разметку, а не за сложную логику.

## Версия 1.56.0 - 2024-08-03

- **Исправление: Устранена ошибка типизации в хуке `usePostCardActions`**
  - **Что исправлено:** Устранена ошибка TypeScript, возникавшая из-за использования JSX-синтаксиса в `.ts` файле.
  - **Как работает сейчас:** Вместо прямого написания JSX-тегов для иконок, теперь используется вызов `React.createElement`, что является синтаксически корректным для `.ts` файлов, не настроенных для компиляции TSX.
  - **Что дает:** Обеспечивает корректную компиляцию проекта и устраняет ошибки в среде разработки, не влияя на конечный функционал.

## Версия 1.55.0 - 2024-08-03

- **Архитектурное улучшение: Рефакторинг и модульность API-сервисов**
  - **Что сделано:** Проведен крупный рефакторинг файла `services/api.ts`. Вся логика была разделена по доменным областям (проекты, посты, AI, медиа, аутентификация и т.д.) и вынесена в отдельные, сфокусированные файлы в новую директорию `services/api/`.
  - **Как работает сейчас:** Исходный файл `services/api.ts` теперь выполняет роль "хаба" — он просто импортирует и ре-экспортирует функции из новых модульных файлов. Это сохраняет полную обратную совместимость для остального приложения, так как все импорты по-прежнему могут указывать на `services/api`.
  - **Что дает:** Этот рефакторинг не меняет функциональность, но делает архитектуру фронтенда значительно чище, более читаемой и простой для дальнейшей поддержки и расширения.

## Версия 1.54.0 - 2024-08-03

- **Улучшение UX: Контекстные ответы в AI-помощнике**
  - **Что сделано:** Реализована функция "ответить на сообщение" в чате AI-помощника. При двойном клике на сообщении AI или при ответе на него, в запросе пользователя теперь отображается кликабельная цитата исходного сообщения.
  - **Как работает сейчас:** Клик по этой цитате плавно прокручивает историю чата к оригинальному сообщению и подсвечивает его, позволяя легко восстановить контекст диалога. Для улучшения логической структуры, блок с цитатой теперь располагается внизу "пузыря" с запросом пользователя.
  - **Что дает пользователям:** Превращает историю чата из простого списка в связанный диалог. Это значительно улучшает навигацию и понимание контекста при выполнении многошаговых задач с AI.

## Версия 1.53.0 - 2024-08-03

- **Улучшение UX: Исправлено наложение элементов в AI-помощнике**
  - **Что сделано:** Устранена проблема, при которой изменяемое по высоте поле "Результат генерации" могло "прятаться" под нижние элементы интерфейса (поле ввода текста, блок загрузки изображений), если его слишком сильно растянуть. Также стилизована полоса прокрутки для соответствия общему дизайну.
  - **Как работает сейчас:** Максимальная высота контейнера AI-помощника была увеличена. Теперь при изменении размера поля оно корректно сдвигает весь последующий контент вниз, а не "проваливается" под него.
  - **Что дает пользователям:** Более стабильный и предсказуемый интерфейс при работе с AI-генератором. Устранено визуальное несоответствие и улучшено общее впечатление от работы с компонентом.

## Версия 1.52.0 - 2024-08-02

- **Новый функционал: "Умная" сортировка и автонумерация в управлении проектами**
  - **Что внедрено:** На страницу "Управление базой проектов" добавлены две функции для упрощения сортировки:
    1.  **Автоматический сдвиг:** При изменении порядкового номера (`№`) одного проекта, все затронутые проекты теперь автоматически сдвигаются вверх или вниз, чтобы освободить место и избежать дубликатов. Это имитирует перемещение элемента в списке.
    2.  **Автонумерация (кнопка "Auto №"):** Новая кнопка, которая находит максимальный существующий номер и последовательно заполняет все пустые поля `№`, начиная со следующего числа.
  - **Что дает пользователям:** Значительно ускоряет и упрощает процесс ручной и автоматической сортировки проектов, делая его более интуитивным и защищенным от ошибок.

## Версия 1.51.0 - 2024-08-02

-   **Исправление: Устранен критический баг с отображением выпадающего меню "Ещё"**
    -   **Что исправлено:** Устранена проблема с "контекстом наложения" (stacking context), из-за которой выпадающее меню в карточке поста (`PostCard`) могло отображаться под другими элементами интерфейса (например, под следующей карточкой поста).
    -   **Как работает сейчас:** Компонент `ActionsDropdown` был полностью переработан с использованием **React Portal (`createPortal`)**. Теперь выпадающее меню рендерится не внутри карточки, а напрямую в `document.body`. Это выносит его из "ловушки" родительского `z-index` и гарантирует, что оно всегда будет отображаться поверх всех остальных элементов. Также добавлена логика для динамического позиционирования меню относительно его кнопки-триггера.
    -   **Что дает пользователям:** Полностью предсказуемое и корректное поведение интерфейса. Меню "Ещё" теперь всегда доступно и не перекрывается другими элементами, что устраняет путаницу и повышает удобство использования.

## Версия 1.32.0 - 2024-08-02

-   **Исправление: Устранена рассинхронизация UI на вкладке "Предложенные посты"**
    -   **Что исправлено:** Устранен визуальный баг, при котором список предложенных постов в рабочей области не обновлялся после фонового обновления данных (например, когда посты были удалены или добавлены, а счетчик в сайдбаре уже изменился).
    -   **Как работает сейчас:** Компонент теперь корректно отслеживает изменения в глобальном хранилище данных. Как только фоновое обновление завершается, интерфейс немедленно синхронизируется и отображает актуальный список постов, обеспечивая полную консистентность данных на экране.
    -   **Что дает пользователям:** Полностью предсказуемое поведение интерфейса. Пользователь сразу видит результат фоновых обновлений (исчезновение или появление постов) без необходимости переключаться между проектами.

## Версия 1.31.0 - 2024-08-01

-   **Улучшение: Повышена точность присвоения тегов**
    -   **Что сделано:** Усовершенствована логика автоматического присвоения тегов постам на бэкенде.
    -   **Как работает сейчас:** Вместо простого поиска подстроки (`in`), система теперь использует регулярные выражения с границами слова (`\b`). Это гарантирует, что тег сработает только на точное совпадение ключевого слова.
    -   **Что дает пользователям:** Устранена проблема ложных срабатываний. Например, тег с ключевым словом "3" больше не будет ошибочно присваиваться постам, содержащим числа "13" или "33", что делает категоризацию контента значительно точнее.

## Версия 1.30.0 - 2024-08-01

-   **Документация: Создан регламент и план тестирования для опубликованных постов**
    -   **Что сделано:** В техническую документацию фронтенда добавлен новый исчерпывающий гайд (`frontend_docs/07_PUBLISHED_POSTS_GUIDE.md`).
    -   **Зачем это нужно:** Этот документ "замораживает" текущее, корректно работающее поведение всего функционала, связанного с **опубликованными постами**. Он строго регламентирует их внешний вид, все возможные пользовательские взаимодействия (просмотр, редактирование, копирование, удаление, drag-and-drop) и включает детальный пошаговый **план регрессионного тестирования**.
    -   **Что дает:** При любых будущих доработках или рефакторинге этот документ будет служить чек-листом, гарантирующим, что существующий и протестированный функционал не будет нарушен. Это значительно повышает стабильность и предсказуемость приложения в долгосрочной перспективе.

## Версия 1.29.0 - 2024-08-01

-   **Архитектурное улучшение: Рефакторинг сервисного слоя бэкенда**
    -   **Что сделано:** Проведен крупный рефакторинг бэкенда. Монолитный сервис `post_service.py` был разделен на несколько небольших, сфокусированных модулей в соответствии с принципом единственной ответственности.
    -   **Как работает сейчас:**
        -   `post_retrieval_service.py`: Отвечает только за **получение и обновление** данных из VK (например, `refresh_published_posts`).
        -   `post_actions_service.py`: Содержит всю логику **действий** с постами (сохранение, удаление, публикация).
        -   `vk_callback_service.py`: Инкапсулирует всю логику обработки **уведомлений от VK**.
        -   `post_helpers.py`: Содержит вспомогательные функции (например, проверка конфликтов времени).
    -   **Что дает:** Архитектура бэкенда стала значительно чище, более читаемой и простой для дальнейшего расширения, что повышает общую надежность системы.

-   **Исправление: Корректные ссылки на посты и логика обновления UI**
    -   **Что исправлено:** Устранен ряд ошибок, связанных с поведением интерфейса после выполнения действий.
        1.  **Некорректные ссылки:** Кнопка "Посмотреть на VK" в карточках постов теперь всегда ведет на правильный опубликованный или отложенный пост, а не на общую ленту. Это было исправлено как на бэкенде (корректное сохранение `vkPostUrl` в кеш), так и на фронтенде.
        2.  **Неполное обновление:** Реализовано **целевое обновление данных**. Теперь после публикации поста из отложки или системных постов, интерфейс корректно обновляет все затронутые списки (например, и "опубликованные", и "отложенные"), обеспечивая немедленную и точную обратную связь.
        3.  **Модальное окно не закрывалось:** Исправлена ошибка, из-за которой модальное окно не закрывалось после сохранения изменений в уже опубликованном посте.

## Версия 1.28.0 - 2024-08-01

-   **Улучшение надежности: Универсальная проверка конфликтов времени публикации**
    -   **Что сделано:** Реализована универсальная система, предотвращающая создание постов (как системных, так и отложенных VK) в уже занятые временные слоты.
    -   **Как работает сейчас:** Перед сохранением любого **нового** поста, бэкенд теперь проверяет выбранное время на конфликт со **всеми** запланированными публикациями в данном проекте (и системными, и отложенными VK). Если слот занят, время нового поста автоматически сдвигается на 5 минут вперед до тех пор, пока не будет найден свободный слот. Эта проверка не затрагивает редактирование существующих постов.
    -   **Что дает пользователям:** Полностью исключает возможность случайного наложения постов друг на друга, делая планирование контента более надежным и предсказуемым.

## Версия 1.27.0 - 2024-08-01

-   **Улучшение UX: Редизайн процесса создания поста**
    -   **Что сделано:** Кардинально переработан интерфейс модального окна создания/копирования поста для повышения интуитивности и логичности.
    -   **Как работает сейчас:**
        1.  **Приоритет способа публикации:** Блок "Способ публикации" теперь находится в самом верху окна. Это первое, что видит пользователь, что помогает ему сразу определить, как будет опубликован пост.
        2.  **Упрощение выбора:** Вместо переключателя "Поместить в отложку ВК" теперь используется единый блок с тремя понятными кнопками: "Запланировать" (внутренняя система), "В отложку VK" (стандартная отложка VK) и "Опубликовать сейчас".
        3.  **"Умный" интерфейс:** Кнопка "Опубликовать сейчас" автоматически становится неактивной, если пользователь выбирает дату и время в будущем. Если при активном режиме "Опубликовать сейчас" пользователь меняет дату на будущую, режим автоматически переключится на "Запланировать", предотвращая ошибки.
    -   **Что дает пользователям:** Процесс создания поста стал значительно более понятным и защищенным от ошибок. Пользователю больше не нужно искать опции в разных частях окна — все ключевые решения по публикации собраны в одном месте, а интерфейс помогает избежать случайной неправильной настройки.

## Версия 1.26.0 - 2024-08-01

-   **Улучшение UX: Гранулярное обновление данных в календаре**
    -   **Что сделано:** Переработано выпадающее меню кнопки "Обновить" в шапке календаря (`ScheduleHeader`). Меню теперь содержит полный и упорядоченный список того, что можно обновить: "Опубликованные", "Отложенные", "Системные", "Теги", "Заметки" и "Всё".
    -   **Как работает сейчас:** Каждая опция (кроме "Всё") запускает свой, более быстрый и сфокусированный запрос на обновление и имеет собственный индикатор загрузки. Это было достигнуто путем добавления новых функций-обработчиков (`onRefreshSystem`, `onRefreshNotes`) в `ScheduleTab` и соответствующей логики в `ScheduleHeader`.
    -   **Что дает пользователям:** Позволяет обновлять только необходимые данные (например, только заметки или только теги), что значительно быстрее, чем полная перезагрузка. Улучшает отзывчивость интерфейса и дает пользователю больше контроля.

## Версия 1.25.0 - 2024-08-01

-   **Улучшение UI/UX: Устранение "подпрыгивания" кнопок в сайдбаре**
    -   **Что исправлено:** Устранен визуальный баг, при котором кнопки действий в сайдбаре проектов "подпрыгивали" на несколько пикселей в конце анимации выдвижения.
    -   **Как работает сейчас:** Проблема была вызвана пересчетом Flexbox-выравнивания браузером в момент завершения `transition`. Решение заключается в использовании более стабильного подхода: кнопки теперь позиционируются абсолютно внутри выдвигающегося контейнера и центрируются по вертикали с помощью `transform: translateY(-50%)`. Это отвязывает их положение от размеров родителя во время анимации, обеспечивая идеально плавное движение без скачков.
    -   **Что дает пользователям:** Более качественный и профессиональный вид интерфейса без раздражающих визуальных артефактов. Этот подход задокументирован в UI-ките как рекомендуемый для подобных случаев.

## Версия 1.24.0 - 2024-08-01

-   **Новый функционал: Внедрение "Системных Публикаций" и "Пост-трекера"**
    -   **Что внедрено:** Реализована новая, более надежная система отложенной публикации. Теперь посты по умолчанию создаются как "системные" — они хранятся в базе данных приложения, а не в отложенной очереди VK. Специальный фоновый сервис на бэкенде, "Пост-трекер", автоматически публикует их в назначенное время и проверяет успешность выхода.
    -   **Как это работает (UI/UX):**
        1.  **Новый способ создания:** При создании поста теперь по умолчанию создается "системная публикация". Чтобы поместить пост в стандартную отложку VK, необходимо поставить галочку "Поместить в отложку ВК".
        2.  **Визуальное отличие:** Карточки системных постов в календаре имеют пунктирную рамку.
        3.  **Индикаторы статуса:** Системные посты отображают свой текущий статус с помощью иконок:
            -   `pending_publication` (ожидает): иконка часов.
            -   `publishing` (публикуется/проверяется): анимированная иконка настроек (спиннер).
            -   `possible_error` (возможная ошибка): иконка предупреждения (желтый треугольник).
            -   `error` (ошибка): иконка ошибки (красный круг).
        4.  **Новые действия:**
            -   Для постов со статусом `possible_error` появилась кнопка **"Подтвердить публикацию"**, которая убирает пост из системы.
            -   Для постов в статусе `pending_publication` появилась кнопка **"Перенести в отложку VK"**.
        5.  **Безопасность:** Редактирование и удаление поста блокируется, пока он находится в процессе публикации (`publishing`), чтобы избежать конфликтов.
    -   **Как это работает (Технически):**
        -   **Бэкенд:** Добавлена новая таблица `system_posts` в БД. Создан сервис `post_tracker_service`, который каждые 50 секунд проверяет посты для публикации и верификации. Эндпоинт `savePost` теперь обрабатывает флаг `scheduleInVk`. Добавлены новые эндпоинты для управления системными постами.
        -   **Фронтенд:** Добавлено новое состояние `allSystemPosts` в `ProjectsContext`. Компоненты `PostCard` и `PostDetailsModal` обновлены для поддержки новой логики и статусов.
    -   **Что дает пользователям:**
        -   **Надежность:** Устраняет зависимость от очередей VK. Публикация происходит под контролем нашего сервера, что повышает предсказуемость.
        -   **Прозрачность:** Пользователь всегда видит актуальный статус поста прямо в календаре.
        -   **Контроль:** Позволяет вручную управлять "зависшими" или ошибочными публикациями.

## Версия 1.23.0 - 2024-08-01

-   **Исправление: Мгновенное отображение загруженных фотографий в галерее**
    -   **Что исправлено:** Устранена проблема, из-за которой новые фотографии, загруженные в альбом, не появлялись в интерфейсе до ручного обновления. Также не обновлялся счетчик фотографий в списке альбомов.
    -   **Как работает сейчас:** После завершения загрузки всех файлов, приложение теперь автоматически выполняет два последовательных действия: сначала принудительно обновляет список альбомов (чтобы актуализировать счетчик `size`), а затем немедленно запрашивает свежий список фотографий для текущего альбома. Также была исправлена ошибка "stale closure", чтобы гарантировать вызов актуальных функций обновления.
    -   **Что дает пользователям:** Полностью предсказуемое и интуитивное поведение галереи. Пользователь сразу видит результат своих действий — загруженные фотографии появляются в сетке, а счетчик в списке альбомов обновляется, обеспечивая мгновенную обратную связь.

## Версия 1.22.0 - 2024-08-01

-   **Исправление: Корректное обновление расписания после удаления опубликованного поста**
    -   **Что исправлено:** Устранена ошибка, из-за которой при удалении опубликованного поста из календаря система ошибочно обновляла список *отложенных* постов, а не опубликованных.
    -   **Как работает сейчас:** Логика обновления была разделена. Теперь удаление опубликованного поста корректно инициирует обновление списка опубликованных постов, а удаление отложенного — списка отложенных. Это обеспечивает консистентность и предсказуемость интерфейса.
    -   **Что дает пользователям:** После удаления любого поста соответствующая часть календаря немедленно и корректно обновляется, отображая актуальное состояние стены или очереди отложенных публикаций.

## Версия 1.21.0 - 2024-08-01

-   **Архитектурное улучшение: Рефакторинг и модульная структура сервиса VK API**
    -   **Что сделано:** Монолитный файл `vk_service.py` на бэкенде был полностью реорганизован. Вся низкоуровневая логика взаимодействия с API ВКонтакте вынесена в отдельный пакет `services/vk_api/` с четким разделением ответственности.
    -   **Как работает сейчас:**
        1.  **`vk_api/api_client.py`**: Содержит универсальную функцию `call_vk_api` для отправки запросов, включая надежную обработку ошибок и логику повторных попыток.
        2.  **`vk_api/formatters.py`**: Инкапсулирует всю логику преобразования "сырых" данных от VK (посты, альбомы, фото) в наши внутренние структуры.
        3.  **`vk_api/utils.py`**: Содержит все вспомогательные утилиты для работы с идентификаторами и URL.
        4.  **`services/vk_service.py`**: Теперь выступает в роли **высокоуровневого сервиса-хаба**. Он содержит сложную бизнес-логику (например, 3-этапную загрузку фото) и импортирует низкоуровневые функции из `vk_api`, предоставляя их другим сервисам для сохранения **полной обратной совместимости**.
    -   **Что дает:** Этот рефакторинг не меняет функциональность, но делает архитектуру бэкенда значительно чище, более читаемой и простой для дальнейшего расширения. Он четко разделяет обязанности: низкоуровневые сетевые вызовы, преобразование данных и высокоуровневая бизнес-логика теперь находятся в разных, логически сгруппированных файлах.

## Версия 1.20.0 - 2024-08-01

-   **Архитектурное улучшение: Рефакторинг и модульная структура схем данных (Pydantic)**
    -   **Что сделано:** Монолитный файл `schemas.py` на бэкенде был разделен на логические модули в новой директории `schemas/`.
    -   **Как работает сейчас:**
        1.  **`base_models.py`**: Содержит базовые модели данных (`Project`, `Post`, `Tag`), которые переиспользуются в разных частях API.
        2.  **`api_payloads.py`**: Содержит все схемы, описывающие тела **входящих** запросов от фронтенда.
        3.  **`api_responses.py`**: Содержит все схемы, описывающие тела **исходящих** ответов от бэкенда.
        4.  **`__init__.py`**: Обеспечивает обратную совместимость, позволяя остальной части бэкенда продолжать использовать `import schemas` без изменений.
    -   **Что дает:** Этот рефакторинг не меняет функциональность, но делает архитектуру бэкенда значительно чище, более читаемой и простой для дальнейшего расширения.

-   **Исправление: Устранена ошибка `setIsCheckingForUpdates is not a function`**
    -   **Что исправлено:** Устранена ошибка на стороне фронтенда, которая могла приводить к сбою приложения.
    -   **Как работает сейчас:** В компоненте `ProjectsProvider` (`contexts/ProjectsContext.tsx`) исправлена ошибка, из-за которой функции для управления состоянием (`setIsCheckingForUpdates` и `setProjectPermissionErrors`) не передавались в дочерние компоненты.
    -   **Что дает пользователям:** Повышена стабильность приложения, устранены потенциальные сбои при выполнении определенных действий, связанных с обновлением данных.

## Версия 1.19.0 - 2024-08-01

-   **Исправление: Устранена гонка состояний и восстановлена корректная обработка ошибок доступа.**
    -   **Что исправлено:** Устранен критический баг, при котором флаг ошибки доступа (`projectPermissionErrors`) некорректно снимался при массовом обновлении проектов. Также исправлена регрессия, из-за которой флаг ошибки перестал устанавливаться при ручном обновлении или проверке устаревшего кэша, что приводило к бесконечным запросам к API.
    -   **Как работает сейчас:** Логика обработки ошибок была полностью переработана.
        1.  **"Умные" обработчики:** Функции (`handleRefreshScheduled`, `handleRefreshPublished`) снова стали "умными" и теперь самостоятельно устанавливают флаг ошибки при ее возникновении. Это исправляет проблему с бесконечными запросами.
        2.  **"Дирижер":** Функция `handleRefreshForSidebar`, вызываемая при ручном обновлении, теперь является **единственной**, которая имеет право **снимать** флаг ошибки, и делает это только в случае **полного успеха всех** вложенных операций. Это устраняет гонку состояний.
    -   **Что дает пользователям:** Система обработки ошибок теперь работает предсказуемо и надежно. Флаги ошибок корректно устанавливаются при сбоях и не снимаются преждевременно, что предотвращает лишнюю нагрузку на сервер и обеспечивает правильную обратную связь для пользователя.