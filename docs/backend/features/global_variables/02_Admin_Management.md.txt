# Управление определениями глобальных переменных (Admin)

**Ключевой файл:** `backend_python/services/global_variable_service.py`
**Роутер:** `backend_python/routers/global_variables.py`

Этот раздел описывает функционал, предназначенный для администраторов системы, который позволяет создавать, редактировать и удалять "шаблоны" или "типы" глобальных переменных.

---

## 1. Основные функции

### `get_all_definitions(db)`
-   **Назначение:** Получить полный список всех существующих определений глобальных переменных.
-   **Эндпоинт:** `POST /api/global-variables/getAllDefinitions`.
-   **Логика:** Просто вызывает `crud.get_all_definitions` и возвращает результат.
-   **Использование:** Вызывается на странице "Управление базой проектов -> Глобальные переменные" для построения таблицы редактора.

### `update_all_definitions(db, definitions_data)`
-   **Назначение:** Атомарно обновить весь список определений. Эта функция обрабатывает создание, обновление и удаление за один вызов.
-   **Эндпоинт:** `POST /api/global-variables/updateAllDefinitions`.
-   **Логика "Diff-обновления" (реализована в `crud/global_variable_crud.py`):**
    1.  **Определение удаленных:** Функция получает два набора ID: те, что сейчас в БД, и те, что пришли от фронтенда. Разница между ними — это определения, которые нужно удалить. Выполняется `DELETE`.
    2.  **Обновление и создание:** Функция итерирует по списку `definitions_data` от фронтенда:
        -   Если `id` начинается с `new-`, создается новая запись.
        -   Если `id` существующий, запись находится в БД и ее поля обновляются.
    3.  Все изменения применяются в одной транзакции (`db.commit()`).
-   **Использование:** Вызывается при нажатии кнопки "Сохранить" на странице "Управление глобальными переменными".

---

## 2. Сценарий работы (User Flow)

1.  **[Frontend]** Администратор открывает "Управление базой проектов" -> "Глобальные переменные".
2.  **[Frontend]** Вызывается `api.getAllGlobalVariableDefinitions()`.
3.  **[Backend]** `get_all_definitions` возвращает текущий список.
4.  **[Frontend]** Администратор вносит изменения в таблицу (добавляет, редактирует, удаляет строки).
5.  **[Frontend]** Администратор нажимает "Сохранить".
6.  **[Frontend]** `api.updateAllGlobalVariableDefinitions()` отправляет на бэкенд **полный актуальный список** определений из интерфейса.
7.  **[Backend]** `update_all_definitions` выполняет "diff-обновление", синхронизируя состояние базы данных с состоянием, пришедшим от клиента.
8.  **[Frontend]** После успешного сохранения страница перезагружает список определений.