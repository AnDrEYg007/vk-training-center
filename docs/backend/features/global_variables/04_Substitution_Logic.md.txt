# Логика подстановки глобальных переменных в посты

**Ключевой файл:** `backend_python/services/global_variable_service.py`

Это самая важная часть функционала, которая делает переменные полезными. Она отвечает за автоматическую замену плейсхолдеров на реальные значения перед публикацией поста.

---

## 1. Основная функция `substitute_global_variables`

### `substitute_global_variables(db, text, project_id)`
-   **Назначение:** Найти в тексте все плейсхолдеры вида `{global_...}` и заменить их на значения, специфичные для данного `project_id`.
-   **Когда вызывается:**
    -   Из `post_actions_service.py` непосредственно перед вызовом `wall.post` (для немедленной публикации и отложки VK).
    -   Из `post_tracker_service.py` непосредственно перед публикацией системного поста.

### 2. Пошаговая логика

1.  **Быстрая проверка:** Функция сначала проверяет, есть ли в тексте подстрока `{global_`. Если нет, она немедленно возвращает исходный текст, экономя запросы к БД.

2.  **Загрузка данных:** Для эффективности функция загружает **все** определения и **все** значения для текущего проекта за два запроса к БД.
    ```python
    definitions = crud.get_all_definitions(db)
    project_values = crud.get_values_by_project_id(db, project_id)
    ```

3.  **Создание словарей для поиска:** Данные преобразуются в словари для мгновенного доступа:
    -   `definitions_map`: `{ 'placeholder_key': 'definition_id', ... }`
    -   `values_map`: `{ 'definition_id': 'значение', ... }`

4.  **Поиск и замена с помощью Regex:**
    -   Используется регулярное выражение `re.sub(r'\{global_(\w+)\}', replace_match, text)`.
    -   `r'\{global_(\w+)\}'`: Находит все вхождения `{global_` + `любые_буквы_цифры_` + `}` и "захватывает" ключ в группу.
    -   `replace_match`: Это функция-колбэк, которая вызывается для каждого найденного совпадения.

5.  **Логика внутри `replace_match`:**
    -   **Шаг 1:** Найти `definition_id` по `placeholder_key` в `definitions_map`.
    -   **Шаг 2:** Если `definition_id` найден, найти `value` по этому ID в `values_map`.
    -   **Шаг 3 (Обработка отсутствия значения):** Если `value` не найдено для данного проекта, функция вернет пустую строку `''`. Это сделано намеренно, чтобы в посте не оставался плейсхолдер, если пользователь забыл заполнить значение.
    -   **Шаг 4 (Обработка удаленного определения):** Если `definition_id` не найден (например, администратор удалил это определение), функция также вернет пустую строку `''` для безопасности.

**Пример:**
-   Текст: `Наш адрес: {global_address}. Звоните: {global_phone}.`
-   `project_id`: "project-sushi"
-   `definitions_map`: `{ 'address': 'def-1', 'phone': 'def-2' }`
-   `values_map`: `{ 'def-1': 'ул. Ленина, 10' }` (значение для телефона не задано)

**Результат:** `Наш адрес: ул. Ленина, 10. Звоните: .`

---

## 3. Предпросмотр на фронтенде

Для системных постов (`PostCard`) фронтенд также реализует логику подстановки для **предварительного просмотра**. Это достигается передачей `allGlobalVarDefs` и `projectGlobalVarValues` в компонент, где JavaScript выполняет аналогичную замену "на лету" перед рендерингом текста.

**Важно:** Финальная, "боевая" подстановка всегда происходит на бэкенде.