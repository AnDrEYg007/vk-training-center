
# Получение данных и Фильтрация (System Lists)

**Ключевой файл (CRUD):** `backend_python/crud/lists/retrieval.py`
**Модуль фильтров:** `backend_python/services/lists/retrieval/filters.py`

Этот документ описывает, как фронтенд получает данные для таблиц и как на стороне бэкенда реализована логика фильтрации.

---

## 1. Логика фильтрации на бэкенде

Вся фильтрация выполняется на уровне SQL-запросов (SQLAlchemy) в функции `apply_filters`.

### Сложные фильтры (Новое)

#### а) Возраст (`filterAge`)
В VK API нет поля "возраст", есть только `bdate` (строка "D.M.YYYY"). Фильтрация по возрасту реализована математически:
1.  Frontend передает диапазон (например, `16-20`).
2.  Backend вычисляет соответствующие **годы рождения**: `CurrentYear - MinAge` ... `CurrentYear - MaxAge`.
3.  Генерируется набор условий `LIKE`: `bdate LIKE '%.YYYY' OR bdate LIKE '%.YYYY' ...`.
4.  Это позволяет фильтровать пользователей, даже если дата рождения хранится как строка.

#### б) Месяц рождения (`filterBdateMonth`)
Позволяет найти именинников.
*   Реализация: `bdate LIKE '%.{month}.%'` или `bdate LIKE '%.{month}'` (для случаев без года).

#### в) Платформа (`filterPlatform`)
Фильтрует пользователей по устройству, с которого был выполнен последний вход (`last_seen.platform`).
*   **Коды:**
    *   `1`: m.vk (Мобильная версия)
    *   `2`: iPhone
    *   `4`: Android
    *   `7`: Web (Полная версия)
*   **Использование:** Позволяет сегментировать аудиторию (например, найти только пользователей Android).

### Стандартные фильтры

#### г) Поиск (`searchQuery`)
*   **Smart Search:**
    *   Если введена ссылка (`vk.com/durov`), извлекается ID.
    *   Если число — ищет по `vk_user_id`.
    *   Иначе — `ILIKE` по `first_name`, `last_name` или `domain`.

#### д) Качество (`filterQuality`)
*   `active`: `deactivated IS NULL`.
*   `banned` / `deleted`: проверка поля `deactivated`.

#### е) Сообщения (`filterCanWrite`) - Только для Mailing
*   `allowed`: `can_access_closed IS TRUE`.
*   `forbidden`: `can_access_closed IS NOT TRUE`.

---

## 2. Пагинация

*   Стандартный размер страницы: **50 элементов**.
*   Используется `OFFSET` / `LIMIT`.
*   Frontend реализует "Бесконечную прокрутку" (Infinite Scroll), подгружая следующие страницы по мере скролла.
