# Управление Подборками Товаров (Альбомами)

**Ключевой файл:** `backend_python/services/market_album_service.py`
**Роутер:** `backend_python/routers/market.py`

Этот модуль отвечает за операции, связанные с управлением подборками товаров (в терминологии VK API — "альбомами"). На данный момент реализована ключевая функция — создание новой подборки.

---

## 1. Концепция

Подборки позволяют группировать товары в магазине сообщества VK для удобной навигации покупателей. Бэкенд кеширует список подборок в таблице `market_albums` для быстрой загрузки интерфейса. Этот сервис позволяет создавать новые подборки и синхронизировать их с локальным кешем.

---

## 2. API и Поток данных

### `POST /api/market/createAlbum`
-   **Назначение:** Создать новую подборку товаров в сообществе VK и в локальной базе данных.
-   **Payload:** `schemas.CreateAlbumPayload` (`projectId`, `title`).
-   **Сервис:** `market_album_service.create_market_album(db, project_id, title, user_token)`.

### Пошаговая логика `create_market_album`:

1.  **Поиск проекта:** Находит проект в БД для получения `vkProjectId`.
2.  **Вызов VK API:** Вызывает метод `market.addAlbum` VK API, передавая `owner_id` (ID сообщества) и `title` (название новой подборки).
3.  **Обработка ответа:** VK возвращает `market_album_id` созданной подборки.
4.  **Создание в кеше:** На основе полученного ID и переданного названия, сервис создает новый объект `models.MarketAlbum`.
5.  **Сохранение в БД:** Вызывает `crud.create_market_album` для сохранения новой записи в таблицу `market_albums`. Это гарантирует, что новая подборка немедленно появится в интерфейсе без необходимости полного обновления.
6.  **Возврат результата:** Возвращает Pydantic-схему `schemas.MarketAlbum` на фронтенд.

---

## 3. Ограничения

-   **Обновление и удаление:** На данный момент функционал для редактирования названия или удаления подборок через API не реализован, так как это относительно редкие операции. Предполагается, что они выполняются вручную через интерфейс ВКонтакте. После таких изменений для синхронизации данных достаточно выполнить полное обновление товаров (`/api/market/refreshAll`).