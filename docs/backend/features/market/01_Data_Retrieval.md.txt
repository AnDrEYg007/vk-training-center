# Получение и кеширование данных о товарах

**Ключевой файл:** `backend_python/services/market_retrieval_service.py`

Этот модуль отвечает за "умную" загрузку и обновление данных о товарах, подборках и категориях из VK, а также за управление их кешем в базе данных.

---

## 1. Основные функции

### `get_market_data(db, project_id, user_token)`
-   **Назначение:** Главная точка входа для получения всех данных о товарах для проекта.
-   **Логика "умного" кеширования:**
    1.  Проверяет поле `last_market_update` у проекта в таблице `projects`.
    2.  Если дата обновления — **сегодняшняя**, функция считает кеш "свежим" и немедленно возвращает данные из локальной базы данных, вызывая `crud`-функции.
    3.  Если дата обновления — **вчерашняя или более ранняя** (или отсутствует), функция считает кеш "устаревшим" и автоматически запускает `refresh_all_market_data` для полной синхронизации.
-   **Связи:**
    -   Вызывается из: `routers/market.py`.
    -   Вызывает: `refresh_all_market_data`, `crud.get_market_albums_by_project`, `crud.get_market_items_by_project`.

### `refresh_all_market_data(db, project_id, user_token)`
-   **Назначение:** Выполняет полную, принудительную синхронизацию данных о товарах с VK API, полностью перезаписывая кеш.
-   **Пошаговая логика (Оптимизированная):**
    1.  **Категории:** Вызывает `get_market_categories`, чтобы убедиться, что глобальный кеш категорий существует.
    2.  **Подборки (Альбомы):** Вызывает `market.getAlbums` для получения списка всех подборок товаров. Заменяет старый кеш подборок через `crud.replace_market_albums_for_project`.
    3.  **Загрузка всех товаров:**
        -   Вместо медленной итерации по каждой подборке, запускается **единый цикл** получения всех товаров сообщества (`market.get`) с использованием пагинации (шаг 200).
        -   В запросе используется параметр `extended=1`. Благодаря этому VK возвращает поле `albums_ids` для каждого товара, указывающее, в каких подборках он находится.
        -   Это кардинально снижает количество API-запросов (например, для магазина с 300 товарами и 70 подборками количество запросов падает с 73 до 3).
    4.  **Замена кеша:** Все полученные товары атомарно заменяют старые данные в таблице `market_items` через `crud.replace_market_items_for_project`.
    5.  **Обновление метки:** Обновляет поле `last_market_update` у проекта на текущее время.
-   **Связи:**
    -   Вызывается из: `routers/market.py` (принудительно) и `get_market_data` (автоматически).
    -   Вызывает: `vk_service.call_vk_api`, `crud.replace_market_albums_for_project`, `crud.replace_market_items_for_project`, `crud.update_project_last_update_time`.

### `get_market_categories(db, user_token)`
-   **Назначение:** Получить глобальный список категорий товаров VK.
-   **Логика кеширования:**
    1.  Проверяет, есть ли записи в таблице `market_categories`.
    2.  Если есть, возвращает их из кеша.
    3.  Если нет, делает запрос к `market.getCategories` VK API, сохраняет результат в БД через `crud.replace_market_categories` и возвращает его.
-   **Связи:**
    -   Вызывается из: `routers/market.py` и `refresh_all_market_data`.
    -   Вызывает: `vk_service.call_vk_api`, `crud.replace_market_categories`.