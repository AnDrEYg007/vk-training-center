# AI-помощник для товаров

**Ключевой файл:** `backend_python/services/market_ai_service.py`

Этот модуль инкапсулирует всю сложную логику взаимодействия с Gemini API для автоматизации рутинных задач при работе с товарами.

---

## 1. Основные функции

### `suggest_market_category(db, payload)`
-   **Назначение:** Подобрать наиболее подходящую категорию для **одного** товара на основе его названия и описания.
-   **Логика "Двухэтапного подбора":**
    1.  **Этап 1: Выбор родительских секций.**
        -   Формируется промпт, содержащий название/описание товара и **список всех родительских секций** (`Товары для детей`, `Мебель` и т.д.).
        -   AI просят вернуть JSON-массив из 2-3 наиболее подходящих ID секций.
        -   *Причина:* Полный список категорий VK (сотни позиций) не помещается в контекст одного запроса к AI.
    2.  **Этап 2: Выбор финальной подкатегории.**
        -   Из кеша в БД извлекаются **только те подкатегории**, которые принадлежат секциям, выбранным на Этапе 1.
        -   Формируется второй промпт, содержащий название/описание товара и этот **отфильтрованный список подкатегорий**.
        -   AI просят вернуть JSON-объект с ID **одной** финальной категории.
-   **Связи:**
    -   Вызывается из: `routers/market_ai.py`.
    -   Вызывает: `gemini_service.generate_text`, `crud.get_all_market_categories`.

### `bulk_suggest_market_category(db, payload)`
-   **Назначение:** Оптимизированный подбор категорий для **списка** товаров.
-   **Логика:** Аналогична одиночному подбору, но использует пакетные запросы.
    1.  **Этап 1: Пакетный выбор секций.**
        -   Формируется один большой промпт, содержащий **список всех товаров** и список всех секций.
        -   AI просят вернуть **один JSON-объект** вида `{"itemId": [sectionId1, sectionId2], ...}`.
    2.  **Этап 2: Пакетный выбор подкатегорий.**
        -   Собираются **все уникальные** секции из ответа AI.
        -   Формируется второй большой промпт со списком всех товаров и **расширенным списком подкатегорий** из всех затронутых секций.
        -   AI просят вернуть **один JSON-объект** вида `{"itemId": finalCategoryId, ...}`.
-   **Fallback-механизм:** Если пакетный запрос к AI завершается ошибкой (например, невалидный JSON), система автоматически переключается на медленный, но надежный **поэлементный вызов** `_suggest_single_category` для каждого товара.

### `bulk_correct_descriptions(db, payload)` / `bulk_correct_titles(db, payload)`
-   **Назначение:** Массово исправить орфографию и пунктуацию в описаниях или названиях товаров.
-   **Логика:**
    1.  Формируется один большой промпт, содержащий список всех текстов в формате `{"itemId": "text", ...}`.
    2.  AI просят вернуть JSON-объект с тем же форматом, но с исправленным текстом.
    3.  Результат парсится и возвращается на фронтенд.
-   **Связи:**
    -   Вызывается из: `routers/market_ai.py`.
    -   Вызывает: `gemini_service.generate_text`.