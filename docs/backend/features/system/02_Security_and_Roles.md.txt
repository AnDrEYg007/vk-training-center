# Безопасность и управление ролями

**Ключевые файлы:** `services/auth_service.py`, `services/user_service.py`, `routers/auth.py`

Этот документ описывает модель безопасности приложения, включая аутентификацию и разделение прав доступа по ролям.

---

## 1. Двухуровневая модель ролей

Система использует простую, но эффективную двухуровневую модель ролей для разграничения доступа:

### 1.1. `admin` (Администратор)

-   **Назначение:** Суперпользователь с полным доступом ко всем функциям системы.
-   **Источник данных:** Учетные данные администратора (`ADMIN_USERNAME`, `ADMIN_PASSWORD`) жестко задаются через **переменные окружения** (или файл `.env` для локальной разработки). Администратор **не хранится** в таблице `users` в базе данных.
-   **Права доступа:**
    -   Все права обычного пользователя.
    -   Доступ к странице **"Управление пользователями"**: создание, редактирование и удаление учетных записей других пользователей.
    -   Доступ к странице **"Управление базой проектов"**: массовое добавление/редактирование проектов, доступ к архиву и **безвозвратному удалению** проектов.
    -   Доступ к странице **"Управление глобальными переменными"**.

### 1.2. `user` (Пользователь)

-   **Назначение:** Стандартный пользователь системы с доступом к основным рабочим функциям.
-   **Источник данных:** Учетные данные пользователей хранятся в таблице `users` в базе данных.
-   **Права доступа:**
    -   Доступ к основным модулям: "Контент-менеджмент" (Календарь, Предложка, Товары).
    -   Доступ к "Центру обучения".
    -   **Нет доступа** к разделам администрирования (управление пользователями, проектами, глобальными переменными).

---

## 2. Процесс аутентификации

-   **Эндпоинт:** `POST /api/auth/login`.
-   **Сервис:** `auth_service.authenticate_user(db, username, password)`.

### Пошаговая логика `authenticate_user`:

1.  **Проверка на администратора:** Сначала сервис сравнивает полученные `username` и `password` с учетными данными администратора из `config.settings`. Если они совпадают, немедленно возвращается ответ с `role: "admin"`.

2.  **Проверка на пользователя:** Если проверка на администратора не прошла, сервис ищет пользователя в таблице `users` по `username` (`crud.get_user_by_username`).
    -   Если пользователь найден и пароли совпадают, возвращается ответ с `role: "user"`.
    -   **Безопасность паролей:** В текущей реализации пароли хранятся в открытом виде для простоты. В будущих версиях здесь должно быть сравнение хэшей паролей.

3.  **Ошибка:** Если ни одна из проверок не прошла, возвращается `None`, что приводит к ошибке `401 Unauthorized`.

---

## 3. Защита API эндпоинтов

На текущем этапе развития проекта, защита API реализована на **уровне фронтенда**:

-   **Фронтенд:** Компонент `PrimarySidebar` и другие навигационные элементы просто **не рендерят** кнопки и ссылки на разделы администрирования, если у текущего пользователя (`useAuth().user.role`) не `admin`.

-   **Бэкенд:** На данный момент на бэкенде **нет** строгой проверки ролей на уровне каждого эндпоинта (например, через механизм `Depends` в FastAPI). Это означает, что если обычный пользователь каким-то образом отправит запрос на эндпоинт администрирования, он, скорее всего, будет выполнен.

**План развития:** В будущих версиях необходимо внедрить на бэкенде систему зависимостей (dependencies), которая будет проверять JWT-токен и роль пользователя перед выполнением защищенных эндпоинтов, обеспечивая полную безопасность на стороне сервера.