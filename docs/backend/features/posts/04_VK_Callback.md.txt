# Обработка уведомлений от VK (Callback API)

**Ключевой файл:** `backend_python/services/vk_callback_service.py`

Этот модуль отвечает за обработку всех асинхронных уведомлений, которые VK присылает на наш сервер.

---

## 1. Основная функция `handle_vk_callback`

Это единственная точка входа для всех колбэков, которая выступает в роли маршрутизатора.

-   **Эндпоинт:** `POST /api/callback`.

### 1.1. Поток работы

1.  **Получение запроса:** Функция принимает `VkCallbackRequest`, содержащий `type` и `group_id`.
2.  **Маршрутизация по `type`:**
    -   **`confirmation`:** Это запрос от VK для подтверждения адреса сервера. Функция находит проект по `group_id`, извлекает `vk_confirmation_code` и возвращает его.
    -   **`wall_post_new` (с `post_type: 'suggest'`)**: Уведомление о новом предложенном посте.
    -   **`postponed_new`**, **`postponed_delete`**: Уведомления об изменениях в отложенной очереди VK.
    -   **`wall_post_new` (обычный пост)**: Уведомление о новом опубликованном посте.

### 1.2. Принцип "Не доверяй, а проверяй"

Ключевой архитектурный принцип этого модуля: **никогда не полагаться на данные из тела колбэка**. Данные в `object` могут быть неполными или устаревшими.

-   **Логика:** Вместо того чтобы пытаться обработать `object` из колбэка, система при любом событии (например, `postponed_new`) запускает **полную синхронизацию** соответствующего раздела.
    -   При `postponed_new` -> вызывается `refresh_scheduled_posts`.
    -   При `wall_post_new` с типом `suggest` -> вызывается `refresh_suggested_posts`.
-   **Преимущество:** Этот подход гарантирует 100% консистентность данных. Даже если мы пропустили несколько колбэков, один успешный вызов синхронизирует все состояние.

### 1.3. Интеграция с трекером обновлений

-   После каждой успешной синхронизации (например, после `refresh_scheduled_posts`) функция вызывает `update_tracker.add_updated_project(project.id)`.
-   Это "зажигает" синюю точку в интерфейсе фронтенда, сообщая пользователю о наличии новых данных.

### 1.4. Ответ VK

-   Вне зависимости от результата обработки, функция **всегда** возвращает `PlainTextResponse(content='ok')`.
-   Это обязательно, так как любой другой ответ заставит VK считать уведомление недоставленным и повторять его отправку.