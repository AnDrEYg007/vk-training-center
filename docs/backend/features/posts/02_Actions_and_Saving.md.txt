# Действия с постами: Сохранение, удаление, публикация

**Ключевой файл:** `backend_python/services/post_actions_service.py`
**Специализированные модули:** `services/post_actions/save_vk.py`, `services/post_actions/publish.py`

Этот модуль содержит основную бизнес-логику для всех операций, изменяющих состояние постов.

---

## 1. Стратегия "Fallback" при публикации

Для операций записи (`wall.post`, `wall.edit`) используется специальный механизм `publish_with_fallback` в `vk_service`, который отличается от стандартной ротации при чтении.

1.  **Приоритет токена сообщества:** При создании **нового** поста (`wall.post`), система первым делом пытается использовать `communityToken` (токен самого сообщества), указанный в настройках проекта. Это позволяет публиковать посты "от имени группы" без участия личного аккаунта.
2.  **Откат к токенам пользователей:** Если токен сообщества отсутствует или невалиден, система автоматически переключается на перебор токенов пользователей (из `.env` и пула системных аккаунтов).
3.  **Редактирование:** При редактировании (`wall.edit`) токен сообщества не имеет приоритета (так как редактировать может любой админ), и система перебирает все доступные токены, пока не найдет тот, у которого есть права на изменение этого конкретного поста.

---

## 2. Основные функции

### `save_post(db, payload, user_token)`
-   **Назначение:** Главная функция-диспетчер для сохранения поста.
-   **Логика маршрутизации:**
    1.  **Приоритет 1 (Немедленная публикация):** Если `payload.publishNow` равно `True`, функция вызывает `publish_now`.
    2.  **Приоритет 2 (Отложка VK):** Если `payload.scheduleInVk` равно `True`, функция вызывает `_save_to_vk_schedule`.
    3.  **Приоритет 3 (Системный пост):** Во всех остальных случаях функция вызывает `_save_as_system_post`.

### `publish_now(db, payload, user_token, delete_original)`
-   **Назначение:** Опубликовать пост немедленно.
-   **Логика:**
    1.  Подстановка глобальных переменных.
    2.  Вызов `vk_service.publish_with_fallback` с методом `wall.post`.
    3.  Если пост был перенесен из отложенных, удаление оригинала из БД.
    4.  Попытка сразу получить созданный пост (`wall.getById`) для сохранения в кеш с полными данными (картинками, ссылками).

### `save_to_vk_schedule(db, payload, user_token)`
-   **Назначение:** Сохранить пост в официальную "отложку" VK.
-   **Логика:**
    1.  Проверка и корректировка времени публикации (защита от конфликтов).
    2.  Если пост новый -> `wall.post` (с `publish_date`). Если существующий -> `wall.edit`.
    3.  Использует `publish_with_fallback` для надежности.
    4.  При ошибке `214` (Time conflict) делает до 12 попыток, сдвигая время на 5 минут вперед.

---

## 3. Фоновые задачи (Background Tasks)

Операции с VK API (особенно публикация и сохранение в отложку) могут занимать много времени из-за механизма ротации токенов и повторных попыток. Чтобы избежать таймаутов HTTP-запроса (особенно при Drag-and-Drop или публикации "сейчас"), используются фоновые задачи.

### `schedule_post_task(task_id, payload, delete_original_id, user_token)`
-   **Назначение:** Асинхронное сохранение в отложку VK.
-   **Использование:** Вызывается при Drag-and-Drop перемещении поста в календаре (если целевой слот — отложка VK). Это критично, так как браузер может разорвать соединение, если перемещение займет больше нескольких секунд.
-   **Логика:**
    1.  Обновляет статус задачи в `Task Monitor` (processing).
    2.  Вызывает `save_to_vk_schedule`.
    3.  Если это было перемещение, удаляет старый пост (`delete_original_id`).
    4.  Обновляет статус задачи на `done` или `error`.

### `publish_post_task(task_id, payload, user_token)`
-   **Назначение:** Асинхронная немедленная публикация.
-   **Использование:** Вызывается при нажатии "Опубликовать сейчас" в модальном окне.
-   **Логика:** Аналогична `publish_now`, но выполняется в фоне с обновлением статуса через `Task Monitor`. Это позволяет фронтенду показывать спиннер загрузки и не блокировать интерфейс ожиданием ответа.