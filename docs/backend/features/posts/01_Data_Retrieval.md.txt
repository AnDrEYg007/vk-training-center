
# Получение и обновление данных о постах

**Ключевой файл:** `backend_python/services/post_retrieval_service.py`

Этот модуль отвечает за загрузку и обновление кеша всех типов постов (опубликованных, отложенных, предложенных) из VK API.

---

## 1. Основные функции

### `get_published_posts(db, project_id)` / `get_scheduled_posts(db, project_id)` / `get_suggested_posts(db, project_id)`
-   **Назначение:** Получить список постов определенного типа для проекта **из локального кеша (БД)**.
-   **Логика:** Просто вызывают соответствующие `crud`-функции (`get_posts_by_project_id`, `get_scheduled_posts_by_project_id` и т.д.).
-   **Связи:** Вызываются из `routers/posts.py`.

### `refresh_published_posts` и `refresh_scheduled_posts`
-   **Назначение:** Принудительно обновить кеш опубликованных и отложенных постов.
-   **Стратегия:** **Standard Rotation**.
    -   Используется высокоуровневая функция `vk_service.call_vk_api`, которая автоматически управляет ротацией токенов.
    -   Система сначала пытается использовать токены из пула системных аккаунтов (таблица `system_accounts`).
    -   Если ни один системный токен не сработал, используется резервный токен из `.env`.
    -   Запрос считается успешным, если **хотя бы один** токен смог получить данные.
-   **Пошаговая логика:**
    1.  Вызывает `wall.get` (с фильтром `postponed` для отложенных).
    2.  **Дедупликация:** Фильтрует дубликаты, чтобы избежать ошибок уникальности в БД.
    3.  Форматирует посты и присваивает теги (`assign_tags_to_post`).
    4.  Атомарно заменяет кеш в БД (`crud.replace_...`).
    5.  Для опубликованных постов: дополнительно синхронизирует их с модулем "Системные списки".

### `refresh_suggested_posts`
-   **Назначение:** Обновить кеш предложенных ("предложка") постов.
-   **Проблема:** Этот раздел виден **только** администраторам и редакторам сообщества. Обычный токен (даже рабочий) может не иметь прав на их просмотр, вернув пустой список без ошибки доступа.
-   **Решение: Стратегия "Broadcast" (Широковещательный опрос).**
    -   Функция собирает **ВСЕ** доступные токены: токен из `.env` и все токены системных аккаунтов из БД.
    -   Она делает запрос к VK API (`wall.get` с фильтром `suggests`) используя **каждый** уникальный токен по очереди.
    -   **Выбор победителя:** Из всех полученных ответов выбирается "лучший" — тот, который содержит наибольшее количество постов (`count`).
    -   Это гарантирует получение данных, если хотя бы один из подключенных аккаунтов имеет права администратора в целевой группе.

### `get_all_data_for_projects(db, project_ids)`
-   **Назначение:** Эффективно загрузить **все типы данных** (посты, заметки) для **списка** проектов одним запросом.
-   **Логика:** Делает несколько запросов к БД, используя оператор `IN` для фильтрации по списку `project_ids`, а затем группирует результаты в словарь `{ projectId: [...] }`.
-   **Связи:** Вызывается из `routers/posts.py` при первоначальной загрузке приложения и при принудительном обновлении списка проектов.

### `get_project_update_status(db)`
-   **Назначение:** Определить, для каких проектов кеш является "устаревшим".
-   **Логика:**
    -   Для опубликованных и отложенных постов: сравнивает `last_published_update` и `last_scheduled_update` с текущим временем (порог — 12 часов).
    -   Для предложенных постов: проверяет, было ли последнее обновление сегодня.
-   **Связи:** Вызывается фронтендом в `App.tsx` для "умного" обновления.
