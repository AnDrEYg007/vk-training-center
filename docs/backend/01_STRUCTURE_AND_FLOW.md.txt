# 1. Структура файлов и поток данных

Этот документ описывает, как организован код бэкенда и как типичный запрос проходит через систему.

## 1. Структура файлов (`backend_python/`)

Каждый файл и папка имеют четко определенную роль:

-   **`main.py`**: **Точка входа.** Инициализирует FastAPI, настраивает CORS, подключает все роутеры и запускает первоначальные миграции БД.

-   **`database.py`**: **Настройка БД.** Определяет подключение к файлу `vk_planner.db` (SQLite) или к PostgreSQL и создает "фабрику" сессий (`SessionLocal`) для взаимодействия с БД.

-   **`models.py`**: **Схема БД (Хаб).** Импортирует и объединяет все SQLAlchemy-модели из пакета `models_library/`. Служит единой точкой входа для импорта моделей БД.

-   **Папка `schemas/`**: **Контракт API.** Определяет структуру данных для запросов и ответов API с помощью Pydantic.
    -   **`models/`**: **Модели данных.** Содержит Pydantic-схемы, сгруппированные по доменным областям (`projects.py`, `posts.py`, `market.py`, `lists.py` и т.д.).
    -   **`base_models.py`**: **Хаб.** Импортирует схемы из `schemas/models/` и предоставляет их остальной части приложения.
    -   `api_payloads.py`: Схемы для **входящих** запросов.
    -   `api_responses.py`: Схемы для **исходящих** ответов.

-   **Папка `db_migrations/`**: **Логика миграций.** Содержит скрипты миграции, разделенные по доменным областям (`projects.py`, `posts.py`, `lists.py` и т.д.).
-   **`migrations.py`**: **Оркестратор миграций.** Хаб, который запускает все миграции из папки `db_migrations/` в строгом порядке.

-   **Папка `crud/`**: **Слой доступа к данным (DAL).** Содержит функции для базовых операций с БД.

-   **`config.py`**: **Конфигурация.** Загружает секретные ключи (токены) из файла `.env`.

-   **Папка `routers/`**: **Обработчики HTTP-запросов.** Принимают запросы, валидируют данные и вызывают сервисы.

-   **Папка `services/`**: **Бизнес-логика.**
    -   **`services/vk_api/`**: **Низкоуровневый пакет VK.**
        -   `api_client.py`: Базовый клиент с ретраями.
        -   `token_manager.py`: Логика ротации токенов.
        -   `upload.py`: Сложная логика загрузки файлов (3 шага).
        -   `methods.py`: Обертки над конкретными методами API.
    -   **`services/vk_service.py`**: **Фасад (Hub).** Импортирует функции из пакета `vk_api` и предоставляет единый интерфейс для остальных сервисов.
    -   **`services/lists/`**: Логика системных списков (синхронизация, статистика).

## 2. Поток обработки запроса

Рассмотрим, как обрабатывается типичный запрос, например, на обновление отложенных постов.

**`[Клиент] -> [FastAPI] -> [Router] -> [Service] -> [VK Service (Facade)] -> [Token Manager] -> [API Client] -> [Database]`**

1.  **Клиент (React)**: Вызывает API.
2.  **Router**: Валидирует запрос через Pydantic (импортированный из `schemas/base_models.py` -> `schemas/models/posts.py`).
3.  **Service**: Вызывает `vk_service.call_vk_api`.
4.  **VK Service (Facade)**: Перенаправляет вызов в `vk_api.token_manager`.
5.  **Token Manager**: Выбирает подходящий токен (ротация) и вызывает `vk_api.api_client`.
6.  **API Client**: Выполняет HTTP-запрос к VK с ретраями.
7.  **Service**: Получает данные и сохраняет их через CRUD в БД.