# Фасад VK API: `vk_service.py`

**Ключевой файл:** `backend_python/services/vk_service.py`

Этот модуль играет роль **"Фасада"** — высокоуровневого сервиса, который предоставляет остальной части приложения простой и удобный интерфейс для выполнения сложных, многошаговых операций с VK API.

---

## 1. Назначение и Роль

Основная задача `vk_service` — скрыть сложную внутреннюю реализацию взаимодействия с VK за набором понятных функций.

1.  **Инкапсуляция сложных процессов:** Функции в этом модуле, такие как `upload_wall_photo`, инкапсулируют многоэтапные процессы (получение URL сервера -> загрузка файла -> сохранение фото) в один вызов.
2.  **Обратная совместимость и "Хаб":** Модуль импортирует все низкоуровневые функции из пакета `vk_api/` и ре-экспортирует их. Это позволяет другим сервисам (например, `post_service`) продолжать использовать единую точку входа (`import services.vk_service`), даже после рефакторинга и разделения логики.

---

## 2. Механизм Ротации Токенов (Token Rotation)

Для повышения отказоустойчивости системы, высокоуровневая функция `call_vk_api` в этом модуле реализует **двухуровневую систему ротации и резервирования (fallback)** для всех запросов, использующих **сервисный токен пользователя** (например, для чтения данных, редактирования постов, получения информации о группах).

### 2.1. Принцип работы

1.  **Уровень 1 (Приоритетный): Пул Системных Токенов**
    -   **Источник:** Таблица `system_accounts` в базе данных.
    -   **Логика:** При вызове `call_vk_api` система сначала запрашивает у базы данных список всех токенов из системных аккаунтов со статусом `active`.
    -   Затем она последовательно пытается выполнить запрос, используя **каждый токен из этого пула**. Если один токен не срабатывает (например, из-за временной блокировки или ошибки), система автоматически пробует следующий.
    -   Если хотя бы один токен из пула успешно выполняет запрос, его результат немедленно возвращается, и процесс завершается.

2.  **Уровень 2 (Резервный): Токен из `.env`**
    -   **Источник:** Переменная `VK_USER_TOKEN` из файла `.env` (или переменных окружения контейнера).
    -   **Логика:** Система переходит к этому уровню **только в том случае, если все токены** из пула системных аккаунтов не сработали, или если активных системных аккаунтов в базе данных нет.
    -   Выполняется последняя попытка с использованием этого "резервного" токена.

3.  **Полная неудача**
    -   Если и резервный токен не сработал, функция пробрасывает последнюю полученную от VK API ошибку (`VkApiError`), и операция считается неуспешной.

### 2.2. Важное исключение: Токен Сообщества

**Категорически важно понимать**, что описанный выше механизм ротации **НЕ ПРИМЕНЯЕТСЯ** к **токену сообщества** (`communityToken`), который используется для **публикации новых постов** (`wall.post`).

-   **Почему?** Публикация нового поста от имени группы — это специфическая, привилегированная операция, которая часто требует именно ключа доступа самого сообщества.
-   **Где происходит логика:** Выбор токена для публикации происходит на более высоком уровне, в сервисе `post_actions_service.py`. Этот сервис явно выбирает `project.communityToken` для новых постов и передает его в `vk_service.call_vk_api`. В этом случае `vk_service` не выполняет ротацию, а работает с тем токеном, который ему передали.

Таким образом, система четко разделяет:
-   **Надежность чтения данных** (обеспечивается ротацией сервисных токенов).
-   **Специфику публикации** (обеспечивается изолированным использованием токена сообщества).

---

## 3. Ключевые высокоуровневые функции

### `upload_wall_photo(group_id, file_bytes, file_name, user_token)`
-   **Назначение:** Загрузить фото в альбом "Фото на стене".
-   **Процесс:**
    1.  Вызывает `photos.getWallUploadServer`.
    2.  Отправляет файл на полученный `upload_url`.
    3.  Вызывает `photos.saveWallPhoto` с результатами загрузки.
-   **Возвращает:** Финальный объект фото от VK API.

### `upload_market_photo(...)` / `upload_album_photo(...)`
-   **Назначение:** Аналогично `upload_wall_photo`, но для товаров и фотоальбомов соответственно. Используют другие методы VK API (`photos.getMarketUploadServer`, `photos.getUploadServer`).

### `get_all_photos_from_album(...)`
-   **Назначение:** Получить **все** фотографии из альбома, даже если их больше 1000.
-   **Логика:** Реализует пагинацию, автоматически делая несколько запросов к `photos.get` со смещением (`offset`), пока не будут загружены все фотографии.

---

## 4. Взаимодействие с низкоуровневым клиентом

Все функции в этом модуле для непосредственного вызова методов VK API используют универсальный клиент `_raw_call_vk_api` из пакета `vk_api`. Это гарантирует, что все запросы, даже внутри сложных многошаговых операций, получают преимущества надежности (повторные попытки) и централизованной обработки ошибок.