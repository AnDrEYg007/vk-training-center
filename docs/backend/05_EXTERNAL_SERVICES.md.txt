# 5. Взаимодействие с внешними сервисами

Этот документ описывает, как бэкенд общается с внешними API: VK API и Gemini API.

## 1. VK API (пакет `services/vk_api/` и сервис `services/vk_service.py`)

Вся логика для работы с API ВКонтакте организована в модульную структуру.

### 1.1. Пакет `services/vk_api/`

Этот пакет содержит реализацию взаимодействия с VK, разделенную по ответственности.

#### `api_client.py`
Низкоуровневый клиент. Содержит только базовую функцию `call_vk_api` (или `_raw_call_vk_api`), которая выполняет один HTTP-запрос с обработкой ошибок сети и `exponential backoff`. Она не знает о ротации токенов.

#### `token_manager.py`
Отвечает за управление токенами.
-   **`call_vk_api` (с ротацией)**: Обертка над клиентом. Сначала пробует выполнить запрос с токенами из пула системных аккаунтов. Если они не работают, использует токен из `.env`.
-   **`publish_with_fallback`**: Специализированная логика для публикации, где приоритет может отдаваться токену сообщества.

#### `upload.py`
Инкапсулирует сложную логику загрузки медиафайлов, которая всегда состоит из 3 шагов:
1.  Получение URL сервера загрузки (`photos.getWallUploadServer` и т.д.).
2.  POST-запрос с файлом.
3.  Сохранение результата (`photos.saveWallPhoto`).
Функции: `upload_wall_photo`, `upload_market_photo`, `upload_album_photo`.

#### `methods.py`
Содержит удобные обертки для часто используемых методов, скрывая детали параметров.
-   `create_album`, `get_albums`, `get_latest_wall_posts` и др.

#### `formatters.py` и `utils.py`
Преобразование данных и утилиты для работы с ID.

### 1.2. Фасад `services/vk_service.py`

Этот файл является **чистым хабом (Facade)**. Он не содержит реализации, а только импортирует функции из подмодулей `vk_api` и ре-экспортирует их.

**Зачем это нужно?**
Это обеспечивает **обратную совместимость**. Все остальные сервисы (`post_service`, `market_service`) импортируют `vk_service` и вызывают функции как раньше (`vk_service.call_vk_api`), не зная о том, что внутри логика разнесена по разным файлам.

---

## 2. Gemini API (`services/gemini_service.py`)

Этот модуль отвечает за все взаимодействия с Google Gemini API.

*(Без изменений: см. описание generate_text и поддержки прокси в оригинальной документации)*