# 8. Руководство и План Тестирования: Системные Публикации

Этот документ является строгим регламентом, описывающим все аспекты работы с **Системными Публикациями** в приложении. Его цель — зафиксировать текущее, протестированное и одобренное поведение, а также предоставить исчерпывающий план тестирования для будущих доработок или рефакторинга.

## Оглавление
1. [Общая концепция](#1-общая-концепция)
2. [Визуальное представление](#2-визуальное-представление-postcardtsx)
3. [Логика пользовательских взаимодействий (UX)](#3-логика-пользовательских-взаимодействий-ux)
4. [Циклические публикации и "Призраки"](#4-циклические-публикации-и-призраки)
5. [План регрессионного тестирования](#5-план-регрессионного-тестирования)
6. [Схема взаимодействия и поток данных](#6-схема-взаимодействия-и-поток-данных)
7. [Интеграция с базой данных](#7-интеграция-с-базой-данных)
8. [Связанные компоненты и сервисы системы](#8-связанные-компоненты-и-сервисы-системы)

---

## 1. Общая концепция

**Системная Публикация** — это пост, который создается и хранится исключительно в базе данных бэкенда (`vk_planner.db`), а не в отложенной очереди VK. Специальный серверный процесс ("Пост-трекер") отвечает за автоматическую публикацию этих постов в назначенное время и верификацию их успешного выхода.

-   **Источник правды**: Таблица `system_posts` в базе данных бэкенда.
-   **Поведение по умолчанию**: При создании нового поста он по умолчанию становится Системной Публикацией.
-   **Основное назначение**:
    1.  Обеспечение **надежной и предсказуемой** отложенной публикации, независимой от очередей VK.
    2.  Предоставление пользователю **прозрачной обратной связи** о статусе публикации на всех этапах.
    3.  Предоставление инструментов для управления "проблемными" публикациями.
    4.  Реализация сложной логики **цикличности** (повторяющихся постов), которую не поддерживает VK API.

---

## 2. Визуальное представление (`PostCard.tsx`)

Карточка системной публикации в календаре (`ScheduleGrid`) должна иметь следующие отличительные черты:

-   **Основной стиль**: Контейнер карточки имеет **пунктирную рамку** (`border-dashed`), что визуально отличает его от постов в отложке VK (сплошная рамка) и опубликованных (приглушенный вид).
-   **Индикатор цикличности**: Если пост является циклическим, в правом верхнем углу (поверх рамки) отображается иконка "закругленных стрелок" на синем фоне.

-   **Индикаторы статуса**: В левом верхнем углу отображается иконка, соответствующая текущему статусу поста:

| Статус | Иконка | Цвет рамки | Описание |
| :--- | :---: | :--- | :--- |
| `pending_publication` | 🕒 | Серая | Ожидает публикации. |
| `publishing` | ⚙️ (аним.) | Синяя | Публикуется или проверяется. |
| `possible_error` | ⚠️ | Желтая | Возможная ошибка (не найден на стене). |
| `error` | ❌ | Красная | Ошибка при публикации. |

---

## 3. Логика пользовательских взаимодействий (UX)

### 3.1. Создание

-   **Действие**: Нажать кнопку "+" в колонке дня или выбрать "Копировать" на любом посте.
-   **Результат**: Открывается модальное окно `PostDetailsModal`.
-   **Требования**:
    1.  По умолчанию выбран способ публикации "Запланировать".
    2.  Доступен переключатель **"Циклическая публикация (авто-повтор)"**.
    3.  После сохранения пост появляется в календаре с пунктирной рамкой и статусом `pending_publication`.

### 3.2. Редактирование

-   **Действие**: Нажатие на иконку "карандаш" на карточке поста.
-   **Результат**: `PostDetailsModal` открывается в режиме `edit`.
-   **Ключевые бизнес-правила**:
    1.  **Блокировка при публикации**: Если пост имеет статус `publishing`, редактирование заблокировано.
    2.  **Редактирование цикла**: Для системных постов можно изменять настройки цикличности (интервал, тип, условия окончания) даже после создания.

### 3.3. Удаление

-   **Действие**: Нажатие на иконку "корзина".
-   **Требования**:
    1.  Удаление **запрещено** для постов со статусом `publishing`.
    2.  При удалении циклического поста удаляется **текущая итерация**. Будущие "призрачные" посты исчезают, так как они проецировались от удаленного родителя. Если пост уже создал следующую реальную копию (которая теперь стала самостоятельной), она не удаляется.

### 3.4. Копирование и Drag-and-Drop

-   **Стандартное поведение**: Копирование создает новый независимый пост.
-   **Особое поведение для статуса `publishing`**: При перетаскивании поста в статусе `publishing` (или `published`), автоматически создается копия, так как исходный пост изменять нельзя.
-   **"Призрачные посты" (Ghost Posts)**: В календаре могут отображаться полупрозрачные карточки будущих повторений.
    -   **Drag-and-Drop призраков**: Заблокирован, так как они еще не существуют физически.
    -   **Клик по призраку**: Открывает на редактирование **исходный родительский пост**, от которого проецируется этот призрак.

---

## 4. Циклические публикации и "Призраки"

Это уникальная функция системных постов, позволяющая настроить автоматический перевыпуск контента.

### 4.1. Настройка цикла (`PostCreationOptions`)
При создании системного поста доступен блок настроек:
1.  **Тип повторения**: Минуты, Часы, Дни, Недели, Месяцы.
2.  **Интервал**: Числовое значение (например, каждые 3 дня).
3.  **Сложная логика месяцев**:
    -   При выборе "Месяцы" можно зафиксировать день: "Каждое 15 число" или "В последний день месяца".
    -   **Автоматическая валидация**: Если выбрано 31 число (или 29/30 для февраля), система принудительно переключает на опцию "В последний день месяца" или предупреждает пользователя для корректной работы в коротких месяцах.
4.  **Условия окончания**:
    -   "Никогда (бесконечно)".
    -   "После N повторений" (счетчик уменьшается с каждой итерацией).
    -   "После даты" (цикл останавливается, если следующая дата выходит за предел).

### 4.2. Механика "Регенерации" (Бэкенд)
Цикличность реализована не через Cron, а через **цепную реакцию** в Пост-трекере (`post_tracker_service`):
1.  Когда текущий пост успешно опубликован и **верифицирован** на стене VK (найден по ID или контенту).
2.  Пост-трекер вычисляет дату следующей публикации на основе настроек (`recurrence_*`).
3.  Проверяются лимиты (оставшееся количество повторов или конечная дата).
4.  Если лимиты позволяют, создается **новая запись** в таблице `system_posts` со статусом `pending_publication`, датой в будущем и теми же настройками цикла (но с уменьшенным счетчиком `recurrence_end_count`).
5.  Старый (опубликованный) пост удаляется из `system_posts`.

### 4.3. Визуализация "Призраков" (Client-Side Projection)
Чтобы пользователь видел планы на будущее, фронтенд (`ScheduleGrid`) самостоятельно рассчитывает и отображает "призрачные" посты.
-   **Что это**: Виртуальные карточки, которые показывают, где появятся следующие посты, если настройки цикла не изменятся. Они не существуют в базе данных.
-   **Вид**: Полупрозрачные (`opacity-60`), с серым фоном, без кнопок действий.
-   **Расчет**: Происходит "на лету" в браузере (`useMemo` в `ScheduleGrid`). Алгоритм берет каждый активный циклический пост и проецирует его копии вперед во времени в пределах видимой области календаря.
-   **Взаимодействие**: При клике на "призрака" открывается модальное окно редактирования **исходного (родительского)** поста. При сохранении родительского поста все "призраки" пересчитываются мгновенно.

---

## 5. План регрессионного тестирования

### ✔️ Цикличность

-   [ ] **Тест 5.1 (Создание)**: Создайте системный пост с повторением "Каждый день", конец "После 3 повторений".
-   [ ] **Ожидаемый результат**: В календаре появился основной пост. На следующие дни появились полупрозрачные "призраки".
-   [ ] **Тест 5.2 (Взаимодействие)**: Кликните на "призрака". Должно открыться окно редактирования **исходного** поста. Измените текст исходного поста. Призраки должны исчезнуть и появиться снова (пересчитаться).
-   [ ] **Тест 5.3 (Публикация и регенерация)**: (Требует доступа к БД или ускорения времени). Когда пост публикуется и верифицируется, на месте первого "призрака" должен появиться реальный системный пост (с пунктирной рамкой, `pending_publication`), а цепочка призраков сдвигается.

### ✔️ Drag-and-Drop

-   [ ] **Тест 4.1**: Перетащите пост `pending_publication` на другой день. Открывается `ConfirmMoveModal`.
-   [ ] **Тест 4.2**: Попробуйте перетащить "призрака".
-   [ ] **Ожидаемый результат**: Перетаскивание невозможно (карточка не реагирует).

---

## 6. Схема взаимодействия и поток данных

### 6.1. Создание системного поста

1.  **[Frontend]** `PostDetailsModal`: Пользователь нажимает "Сохранить", `publicationMethod` равен `'system'`.
2.  **[Frontend]** `api.savePost` отправляет запрос на `/api/savePost` с `scheduleInVk: false`.
3.  **[Backend]** `post_actions_service.save_post`: Выбирает ветку `_save_as_system_post`.
4.  **[Backend]** `crud.create_or_update_system_post`: Создает новую запись в таблице `system_posts`.
5.  **[Frontend]** `onSaveComplete` вызывает `handleSystemPostUpdate`, который обновляет состояние `allSystemPosts`.

### 6.2. Жизненный цикл (Пост-трекер)

1.  **Публикация**:
    -   **[Backend]** `post_tracker_service._publication_check` находит пост (`status='pending_publication'`, `date` наступило).
    -   **[Backend]** Обновляет `status` на `publishing`.
    -   **[Backend]** Вызывает `post_actions_service.publish_now` -> `vk_service.call_vk_api('wall.post')`.
    -   **[Backend]** Если успешно, сохраняет `vk_post_id` в запись. Если ошибка — меняет `status` на `error`.
2.  **Верификация и Регенерация**:
    -   **[Backend]** `post_tracker_service._verification_check` находит пост (`status='publishing'`).
    -   **[Backend]** Вызывает `vk_service.get_latest_wall_posts`.
    -   **[Backend]** Сравнивает `vk_post_id` (или контент) с полученными постами.
    -   **[Backend]** Если совпадение найдено:
        -   Проверяет флаг `is_cyclic`.
        -   Если `true`, рассчитывает следующую дату (`_calculate_next_occurrence`) и создает новую запись в `system_posts` (следующую итерацию).
        -   Вызывает `crud.delete_system_post` для текущего (опубликованного) поста.
    -   **[Backend]** Если прошло > 5 минут без совпадения, меняет `status` на `possible_error`.
    -   **[Backend]** В любом случае вызывает `update_tracker.add_updated_project`.
3.  **Обновление UI**:
    -   **[Frontend]** `useUpdatePolling` получает `updatedProjectIds`.
    -   **[Frontend]** `App.tsx` вызывает `syncDataForProject`.
    -   **[Frontend]** `handleSystemPostUpdate` обновляет `allSystemPosts`, и UI (статус, иконка) перерисовывается.

---

## 7. Интеграция с базой данных

-   **Таблица:** `system_posts`
-   **Модель SQLAlchemy:** `SystemPost` в `models.py`
-   **Назначение:** Основной источник правды для запланированных внутри системы публикаций.

### 7.1. Структура таблицы `system_posts`

| Поле | Тип SQL | Описание |
| :--- | :--- | :--- |
| `id` | `String` | **Первичный ключ.** Уникальный идентификатор (UUID). |
| `project_id` | `String` | Внешний ключ, связывающий с `projects`. |
| `publication_date`| `String` | Дата и время публикации в формате ISO. |
| `text` | `Text` | Текст поста. |
| `images` | `Text` | JSON-строка с массивом `PhotoAttachment`. |
| `attachments` | `Text` | JSON-строка с массивом `Attachment`. |
| `status` | `String` | `pending_publication`, `publishing`, `error`, `possible_error`. |
| `post_type` | `String` | Тип публикации (пока только `'regular'`). |
| `created_at` | `DateTime`| Время создания записи. |
| `last_checked_at`| `DateTime`| Время последней проверки Пост-трекером. |
| `vk_post_id` | `String` | ID поста в VK после успешной публикации. |
| `is_cyclic` | `Boolean` | Флаг цикличности. |
| `recurrence_type` | `String` | 'days', 'weeks', 'months' и т.д. |
| `recurrence_interval` | `Integer` | Шаг цикла. |
| `recurrence_end_type` | `String` | 'infinite', 'count', 'date'. |
| `recurrence_end_count` | `Integer` | Оставшееся количество повторений. |
| `recurrence_end_date` | `String` | Дата окончания цикла. |

### 7.2. Ключевые CRUD-функции (`crud/system_post_crud.py`)

-   `create_or_update_system_post`: Создает или обновляет запись.
-   `delete_system_post`: Удаляет запись.
-   `get_system_post_by_id`: Находит запись по ID.
-   `get_system_posts_for_project_ids`: Получает все системные посты для списка проектов.

---

## 8. Связанные компоненты и сервисы системы

### 8.1. Фронтенд

-   **`features/posts/components/PostCard.tsx`**: Отображение карточки, индикаторов статуса, иконки цикличности.
-   **`features/posts/components/modals/PostCreationOptions.tsx`**: UI настройки цикличности (интервалы, типы, окончания).
-   **`features/posts/hooks/usePostForm.ts`**: Управление состоянием формы, включая новые поля `recurrence_*`.
-   **`features/schedule/components/ScheduleGrid.tsx`**: Логика `postsWithGhosts` для генерации призрачных постов на клиенте.
-   **`features/schedule/hooks/useScheduleData.ts`**: Объединение системных постов с остальными.

### 8.2. Бэкенд

-   **`services/post_tracker_service.py`**: Сердце цикличности. Функции `_calculate_next_occurrence`, `_add_months` и логика регенерации поста внутри `_verification_check`.
-   **`services/post_actions/save_system.py`**: Сохранение настроек цикличности в БД.
-   **`models.py`**: Расширенная модель `SystemPost` с полями для рекуррентности.