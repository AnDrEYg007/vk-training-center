# 7. Руководство и План Тестирования: Опубликованные Посты

Этот документ является строгим регламентом, описывающим все аспекты работы с **опубликованными постами** в приложении. Его цель — зафиксировать текущее, протестированное и одобренное поведение, а также предоставить исчерпывающий план тестирования для будущих доработок или рефакторинга.

## Оглавление
1. [Общая концепция](#1-общая-концепция)
2. [Визуальное представление](#2-визуальное-представление-postcardtsx)
3. [Логика пользовательских взаимодействий (UX)](#3-логика-пользовательских-взаимодействий-ux)
4. [План регрессионного тестирования](#4-план-регрессионного-тестирования)
5. [Схема взаимодействия и поток данных](#5-схема-взаимодействия-и-поток-данных)
6. [Интеграция с базой данных](#6-интеграция-с-базой-данных)
7. [Связанные компоненты и сервисы системы](#7-связанные-компоненты-и-сервисы-системы)

---

## 1. Общая концепция

**Опубликованный пост** — это запись, которая уже размещена на стене сообщества ВКонтакте. В контексте приложения, это пост, чья дата публикации (`date`) находится в прошлом.

-   **Источник правды**: Стена сообщества в VK.
-   **Хранение в приложении**: Данные об опубликованных постах хранятся в таблице `posts` в базе данных бэкенда. Эта таблица является **кешем**.
-   **Основное назначение в интерфейсе**:
    1.  Предоставление исторического обзора контента в календаре.
    2.  Возможность **редактирования** контента поста уже после публикации.
    3.  Использование в качестве **шаблона** для создания новых постов путем копирования.

---

## 2. Визуальное представление (`PostCard.tsx`)

Карточка опубликованного поста в календаре (`ScheduleGrid`) должна иметь следующие отличительные черты:

-   **Иконка статуса**: В левом верхнем углу отображается зеленая иконка "галочка в круге", однозначно идентифицирующая пост как опубликованный.
-   **Визуальное приглушение**: На карточку наложен легкий полупрозрачный градиент, который делает ее менее яркой по сравнению с активными (запланированными) постами. Это смещает фокус пользователя на будущие публикации.
-   **Отсутствие кнопки "Опубликовать сейчас"**: Так как пост уже опубликован, кнопка с иконкой "бумажного самолетика" **не должна** отображаться в панели действий.
-   **Остальные действия**: Все остальные кнопки действий (просмотр, редактирование, копирование, удаление, переход по ссылке) должны быть доступны при наведении курсора.

---

## 3. Логика пользовательских взаимодействий (UX)

### 3.1. Просмотр

-   **Действие**: Клик на карточку поста.
-   **Результат**: Открывается модальное окно `PostDetailsModal` в режиме **`view`** (просмотр).
-   **Требования к `PostDetailsModal` (view mode)**:
    -   Все поля (текст, изображения, вложения) отображаются в статическом виде, без возможности редактирования.
    -   Кнопка "Опубликовать сейчас" в футере **отсутствует**.
    -   Доступна кнопка "Редактировать", которая переключает модальное окно в режим `edit`.

### 3.2. Редактирование

-   **Действие**: Нажатие на иконку "карандаш" на карточке поста или на кнопку "Редактировать" в модальном окне просмотра.
-   **Результат**: `PostDetailsModal` переходит в режим **`edit`**.
-   **Ключевые бизнес-правила и требования**:
    1.  **Дата и время публикации НЕИЗМЕННЫ**: Поля для выбора даты и времени должны быть **заблокированы (`disabled`)**. Нельзя изменить дату уже опубликованного поста.
    2.  **Контент редактируем**: Поля для текста, изображений и вложений должны быть доступны для редактирования.
    3.  **Сохранение**:
        -   При нажатии на кнопку "Сохранить изменения" фронтенд отправляет запрос на бэкенд для вызова метода `wall.edit` в VK API.
        -   После успешного сохранения модальное окно `PostDetailsModal` **должно автоматически закрыться**.
        -   Сразу после закрытия окна должен быть инициирован процесс обновления **только опубликованных постов** (`handleRefreshPublished`), чтобы в календаре отобразились актуальные данные.

### 3.3. Копирование

#### Способ 1: Нажатие кнопки "Копировать"

-   **Действие**: Нажатие на иконку "копировать" на карточке поста.
-   **Результат**: Открывается модальное окно `PostDetailsModal` в режиме **`copy`**.
-   **Ключевые бизнес-правила и требования**:
    1.  **Создание новой сущности**: Режим `copy` функционально эквивалентен созданию нового поста, но с предзаполненными полями.
    2.  **Сброс даты**: Дата и время должны быть автоматически сброшены на будущую дату (например, завтра в 10:00). Все поля даты и времени должны быть **редактируемы**.
    3.  **Все поля редактируемы**: Текст, изображения и вложения должны быть полностью доступны для изменения.
    4.  **Сохранение**: Логика сохранения идентична созданию нового поста (по умолчанию создается "Системная Публикация").

#### Способ 2: Перетаскивание (Drag-and-Drop)

-   **Действие**: Пользователь "захватывает" карточку опубликованного поста и перетаскивает ее на любую будущую дату в календаре.
-   **Результат**: Это действие также инициирует процесс **копирования**. Модальное окно `ConfirmMoveModal` **не должно появляться**. Вместо этого сразу открывается `PostDetailsModal` в режиме **`copy`**.
-   **Требования**:
    -   Дата в модальном окне должна соответствовать той дате, на которую пользователь "бросил" карточку. Время должно быть унаследовано от исходного поста.

### 3.4. Удаление

-   **Действие**: Нажатие на иконку "корзина" на карточке поста.
-   **Результат**: Открывается модальное окно `DeleteConfirmationModal`.
-   **Требования**:
    1.  После подтверждения пользователем, фронтенд вызывает эндпоинт `deletePublishedPost`.
    2.  Бэкенд выполняет `wall.delete` в VK API и удаляет запись из своего кеша (`posts`). Бэкенд должен корректно обрабатывать ситуацию, когда пост уже был удален в VK вручную.
    3.  После успешного ответа от бэкенда, фронтенд должен инициировать обновление **только опубликованных постов** (`handleRefreshPublished`), чтобы пост исчез из календаря.

### 3.5. Переход по ссылке

-   **Действие**: Нажатие на иконку "внешняя ссылка" на карточке поста.
-   **Результат**: В новой вкладке браузера должна открыться страница этого поста на стене ВКонтакте.
-   **Требования**: Ссылка (`vkPostUrl`) должна быть корректной и вести на сам пост, а не на ленту новостей или главную страницу сообщества.

---

## 4. План регрессионного тестирования

Этот чек-лист должен быть полностью пройден при любых изменениях, затрагивающих `PostCard`, `PostDetailsModal`, `usePostDetails`, `ScheduleTab`, `useScheduleInteraction` или соответствующие API-эндпоинты.

### ✔️ Визуальное представление

-   [ ] **Тест 1.1**: Найдите в календаре опубликованный пост. Убедитесь, что в левом верхнем углу есть **зеленая иконка-галочка**.
-   [ ] **Тест 1.2**: Убедитесь, что карточка опубликованного поста выглядит **слегка приглушенной** по сравнению с запланированными постами.
-   [ ] **Тест 1.3**: Наведите курсор на карточку. Убедитесь, что кнопка **"Опубликовать сейчас" (бумажный самолетик) отсутствует**.
-   [ ] **Тест 1.4**: Убедитесь, что при наведении появляются все остальные кнопки: Редактировать, Копировать, Удалить, Внешняя ссылка.

### ✔️ Редактирование

-   [ ] **Тест 2.1**: Нажмите на иконку "Редактировать". Убедитесь, что открылось модальное окно `PostDetailsModal` в режиме редактирования.
-   [ ] **Тест 2.2**: В открывшемся окне убедитесь, что поля для выбора **даты и времени заблокированы (`disabled`)** и их нельзя изменить.
-   [ ] **Тест 2.3**: Измените текст поста и/или добавьте/удалите изображение.
-   [ ] **Тест 2.4**: Нажмите "Сохранить изменения".
-   [ ] **Ожидаемый результат**:
    -   [ ] Модальное окно **закрывается**.
    -   [ ] В календаре отображаются обновленные данные (например, новый текст).
    -   [ ] Перейдите на стену в VK и убедитесь, что пост действительно отредактирован.

### ✔️ Копирование

-   [ ] **Тест 3.1 (Через кнопку)**: Нажмите на иконку "Копировать" на карточке опубликованного поста.
-   [ ] **Ожидаемый результат**:
    -   [ ] Открывается `PostDetailsModal` с заголовком "Копирование поста".
    -   [ ] Все поля (текст, изображения) заполнены данными из исходного поста.
    -   [ ] Поля **даты и времени доступны для редактирования** и установлены на будущую дату.
-   [ ] **Тест 3.2**: Измените дату и сохраните пост. Убедитесь, что в календаре на новой дате появился новый пост (скорее всего, системный, с пунктирной рамкой).

-   [ ] **Тест 3.3 (Через Drag-and-Drop)**: Перетащите карточку опубликованного поста на любой будущий день в календаре.
-   [ ] **Ожидаемый результат**:
    -   [ ] Открывается `PostDetailsModal` в режиме копирования.
    -   [ ] Дата в модальном окне **соответствует дню, на который вы перетащили карточку**.
    -   [ ] Сохраните пост и убедитесь, что он появился в правильном месте.

### ✔️ Удаление

-   [ ] **Тест 4.1**: Нажмите на иконку "Удалить" на карточке опубликованного поста.
-   [ ] **Тест 4.2**: В появившемся окне подтверждения нажмите "Удалить".
-   [ ] **Ожидаемый результат**:
    -   [ ] Пост **исчезает** из календаря в приложении.
    -   [ ] Перейдите на стену в VK и убедитесь, что пост **удален**.

### ✔️ Внешняя ссылка

-   [ ] **Тест 5.1**: Нажмите на иконку "Внешняя ссылка" на карточке.
-   [ ] **Ожидаемый результат**: Открывается новая вкладка браузера, ведущая на **конкретную страницу этого поста** в VK. Убедитесь, что это не ссылка на `vk.com/feed` или главную страницу группы.

---

## 5. Схема взаимодействия и поток данных

Этот раздел описывает пошаговый процесс обработки ключевых операций с опубликованными постами.

### 5.1. Загрузка и обновление списка постов

1.  **[Frontend]** Пользователь открывает вкладку расписания или нажимает "Обновить опубликованные". Вызывается `handleRefreshPublished(projectId)`.
2.  **[Frontend]** `services/api.ts` отправляет `POST` запрос на эндпоинт `/api/refreshPublishedPosts`.
3.  **[Backend]** `routers/posts.py` принимает запрос и вызывает сервис `post_retrieval_service.refresh_published_posts`.
4.  **[Backend]** Сервис использует **стандартную ротацию токенов**, чтобы вызвать `wall.get` и получить ~100 последних постов со стены VK.
5.  **[Backend]** Полученные "сырые" данные фильтруются (дедупликация), форматируются в `ScheduledPost` schema, им присваиваются теги.
6.  **[Backend]** `crud/post_crud.py` с помощью функции `replace_published_posts` полностью заменяет старый кеш в таблице `posts` для данного проекта на новые данные.
7.  **[Backend]** Эндпоинт возвращает фронтенду свежий список постов.
8.  **[Frontend]** `ProjectsContext` обновляет свое состояние `allPosts`, что вызывает перерисовку календаря.

### 5.2. Редактирование опубликованного поста

1.  **[Frontend]** Пользователь в `PostDetailsModal` нажимает "Сохранить изменения".
2.  **[Frontend]** Вызывается `api.savePost` с флагом `isNewPost: false`.
3.  **[Backend]** Эндпоинт `/api/savePost` (`post_actions_service.save_post`) видит, что это не новый пост, и вызывает `save_to_vk_schedule` (который обрабатывает `wall.edit`).
4.  **[Backend]** Используется `publish_with_fallback` с методом `wall.edit`. Система перебирает все доступные токены, чтобы найти тот, который имеет права на редактирование этого поста.
5.  **[Backend]** После успешного ответа от VK, бэкенд обновляет запись для этого поста в своем кеше.
6.  **[Frontend]** Получает успешный ответ. `PostDetailsModal` закрывается.

### 5.3. Удаление опубликованного поста

1.  **[Frontend]** Пользователь подтверждает удаление. Вызывается `api.deletePublishedPost`.
2.  **[Backend]** Эндпоинт `/api/deletePublishedPost` вызывает `vk_service.call_vk_api('wall.delete', ...)`.
3.  **[Backend]** Вне зависимости от ответа VK (даже если пост уже был удален), бэкенд вызывает `crud.delete_post_from_cache`, чтобы удалить пост из своей БД.
4.  **[Frontend]** Получает успешный ответ и инициирует `handleRefreshPublished`, чтобы пост исчез из календаря.

---

## 6. Интеграция с базой данных

Вся информация об опубликованных постах на стороне бэкенда хранится в одной таблице в базе данных `vk_planner.db`.

-   **Таблица:** `posts`
-   **Модель SQLAlchemy:** `Post` в `models.py`
-   **Назначение:** **Кеш**. Эта таблица не является источником правды, а лишь хранит локальную копию данных, полученных из VK API, для быстрой загрузки интерфейса.

### 6.1. Структура таблицы `posts`

| Поле | Тип SQL | Описание |
| :--- | :--- | :--- |
| `id` | `String` | **Первичный ключ.** Уникальный идентификатор поста в формате `ownerId_postId` (например, `-12345_6789`). |
| `projectId` | `String` | Внешний ключ, связывающий пост с проектом в таблице `projects`. |
| `date` | `String` | Дата публикации в формате ISO. |
| `text` | `Text` | Полный текст поста. |
| `images` | `Text` | JSON-строка, содержащая массив объектов `PhotoAttachment` (`{id: "...", url: "..."}`). |
| `attachments` | `Text` | JSON-строка, содержащая массив других вложений (видео, опросы и т.д.). |
| `vkPostUrl` | `String` | Прямая ссылка на пост на стене VK. |
| `_lastUpdated`| `String` | Временная метка последнего обновления этой записи из VK. |

### 6.2. Ключевые CRUD-функции (`crud/post_crud.py`)

-   **`get_posts_by_project_id(db, project_id)`**:
    -   **Назначение:** Получить все опубликованные посты для одного проекта из кеша.
    -   **SQL:** `SELECT * FROM posts WHERE projectId = :project_id;`

-   **`replace_published_posts(db, project_id, posts, timestamp)`**:
    -   **Назначение:** Атомарно обновить кеш.
    -   **SQL:**
        1.  `DELETE FROM posts WHERE projectId = :project_id;`
        2.  `INSERT INTO posts (...) VALUES (...);` (для каждого нового поста)

-   **`delete_post_from_cache(db, post_id, is_published=True)`**:
    -   **Назначение:** Удалить один конкретный пост из кеша.
    -   **SQL:** `DELETE FROM posts WHERE id = :post_id;`

-   **`upsert_post(db, post_data, is_published=True, project_id)`**:
    -   **Назначение:** "Умное" обновление или вставка одного поста. Используется, например, при обработке колбэков от VK.
    -   **SQL:**
        1.  `SELECT * FROM posts WHERE id = :post_id;`
        2.  Если найдено: `UPDATE posts SET ... WHERE id = :post_id;`
        3.  Если не найдено: `INSERT INTO posts (...) VALUES (...);`

---

## 7. Связанные компоненты и сервисы системы

Этот раздел перечисляет все ключевые файлы в кодовой базе, которые реализуют или затрагивают логику работы с опубликованными постами. Он служит картой для разработчиков при внесении изменений.

### 7.1. Фронтенд

-   **`features/posts/components/PostCard.tsx`**
    -   **Роль:** Визуальное представление. Отвечает за рендеринг карточки опубликованного поста, включая иконку-галочку, "приглушенный" вид и отсутствие кнопки "Опубликовать сейчас".

-   **`features/posts/components/modals/PostDetailsModal.tsx`**
    -   **Роль:** Просмотр и редактирование. Основное модальное окно, которое открывается в режимах `view`, `edit` и `copy`.

-   **`features/posts/hooks/usePostDetails.ts`**
    -   **Роль:** Логика модального окна. Хук, который инкапсулирует всю логику `PostDetailsModal`, включая блокировку полей даты/времени для опубликованных постов и управление режимами.

-   **`features/schedule/hooks/useScheduleData.ts`**
    -   **Роль:** Управление данными календаря. Определяет, является ли пост опубликованным (сравнивая его дату с текущей), и содержит логику для `handleDelete`, которая вызывает правильный API-метод.

-   **`features/schedule/hooks/useScheduleInteraction.ts`**
    -   **Роль:** Логика взаимодействий. Реализует логику Drag-and-Drop, в частности, инициирует **копирование** при перетаскивании опубликованного поста.

-   **`contexts/hooks/useDataRefreshers.ts` (внутри `ProjectsContext`)**
    -   **Роль:** Централизованное обновление данных. Содержит ключевую функцию `handleRefreshPublished`, которая запрашивает свежие данные с бэкенда и обновляет глобальное состояние `allPosts`.

-   **`services/api.ts`**
    -   **Роль:** Клиент API. Определяет функции `refreshPublishedPosts`, `deletePublishedPost` и `savePost` (используется для редактирования через `wall.edit`), которые напрямую вызывают эндпоинты бэкенда.

### 7.2. Бэкенд

-   **`routers/posts.py`**
    -   **Роль:** Маршрутизатор API. Определяет эндпоинты `/refreshPublishedPosts`, `/deletePublishedPost` и `/savePost`, которые принимают запросы от фронтенда.

-   **`services/post_retrieval_service.py`**
    -   **Роль:** Сервис получения данных. Содержит функцию `refresh_published_posts`, которая запрашивает посты со стены VK, форматирует их и заменяет кеш в БД.

-   **`services/post_actions_service.py`**
    -   **Роль:** Сервис действий. Содержит:
        -   `delete_published_post`: Логика удаления поста со стены VK и из кеша.
        -   `save_post`: Логика, которая при редактировании существующего поста (не нового) вызывает `wall.edit` в VK API.

-   **`crud/post_crud.py`**
    -   **Роль:** Слой доступа к данным. Содержит функции для прямого взаимодействия с таблицей `posts` в базе данных:
        -   `get_posts_by_project_id`: Получение постов из кеша.
        -   `replace_published_posts`: Полная замена кеша для проекта.
        -   `delete_post_from_cache`: Удаление одного поста из кеша.
        -   `upsert_post`: Обновление или вставка одного поста (используется колбэками).

-   **`models.py`**
    -   **Роль:** Схема БД. Определяет модель `Post` и, соответственно, структуру таблицы `posts`, где хранятся кешированные опубликованные посты.