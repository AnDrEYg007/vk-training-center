# Инструкция по развертыванию бэкенда в Yandex.Cloud

Этот документ описывает полный пошаговый процесс сборки и развертывания бэкенд-приложения в Yandex Cloud Containers с использованием `batch`-скрипта для Windows.

## 1. Общая концепция

Процесс состоит из двух основных этапов:
1.  **Автоматизированный (скрипт)**: Локально создается новый Docker-образ с последними изменениями кода, тегируется и загружается в Yandex Container Registry.
2.  **Ручной (консоль Yandex.Cloud)**: Создается новая версия (ревизия) контейнера, которая использует только что загруженный образ.

---

## 2. Предварительные требования

1.  **Docker Desktop**: Установлен и запущен.
2.  **Yandex Cloud CLI (`yc`)**: Установлен и настроен.
3.  **Доступ к Yandex.Cloud**: Вы вошли в свой аккаунт `yc`.

---

## 3. Скрипт для автоматической сборки и загрузки

Этот скрипт автоматизирует все шаги от сборки до загрузки образа в реестр.

### Как использовать:
1.  Создайте на рабочем столе или в удобном месте файл с расширением `.bat` (например, `deploy_backend_preprod.bat`).
2.  Скопируйте в него приведенный ниже код.
3.  **Перед каждым запуском** отредактируйте файл и измените **только одну переменную**: `TAG`. Увеличьте номер версии (например, с `v15` на `v16`).
4.  Сохраните и запустите файл.

### Код скрипта (`deploy_backend_preprod.bat`)

```batch
@echo off
chcp 65001 > nul

:: ===================================================================
::  СКРИПТ ДЛЯ СБОРКИ И ЗАГРУЗКИ DOCKER-ОБРАЗА БЭКЕНДА В YANDEX.CLOUD
:: ===================================================================

:: === 1. ПЕРЕМЕННЫЕ (отредактируйте перед запуском) ===
set PROJECT_PATH="C:\Users\nikita79882\Desktop\Планировщик контента версии кода\11.11.2025\backend_python"
set REGISTRY_ID=crpq5n1men523nvih5j4
set IMAGE_NAME=vk-planner-backend
set TAG=v15

:: === 2. ПЕРЕЙТИ В ПАПКУ ПРОЕКТА ===
echo.
echo [Шаг 2/7] Переход в рабочую директорию...
cd /d %PROJECT_PATH%
if %errorlevel% neq 0 (
    echo ОШИБКА: Не удалось найти путь %PROJECT_PATH%
    pause
    exit /b
)
echo Путь: %CD%

:: === 3. СОЗДАТЬ ОБРАЗ ===
echo.
echo [Шаг 3/7] Сборка Docker-образа...
docker build -t %IMAGE_NAME%-preprod .
if %errorlevel% neq 0 (
    echo ОШИБКА: Сборка Docker-образа не удалась.
    pause
    exit /b
)

:: === 4. АВТОРИЗОВАТЬ DOCKER (если еще не делал) ===
echo.
echo [Шаг 4/7] Авторизация в Yandex Container Registry...
yc container registry configure-docker
if %errorlevel% neq 0 (
    echo ОШИБКА: Авторизация Docker не удалась. Убедитесь, что yc CLI настроен.
    pause
    exit /b
)

:: === 5. ПРОСТАВИТЬ ТЕГ ===
echo.
echo [Шаг 5/7] Присвоение тега образу...
docker tag %IMAGE_NAME%-preprod cr.yandex/%REGISTRY_ID%/%IMAGE_NAME%:%TAG%
if %errorlevel% neq 0 (
    echo ОШИБКА: Не удалось присвоить тег.
    pause
    exit /b
)

:: === 6. ЗАЛИТЬ В РЕЕСТР ЯНДЕКСА ===
echo.
echo [Шаг 6/7] Загрузка образа в Yandex Container Registry...
docker push cr.yandex/%REGISTRY_ID%/%IMAGE_NAME%:%TAG%
if %errorlevel% neq 0 (
    echo ОШИБКА: Не удалось загрузить образ в реестр.
    pause
    exit /b
)

:: === 7. ПРОВЕРИТЬ АКТИВНЫЕ РЕВИЗИИ ===
echo.
echo [Шаг 7/7] Получение списка последних ревизий контейнера...
yc serverless container revision list --container-name %IMAGE_NAME%-preprod --limit 3

echo.
echo ===================================================================
echo.
echo  ✅ Образ успешно собран и загружен:
echo     cr.yandex/%REGISTRY_ID%/%IMAGE_NAME%:%TAG%
echo.
echo  ➡️ Теперь открой Yandex Cloud -> Serverless Containers -> %IMAGE_NAME%-preprod
echo     и вручную создай новую ревизию, указав тег: %TAG%
echo.
echo ===================================================================
pause
```

---

## 4. Объяснение команд скрипта

-   **`set PROJECT_PATH="..."`**: Указывает полный путь к папке `backend_python` на вашем компьютере.
-   **`set TAG=v15`**: **Самая важная переменная.** Устанавливает уникальный тег версии для вашего Docker-образа.
-   **`cd /d %PROJECT_PATH%`**: Переходит в папку с кодом бэкенда.
-   **`docker build ...`**: Собирает Docker-образ на основе `Dockerfile` в текущей папке.
-   **`yc container registry configure-docker`**: Авторизует Docker для работы с вашим реестром в Yandex.Cloud.
-   **`docker tag ...`**: Присваивает образу полное имя, необходимое для загрузки в реестр Yandex.Cloud.
-   **`docker push ...`**: Загружает ваш локальный образ в облачный реестр.
-   **`yc serverless container revision list ...`**: Показывает последние 3 ревизии контейнера для информации.

---

## 5. Завершающий ручной шаг

После успешного выполнения скрипта необходимо:

1.  Откройте в браузере [консоль Yandex.Cloud](https://console.cloud.yandex.ru/) -> **Cloud Containers**.
2.  Найдите и выберите ваш контейнер (например, `vk-planner-backend-preprod`).
3.  Нажмите **"Создать ревизию"**.
4.  В настройках новой ревизии:
    -   **Образ Docker**: Выберите образ с вашим **новым тегом** (например, `:v15`).
    -   **Переменные окружения**: Убедитесь, что все переменные (`PORT`, `DATABASE_URL` и т.д.) скопированы из предыдущей ревизии.
5.  Нажмите **"Создать ревизию"** и дождитесь статуса "Running".
