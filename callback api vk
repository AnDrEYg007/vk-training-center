События в реальном времени
API ВКонтакте позволяет работать с событиями пользователя или сообщества в реальном времени. Это нужно для отображения нового сообщения, для моментальной реакции на комментарий в сообществе, для создания чат-ботов или для анализа текстовых данных.

Для сообществ
Для работы с событиями сообществ мы предлагаем два разных подхода:

•
Callback API — в этом случае мы будем отправлять уведомление на ваш сервер о каждом новом событии.
•
Bots Long Poll API — очередь из событий хранится на стороне ВКонтакте, вы получаете их, используя Long Polling запросы.
Callback API и Bots Long Poll API поддерживают события, связанные с сообщениями сообщества, активностью пользователей на стене и в остальных разделах вашей группы или публичной страницы. Полный список событий в сообществах вы можете найти на этой странице.

Для пользователей
User Long Poll API нужен для работы с событиями пользователя в вашем приложении. Очередь из событий хранится на стороне ВКонтакте, вы получаете их, используя Long Polling запросы.

User Long Poll API поддерживает все события, связанные с личными сообщениями (получение, редактирование, удаление), изменение статуса онлайн или счётчиков в меню.

События в сообществах
Событие представляет собой JSON, имеющий следующую структуру:

JSON
{
  "type": "<тип события>",
  "object": "<объект, инициировавший событие>",
  "group_id": "<идентификатор сообщества, в котором произошло событие>"
}

Например:

JSON
{
  "type": "group_join",
  "object": {
    "user_id": 1,
    "join_type": "approved"
  },
  "group_id": 1
}

Структура объекта в поле object зависит от типа уведомления. Ниже перечислены все типы уведомлений и соответствующие им объекты, которые поддерживаются в Callback API и Bots Long Poll API.

Сообщения
message_new
Входящее сообщение.

Формат поля object:

•
Для версий API ниже 5.103: личное сообщение.
•
Для версий API 5.103 и выше: объект, содержащий следующие поля:
Поле
Тип
Описание
message
Message
Данные о сообщении, которое написал пользователь.
client_info
ClientInfo
Информация о функциях, доступных пользователю.
message_reply
Новое исходящее сообщение.

Формат поля object: личное сообщение.

message_edit
Редактирование сообщения.

Формат поля object: личное сообщение.

Событие о редактировании отправляется только для сообщений бота.

message_allow
Подписка на сообщения от сообщества. Пользователь нажал кнопку Разрешить сообщения или написал первое сообщение сообществу.

Формат поля object:

Поле
Тип
Описание
user_id
integer
Идентификатор пользователя.
key
string
Параметр, переданный в методе messages.allowMessagesFromGroup.
message_deny
Новый запрет сообщений от сообщества. Пользователь нажал на кнопку Запретить сообщения.

Формат поля object:

Поле
Тип
Описание
user_id
integer
Идентификатор пользователя.
message_typing_state
Статус набора текста. Пользователь печатает сообщение в диалоге или загружает аудиосообщение.

Формат поля object:

Поле
Тип
Описание
state
string
Состояние статуса набора текста.
from_id
integer
Идентификатор пользователя, который набирает текст.
to_id
integer
Идентификатор сообщества, которому пользователь пишет сообщение.
message_read
Информация о том, что сообщение прочитано.

Формат поля object:

Поле
Тип
Описание
from_id
integer
Идентификатор пользователя или сообщества, прочитавшего сообщение.
peer_id
integer
Идентификатор пользователя или сообщества, отправившего сообщение.
read_message_id
integer
Идентификатор прочитанного сообщения.
conversation_message_id
integer
Уникальный автоматически увеличивающийся номер для всех сообщений с этим peer.
message_event
Действие с сообщением. Пользователь нажал на Callback-кнопку

Формат поля object:

Поле
Тип
Описание
user_id
integer
Идентификатор пользователя.
peer_id
integer
Идентификатор диалога со стороны бота.
event_id
string
Случайная строка. Активна в течение минуты, спустя минуту становится недействительной.
payload
any
Дополнительная информация, указанная в клавише.
conversation_message_id
integer?
Идентификатор сообщения в беседе. Не передаётся для клавиатур беседы.
Фотографии
photo_new
Добавление фотографии.

Формат поля object: объект фотографии.

photo_comment_new
Добавление комментария к фотографии.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
photo_id
integer
Идентификатор фотографии.
photo_owner_id
integer
Идентификатор владельца фотографии.
photo_comment_edit
Редактирование комментария к фотографии.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
photo_id
integer
Идентификатор фотографии.
photo_owner_id
integer
Идентификатор владельца фотографии.
photo_comment_restore
Восстановление комментария к фотографии.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
photo_id
integer
Идентификатор фотографии.
photo_owner_id
integer
Идентификатор владельца фотографии.
photo_comment_delete
Удаление комментария к фотографии.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
photo_id
integer
Идентификатор фотографии.
photo_owner_id
integer
Идентификатор владельца фотографии.
Аудиозаписи
audio_new
Добавление аудио.

Формат поля object: объект аудиозаписи.

Видеозаписи
video_new
Добавление видео.

Формат поля object: объект видеозаписи.

video_comment_new
Комментарий к видео.

video_comment_edit
Редактирование комментария к видео.

video_comment_restore
Восстановление комментария к видео.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
video_id
integer
Идентификатор видеозаписи.
video_owner_id
integer
Идентификатор владельца видеозаписи.
video_comment_delete
Удаление комментария к видео

Формат поля object:

Поле
Тип
Описание
owner_id
integer
Идентификатор владельца видео.
id
integer
Идентификатор комментария.
user_id
integer
Идентификатор автора комментария.
deleter_id
integer
Идентификатор пользователя, который удалил комментарий.
video_id
integer
Идентификатор видео.
Записи на стене
wall_post_new
Запись на стене.

wall_repost
Репост записи из сообщества.

Формат поля object: объект записи на стене с дополнительными полями:

Поле
Тип
Описание
postponed_id
integer
Идентификатор отложенной записи.
Для записей, размещённых от имени пользователя, from_id > 0.

wall_schedule_post_new
Добавление отложенной записи.

Формат поля object:

Поле
Тип
Описание
schedule_time
integer
Дата и время, в которые будет опубликована запись, в формате Unix Timestamp.
id
integer
Идентификатор отложенной записи.
wall_schedule_post_delete
Удаление отложенной записи.

Формат поля object:

Поле
Тип
Описание
schedule_time
integer
Дата и время, в которые будет опубликована запись, в формате Unix Timestamp.
id
integer
Идентификатор отложенной записи.
Комментарии на стене
wall_reply_new
Добавление комментария на стене.

wall_reply_edit
Редактирование комментария на стене.

wall_reply_restore
Восстановление комментария на стене.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
post_id
integer
Идентификатор записи.
post_owner_id
integer
Идентификатор владельца записи.
wall_reply_delete
Удаление комментария на стене.

Формат поля object:

Поле
Тип
Описание
owner_id
integer
Идентификатор владельца стены.
id
integer
Идентификатор комментария.
deleter_id
integer
Идентификатор пользователя, который удалил комментарий.
post_id
integer
Идентификатор записи, к которой был оставлен комментарий.
Отметки Мне нравится
like_add
Событие о новой отметке Мне нравится.

Формат поля object:

Поле
Тип
Описание
liker_id
integer
Идентификатор пользователя, который поставил отметку.
object_type
string
Тип материала.
object_owner_id
integer
Идентификатор владельца материала.
object_id
integer
Идентификатор материала.
thread_reply_id
integer
Идентификатор родительского комментария или записи.
post_id
integer
Идентификатор записи (возвращается для комментария, оставленного под записью).
Возможные значения object_type:
•
post — запись на стене.
•
video — видеозапись.
•
photo — фотография.
•
comment — комментарий.
•
note — заметка.
•
topic_comment — комментарий в обсуждении.
•
photo_comment — комментарий к фотографии.
•
video_comment — комментарий к видеозаписи.
•
market — товар.
•
market_comment — комментарий к товару.
like_remove
Событие о снятии отметки Мне нравится.

Формат поля object:

Поле
Тип
Описание
liker_id
integer
Идентификатор пользователя, который снял отметку.
object_type
string
Тип материала.
object_owner_id
integer
Идентификатор владельца материала.
object_id
integer
Идентификатор материала.
thread_reply_id
integer
Идентификатор родительского комментария или записи.
post_id
integer
Идентификатор записи (возвращается для комментария, оставленного под записью).
Обсуждения
board_post_new
Создание комментария в обсуждении.

board_post_edit
Редактирование комментария.

board_post_restore
Восстановление комментария.

Формат поля object: объект комментария в обсуждении с дополнительными полями:

Поле
Тип
Описание
topic_id
integer
Идентификатор обсуждения.
topic_owner_id
integer
Идентификатор владельца обсуждения.
board_post_delete
Удаление комментария в обсуждении.

Формат поля object:

Поле
Тип
Описание
topic_id
integer
Идентификатор обсуждения.
topic_owner_id
integer
Идентификатор владельца обсуждения.
id
integer
Идентификатор комментария.
Товары
market_comment_new
Новый комментарий к товару.

market_comment_edit
Редактирование комментария к товару.

market_comment_restore
Восстановление комментария к товару.

Формат поля object: объект комментария на стене с дополнительными полями:

Поле
Тип
Описание
market_owner_id
integer
Идентификатор владельца товара.
item_id
integer
Идентификатор товара.
market_comment_delete
Удаление комментария к товару.

Формат поля object:

Поле
Тип
Описание
owner_id
integer
Идентификатор владельца товара.
id
integer
Идентификатор комментария.
user_id
integer
Идентификатор автора комментария.
deleter_id
integer
Идентификатор пользователя, который удалил комментарий.
item_id
integer
Идентификатор товара.
market_order_new
Новый заказ. Чтобы включить событие, в настройках сообщества необходимо включить расширенные товары.

Формат поля object: заказ.

market_order_edit
Редактирование заказа. Чтобы включить событие, в настройках сообщества необходимо включить расширенные товары.

Формат поля object: заказ.

Пользователи
group_leave
Удаление участника из сообщества.

Формат поля object:

Поле
Тип
Описание
user_id
integer
Идентификатор пользователя.
self
0 или 1
Значение, указывающее, был пользователь удален или вышел самостоятельно.
group_join
Добавление участника или заявки на вступление в сообщество.

Формат поля object

Поле
Тип
Описание
user_id
integer
Идентификатор пользователя.
join_type
string
Указывает, как именно был добавлен участник.
Возможные значения join_type:
•
join — пользователь вступил в группу или мероприятие (подписался на публичную страницу).
•
unsure — для мероприятий: пользователь выбрал вариант «Возможно, пойду».
•
accepted — пользователь принял приглашение в группу или на мероприятие.
•
approved — заявка на вступление в группу/мероприятие была одобрена руководителем сообщества.
•
request — пользователь подал заявку на вступление в сообщество.
user_block
Добавление пользователя в чёрный список.

Формат поля object

Поле
Тип
Описание
admin_id
integer
Идентификатор администратора, который внёс пользователя в чёрный список.
user_id
integer
Идентификатор пользователя.
unblock_date
integer
Дата разблокировки.
reason
integer
Причина блокировки. Возможные значения: 0 — другое (по умолчанию). 1 — спам. 2 — оскорбление участников. 3 — нецензурные выражения. 4 — сообщения не по теме.
comment
string
Комментарий администратора к блокировке.
user_unblock
Удаление пользователя из чёрного списка.

Формат поля object

Поле
Тип
Описание
admin_id
integer
Идентификатор администратора, который убрал пользователя из чёрного списка.
user_id
integer
Идентификатор пользователя.
by_end_date
integer
Дата разблокировки.
Прочее
poll_vote_new
Добавление голоса в публичном опросе.

Формат поля object

Поле
Тип
Описание
owner_id
integer
Идентификатор владельца опроса.
poll_id
integer
Идентификатор опроса.
option_id
integer
Идентификатор варианта ответа.
user_id
integer
Идентификатор пользователя.
group_officers_edit
Редактирование списка руководителей.

Формат поля object:

Поле
Тип
Описание
admin_id
integer
Идентификатор руководителя, который внёс изменения.
user_id
integer
Идентификатор пользователя, чьи полномочия были изменены.
level_old
integer
Старый уровень полномочий.
level_new
integer
Новый уровень полномочий.
Поля level_old и level_new могут принимать значения:

•
0 — нет полномочий.
•
1 — модератор.
•
2 — редактор.
•
3 — администратор.
group_change_settings
Изменение настроек сообщества.

Формат поля object:

•
user_id — идентификатор пользователя, который внёс изменения.
•
changes — описание внесённых изменений. Объект, который содержит следующие поля:
•
{FIELD} — название секции или раздела, который был изменён. {FIELD} может принимать значения:
•
title — название.
•
description — описание.
•
access — тип группы.
•
screen_name — короткий адрес.
•
public_category — категория публичной страницы.
•
public_subcategory — подкатегория публичной страницы.
•
age_limits — возрастные ограничения.
•
website — веб-сайт.
•
enable_{SECTION} — изменение настроек доступа к разделу. {SECTION} может принимать значения: status_default, audio, photo, video, market.
•
old_value — старое значение.
•
new_value — новое значение.
group_change_photo
Изменение главного фото.

Формат поля object:

•
user_id — идентификатор пользователя, который внёс изменения.
•
photo — объект, описывающий фотографию.
vkpay_transaction
Платёж через VK Pay.

Формат поля object

•
from_id — идентификатор пользователя-отправителя перевода.
•
amount — сумма перевода в тысячных рубля.
•
description — комментарий к переводу.
•
date — время отправки перевода в Unixtime.
app_payload
Событие из VK Mini Apps добавленного в сообщество.

Формат поля object:

•
user_id — идентификатор пользователя, по действию которого в приложении отправлено событие.
•
app_id — идентификатор приложения, из которого было отправлено событие.
•
payload — переданные полезные данные.
•
group_id — идентификатор сообщества, в которое отправлено уведомление.
Платные подписки VK Donut
donut_subscription_create
Создание подписки VK Donut.

Формат поля object:

•
amount (integer) — сумма в рублях.
•
amount_without_fee (float) — сумма без комиссии (в рублях).
•
user_id (integer) — идентификатор пользователя.
donut_subscription_prolonged
Продление подписки.

Формат поля object:

•
amount (integer) — сумма в рублях.
•
amount_without_fee (float) — сумма без комиссии (в рублях).
•
user_id (integer) — идентификатор пользователя.
donut_subscription_expired
Подписка истекла.

Формат поля object: user_id (integer) — идентификатор пользователя.

donut_subscription_cancelled
Отмена подписки.

Формат поля object: user_id (integer) — идентификатор пользователя.

donut_subscription_price_changed
Изменение стоимости подписки.

Формат поля object:

•
amount_old (integer) — старая цена в рублях.
•
amount_new (integer) — новая цена в рублях.
•
amount_diff (float) — сумма доплаты в рублях.
•
amount_diff_without_fee (float) — сумма доплаты без комиссии (в рублях).
•
user_id (integer) — идентификатор пользователя.
donut_money_withdraw
Вывод денег.

Формат поля object:

•
amount (float) — сумма в рублях.
•
amount_without_fee (float) — сумма без комиссии (в рублях).
donut_money_withdraw_error
Ошибка вывода денег.

Формат поля object: reason (string) — причина ошибки.
Сообщения сообществ
Сообщения сообществ — сервис для прямого диалога между пользователем и сообществом ВКонтакте.



Это удобно для ваших клиентов. Не нужно искать форму обратной связи, проходить регистрацию, отвечать через email — никаких лишних действий.

Это удобно для вас. Вместе с сообщением вы получаете все необходимые данные о его авторе, можете автоматически обрабатывать типовые заявки и мгновенно отвечать на сообщения с помощью бота.

Миллионы пользователей предпочитают общаться с друзьями, близкими и деловыми партнерами именно ВКонтакте. Используя сервис сообщений, вы можете стать ближе к клиентам и поддерживать тесную связь с ними в привычном для них окружении.

Сообщения сообществ работают в полной и мобильной версиях ВКонтакте, а также во всех официальных приложениях: с вашей компанией можно связаться на любой платформе.



Подробнее обо всех преимуществах для бизнеса мы рассказали на отдельной странице.

API для сообщений сообществ
В этом руководстве рассказывается о том, как использовать API для работы с сообщениями сообществ.

Ключ доступа
Для работы с API от имени сообщества необходимо получить специальный ключ доступа. Вы можете сделать это двумя способами — в интерфейсе управления сообществом или программно, с помощью специального запроса к нашему серверу.

Ключ доступа — это строка, включающая латинские буквы и цифры. Ее необходимо передавать в параметре access_token, обращаясь к методам API от имени сообщества.

Получение ключа доступа в настройках сообщества
1.
Откройте vk.com и перейдите в сообщество, в котором вы являетесь администратором.

2.
В меню справа выберите Управление и затем Дополнительно → Работа с API.

3.
Нажмите Создать ключ. Отметьте необходимые права доступа и подтвердите свой выбор.

Вы можете создать несколько ключей с разными правами доступа. Ключи нельзя размещать публично — узнав его, третье лицо может обращаться к API ВКонтакте от имени вашего сообщества. Если ключ был скомпрометирован, необходимо удалить его из списка — после этого он станет недействителен.

Получение ключа доступа на oauth.vk.ru
Мы предлагаем два способа авторизации, основанных на протоколе OAuth 2.0. Используйте этот подход, если необходимо работать со многими сообществами пользователя, например, при разработке мобильного приложения.

Для работы с API с серверной стороны используйте Authorization Code Flow.

Для работы с API со стороны клиента используйте Implicit Flow.

Работа с сообщениями
В API сообщений сообществ используются те же методы, что и для работы с личными сообщениями пользователя. Если раньше вы уже имели дело с сообщениями в API ВКонтакте, схема работы будет вам знакома. Стоит, однако, учитывать некоторые особенности:

•
необходимо проставлять статус прочитанности сообщения при общении с клиентом;
•
если ответ получен пользователем, его необходимо помечать как прочитанный;
•
в диалогах сообществ доступны специальные метки: Важные, Неотвеченные, Непрочитанные.
Чтобы вы могли отправлять пользователю сообщения от имени сообщества, пользователь должен разрешить их получение. Если пользователь написал сообщение сообществу первым, это приравнивается к согласию на получение ответных сообщений (без ограничений по времени, если пользователь не запретил сообщения вручную). Чтобы запросить у пользователя разрешение на отправку сообщений, используйте:

•
Событие VKWebAppAllowMessagesFromGroup библиотеки VK Bridge.
•
Метод messages.allowMessagesFromGroup в Standalone-приложениях.
•
Виджет Разрешить писать сообществу на внешнем сайте.
В Callback API и Bots Longpoll API события message_allow и message_deny помогут отслеживать факт разрешения и запрета сообщений от сообщества. Обратите внимание, получить список всех пользователей, разрешивших сообщения сообществу, через API нельзя, необходимо хранить и синхронизировать этот список на своей стороне.

Доступные инструменты и методы
•
Long Poll сервер — синхронизация обновлений;
•
Callback API — мгновенные оповещения о новых сообщениях и других действиях пользователей в сообществе.
•
messages.getDialogs — метод для получения списка диалогов;
•
messages.markAsRead — метод для присвоения сообщению метки Прочитано;
•
messages.markAsImportantConversation, messages.markAsAnsweredConversation — методы для присвоения меток диалогам;
•
messages.send — метод для отправки нового сообщения;
•
messages.delete, messages.deleteConversation, messages.restore — методы для удаления и восстановления сообщений и диалогов;
•
messages.search — метод для поиска по сообщениям;
•
messages.allowMessagesFromGroup, messages.denyMessagesFromGroup — методы для подписки на сообщения сообщества и запрета на получение сообщений;
•
docs.getWallUploadServer, docs.save, , — методы для загрузки фотографий и документов.
•
groups.getCallbackConfirmationCode, groups.getCallbackServerSettings, groups.getCallbackSettings, groups.setCallbackSettings — методы для работы с настройками Callback API.
Получение списка диалогов
Метод messages.getDialogs.

Параметр start_message_id используется для защиты от смещения из-за новых сообщений при подгрузке старых диалогов. При первом вызове не передавайте start_message_id, запомните значение id у сообщения в первом диалоге и используйте его в качестве start_message_id в последующих вызовах при подгрузке диалогов.

https://api.vk.ru/method/messages.getDialogs?v=5.41&access_token=ACCESS_TOKEN&count=10&offset=0
Получение новых диалогов
Метод messages.getDialogs.

Передавайте в start_message_id значение id сообщения в первом диалоге, в count максимальное количество новых диалогов, а в offset, соответственно, отрицательное значение.

https://api.vk.ru/method/messages.getDialogs?v=5.41&access_token=ACCESS_TOKEN&count=10&unread=1&offset=-10&start_message_id=64
Получение истории сообщений в диалоге
Метод messages.getHistory.

Чтобы получить историю конкретного диалога, используйте параметр peer_id. Параметр start_message_id используется для защиты от смещения из-за новых сообщений при подгрузке истории. При первом вызове не передавайте start_message_id, запомните значение id первого сообщения из ответа и используйте его в качестве start_message_id в последующих вызовах.

https://api.vk.ru/method/messages.getHistory?v=5.41&access_token=ACCESS_TOKEN&peer_id=494075&offset=0&count=10
https://api.vk.ru/method/messages.getHistory?v=5.41&access_token=ACCESS_TOKEN&peer_id=494075&offset=10&count=10&start_message_id=60
Получение новых сообщений с помощью Callback API
Callback API позволяет мгновенно получать информацию о новых сообщениях в адрес сообщества.

Для работы с Callback API вам потребуется серверный скрипт для обработки уведомлений. Настройте оповещения, следуя документации, среди типов событий выберите Получение нового сообщения (message_new).

ВКонтакте будет отправлять на ваш сервер оповещение о каждом новом сообщении с объектом личного сообщения в таком формате:

JSON
{
  "type": "message_new",
  "object": "..."
}

В уведомлении содержится исчерпывающая информация о сообщении — вы можете сразу ответить на него, используя метод messages.send.

Передача произвольного параметра с помощью ссылки vk.me
vk.me — это сервис коротких URL, который перенаправляет пользователей в указанный диалог. Ссылка имеет формат http://vk.me/{group_name}, где group_name — идентификатор сообщества. К примеру, vk.me/apiclub.

Вы можете не только создать красивую ссылку на диалог с сообществом, но и передать в такой ссылке произвольные параметры ref и ref_source, которые вернутся в объекте сообщения в событии message_new Callback API или Bots Long Poll API, в случае если пользователь начнет или продолжит беседу по ссылке вида vk.me.

Это полезно для отслеживания эффективности ссылок, размещенных в разных каналах, или привязки пользователя к сеансу или аккаунту во внешнем приложении. В зависимости от переданного параметра можно варьировать ответы бота в сообществе.

Ссылка vk.me с дополнительными параметрами выглядит следующим образом:

vk.me/{group_name}?ref={ref}&ref_source={ref_source}
Также сработает вот такая ссылка:

vk.com/write-{group_id}?ref={ref}&ref_source={ref_source}
Отправка изображений
Чтобы отправить изображение в сообщении, используйте параметр attachments в методе messages.send. Вы можете использовать изображение, которое уже есть на сайте ВКонтакте, либо загрузить новое.

Для загрузки фотографий и документов в сообщения сообщества используйте, соответственно, методы photos.getMessagesUploadServer и docs.getMessagesUploadServer. Это позволит загружать вложения для неограниченного числа собеседников.
Callback API
Callback API — это инструмент для отслеживания активности пользователей в вашем сообществе ВКонтакте. С его помощью вы можете реализовать, например:

•
Бота для отправки мгновенных ответов на поступающие сообщения.
•
Систему автоматической модерации контента.
•
Сервис для сбора и обработки показателей вовлечённости аудитории.
Чтобы начать использовать Callback API, подключите свой сервер в настройках сообщества и выберите типы событий, данные о которых требуется получать, например новые комментарии и новые фотографии.

Когда в сообществе произойдет событие выбранного типа, ВКонтакте отправит на ваш сервер запрос с данными в формате JSON с основной информацией об объекте, вызвавшем событие (например, добавленный комментарий).

В ответ на каждое уведомление о событии ваш сервер должен отправить строку ok.

Вам больше не нужно регулярно повторять запросы к API, чтобы отслеживать обновления — теперь вы будете получать их мгновенно.

Работа с Callback API
Подключение Callback API
1.
Откройте vk.com и перейдите в сообщество, в котором вы являетесь администратором.

2.
В меню справа выберите Управление и затем Дополнительно → Работа с API.

3.
Откройте вкладку Callback API.

Далее необходимо указать и подтвердить конечный адрес сервера, куда будут направлены все запросы. Вы можете подключить до 10 серверов для Callback API, задать каждому из них отдельный набор событий и версию API.

После указания адреса сервера и нажатия на кнопку подтвердить на указанный вами адрес отправится запрос с уведомлением типа confirmation. Ваш сервер должен вернуть заданную строку.



Обратите внимание: строка подтверждения меняется время от времени. Если вы добавляете новый сервер или редактируете настройки старого, то необходимо указать новую строку подтверждения. Получить строку подтверждения можно с помощью метода groups.getCallbackConfirmationCode. Также ее можно посмотреть в управлении сообществом.

Строку подтверждения, которую возвращает метод, можно использовать только для настройки сервера с помощью API. В настройках вашего сообщества на сайте ВКонтакте код будет отличаться.

После подтверждения адреса сервера вам станут доступны настройки уведомлений.

Во вкладке Запросы вы сможете видеть историю событий и содержимое запросов, отправленных на ваш сервер.

Обратите внимание: после получения уведомления ваш сервер должен возвращать строку ok и статус HTTP 200. Если сервер несколько раз подряд вернет ошибку, Callback API временно перестанет отправлять на него уведомления.

Добавлять, удалять и редактировать сервера для Callback API вы также можете с помощью методов секции groups.

Удаление сервера
Для удаления сервера вы можете отправить строку remove в ответ на уведомление о любом событии.

Версия API
В зависимости от указанной версии объекты в событиях будут иметь разный формат. Ознакомиться с отличиями версий можно на этой странице.

Секретный ключ
В поле Секретный ключ вы можете указать произвольную строку, которая будет передаваться в уведомлении на ваш сервер в поле secret.

SSL-сертификат
Чтобы гарантировать безопасность передачи данных, мы рекомендуем загрузить SSL-сертификат в настройках Callback API вашего сообщества.

Подробная информация о сертификате приведена ниже.

Настройка через API
Вы можете управлять настройками Callback API в вашем сообществе не только в веб-интерфейсе, но и с помощью методов API:

•
groups.addCallbackServer — добавляет сервер Callback API в сообщество;
•
groups.deleteCallbackServer — удаляет сервер Callback API;
•
groups.editCallbackServer — редактирует данные сервера Callback API;
•
groups.getCallbackConfirmationCode — получает код подтверждения для подключения сервера Callback API;
•
groups.getCallbackServers — получает список подключенных серверов в сообществе;
•
groups.getCallbackSettings — получает настройки событий для сервера Callback API;
•
groups.setCallbackSettings — устанавливает настройки событий для сервера Callback API.
Изменение версии API
Формат присылаемых данных может меняться в зависимости от версии API ВКонтакте. Если формат отличается от ожидаемого, то при обработке входящего сообщения может произойти ошибка.

Чтобы избежать ошибки, укажите ожидаемую версию API ВКонтакте, которую платформа будет использовать для обмена данными с вашим сервером. Указать версию API можно через пользовательский интерфейс ВКонтакте или с помощью методов API.

Через пользовательский интерфейс
1.
В вашем сообществе в меню справа выберите Управление, далее Дополнительно → Работа с API.

2.
Перейдите на вкладку Callback API и в разделе Настройки сервера выберите версию API.

Выбор версии API ВКонтакте
Выбор версии API ВКонтакте

Через API ВКонтакте
Воспользуйтесь одним из следующих способов:

•
Отправьте API-запрос groups.setCallbackSettings. Укажите желаемую версию API в параметре api_version этого запроса. Номер версии указывайте так, как он отображается в пользовательском интерфейсе в выпадающем списке на вкладке Callback API.

— либо —

•
Передайте желаемый номер версии API в ответ на любой запрос, который пришёл по каналу Сallback API. В ответе используйте строку вида:

version 5.131

Обратите внимание на пробел после слова version.

Номер версии указывайте так, как он отображается в пользовательском интерфейсе в выпадающем списке на вкладке Callback API.

Поддерживается версия 5.81 и более поздние.

HTTP-заголовки
X-Retry-Counter
Заголовок X-Retry-Counter возвращается, если предыдущая попытка отправки события потерпела неудачу (например, из-за того, что ваш сервер не отправил строку ok в ответ на уведомление о событии). Заголовок содержит информацию о количестве неудачных попыток. Промежутки времени, через которые событие будет отравлено повторно:

•
первое — через 10 секунд,
•
второе — через 3 минуты,
•
третье — через 10 минут,
•
четвёртое — через 30 минут,
•
пятое — через 1 час.
Retry-After
Вы можете отправить заголовок Retry-After вместе с HTTP-кодами 410, 429 или 503 и интервалом времени, через который надо будет повторить запрос. Время укажите в секундах или в формате HTTP-Date. Диапазон времени переотправки должен быть меньше 3 часов.

Обратите внимание! Фактическое время переотправки уведомления о событии может оказаться больше указанного.

Формат данных
Когда происходит событие, вы получаете данные в JSON, имеющем следующую структуру:

JSON
{
  "type": <тип события>,
  "event_id": <идентификатор события>,
  "v": <версия API, для которой сформировано событие>,
  "object": <объект, инициировавший событие>,
  "group_id": <ID сообщества, в котором произошло событие>
}

Например:

JSON
{
  "type": "group_join",
  "event_id": 12345,
  "v": "5.199",
  "object": {
    "user_id": 1,
    "join_type": "approved"
  },
  "group_id": 1
}

Типы событий
Структура объекта в поле object зависит от типа уведомления. Полный список событий вы найдёте на этой странице.

Пример использования
В нашем примере скрипт на PHP обрабатывает уведомления о новом сообщении и отправляет ответ его автору от имени сообщества.

PHP
<?php
if (!isset($_REQUEST)) {
return;
}

//Строка для подтверждения адреса сервера из настроек Callback API
$confirmation_token = 'd8v2ve07';

//Ключ доступа сообщества
$token = 'c0223f775444cf3d58a8a1442ec76a9571c8f58e3e24616d9440f73dc43022bbead9b2e576cb41d09c0a1';

//Получаем и декодируем уведомление
$data = json_decode(file_get_contents('php://input'));

//Проверяем, что находится в поле "type"
switch ($data->type) {
//Если это уведомление для подтверждения адреса...
case 'confirmation':
//...отправляем строку для подтверждения
echo $confirmation_token;
break;

//Если это уведомление о новом сообщении...
case 'message_new':
//...получаем id его автора
$user_id = $data->object->message->from_id;
//затем с помощью users.get получаем данные об авторе
$user_info = json_decode(file_get_contents("https://api.vk.ru/method/users.get?user_ids={$user_id}&access_token={$token}&v=5.103"));

//и извлекаем из ответа его имя
$user_name = $user_info->response[0]->first_name;

//С помощью messages.send отправляем ответное сообщение
$request_params = array(
'message' => "Hello, {$user_name}!",
'peer_id' => $user_id,
'access_token' => $token,
'v' => '5.103',
'random_id' => '0'
);

$get_params = http_build_query($request_params);

file_get_contents('https://api.vk.ru/method/messages.send?'. $get_params);

//Возвращаем "ok" серверу Callback API

echo('ok');

break; 

} 
?>
Поддержка в SDK
Вы можете работать с Callback API средствами наших SDK:

•
Java SDK,
•
PHP SDK.
Что такое SSL-сертификат
SSL — это протокол, позволяющий защитить запросы, которые принимает ваш сервер, от подмены, перехвата и модификации третьей стороной. Для работы SSL на сервере, который получает запрос, и на клиенте, который его отправляет, должны присутствовать специальные цифровые сертификаты — их наличие (и соответствие друг другу) позволяет установить защищенное (HTTPS) соединение.

Загрузив файл клиентского сертификата (в формате PKCS#12, вместе с закрытым ключом) в интерфейсе Callback API вашего сообщества и настроив свой сервер для работы с этим сертификатом, вы сможете быть уверены, что уведомление поступило именно от нашего сервиса — не имея ключа от сертификата, подделать такой запрос или перехватить его будет невозможно. Этот механизм называется аутентификацией по сертификату.

Мы рекомендуем прочитать эти статьи перед началом работы, если ранее вы не имели дела с аутентификацией в web, и пока не знаете, что такое SSL-сертификат:

•
Различные подходы к аутентификации в web

•
SSL сертификаты и их разновидности

Серверный сертификат должен быть выдан авторизованным центром сертификации — его валидность будет проверяться на стороне ВКонтакте. Клиентский сертификат для Callback API может быть самозаверенным, инструкцию по его созданию мы разместили для вас на этой странице. Вы можете использовать клиентский сертификат с любым уровнем валидации, с нашей стороны нет специфических требований к условиям его выдачи. Необходимо лишь, чтобы ваш сервер поддерживал работу с сертификатом выбранного типа и мог проверить его наличие и соответствие вашим настройкам доступа.

Для создания сертификата вам потребуется использовать OpenSSL. Установить эту программу можно по одной из ссылок с официального сайта. Мы настоятельно рекомендуем вам сгенерировать отдельный сертификат для Callback API и не использовать для этих целей сертификат, созданный для другого сервиса.

Создание клиентского самоподписанного сертификата в OpenSSL
Для создания сертификата введите такую команду:

Shell
openssl req -newkey rsa:2048 -sha256 -nodes -keyout vkapi.key -x509 -days 365 -out vkapi.crt -subj "/C=RU/ST=Saint Petersburg/L=Saint Petersburg/O=VK API Club/CN=vkapi"
В нашем примере использованы следующие параметры: req — означает запрос на создание нового сертификата; -newkey rsa:2048 — будет создан новый закрытый RSA-ключ длиной 2048 бита. Длину ключа вы можете настроить по своему усмотрению. -sha256 — используемый алгоритм хеширования (мы рекомендуем использовать именно это значение). -nodes — указывает, что закрытый ключ шифровать не нужно. -keyout vkapi.key — указывает, что закрытый ключ нужно сохранить в файле с именем vkapi.key. -x509 — указывает, что нужно создать самоподписанный сертификат. -days 365 — указывает период действия вашего сертификата (в данном случае — один год). -out vkapi.crt — указывает, что сертификат нужно сохранить в файле с именем vkapi.crt. -subj "/C=RU/ST=Saint Petersburg/L=Saint Petersburg/O=VK API Club/CN=vkapi" — данные вашего сертификата:

•
C — код страны (состоит из двух букв);
•
ST — регион;
•
L — город;
•
O — название организации;
•
CN — Common Name, имя сертификата (для клиентского сертификата может быть произвольным).
Вы можете использовать значения из subj для дополнительной идентификации сертификата, в этом параметре допустимы произвольные данные. Например, можно проверять на стороне сервера, что в CN передается именно та строка, что была задана вами (в нашем примере — vkapi).

После выполнения команды в каталоге OpenSSL появятся два файла — vkapi.key, содержащий закрытый ключ, и vkapi.crt, содержащий сертификат. Необходимо конвертировать их в формат .p12.

Экспорт в PKCS#12
Чтобы конвертировать сертификат в PKCS#12, используйте следующую команду:

openssl pkcs12 -export -in vkapi.crt -name "Test" -descert -inkey vkapi.key -out vkapi.p12
Параметры из нашего примера: pkcs12 — означает работу с файлами в PKCS#12; -export — запрос на экспорт сертификата; -in vkapi.crt — указывает на входной файл; -name "Test" — имя пользователя; -descert — шифрование сертификата в 3DES; -inkey vkapi.key — указывает имя файла, содержащего закрытый ключ; -out vkapi.p12 — указывает, что результат нужно сохранить в файле с именем vkapi.p12.

После выполнения команды в каталоге OpenSSL появится файл vkapi.p12. Именно его вам нужно загрузить ВКонтакте. Для этого откройте раздел Управление, далее Дополнительно → Работа с API, вкладка Callback API. Нажмите Выбрать файл и выберите файл на вашем компьютере.

Настройка сервера
Обратите внимание! На вашем сервере должен присутствовать корневой SSL сертификат, подписанный авторизованным центром сертификации. Самоподписанного корневого сертификата недостаточно для работы с Callback API. Получить сертификат можно, например, используя этот сайт: https://letsencrypt.org

Также вам нужно дополнительно настроить свой сервер, чтобы он умел проводить аутентификацию с использованием клиентского сертификата, который вы создали ранее.

В Nginx вам достаточно добавить следующие директивы:

Shell
ssl_client_certificate /path/vkapi.crt;

ssl_verify_client on;

ssl_verify_depth 0;

здесь: ssl_client_certificate — путь к файлу клиентского сертификата на вашем сервере; ssl_verify_client — проверять клиентский сертификат; ssl_verify_depth — глубина проверки цепочки клиентского сертификата.

Если ранее вам не доводилось иметь дела с настройкой клиентских сертификатов для своего сервера, мы рекомендуем к прочтению эти статьи: