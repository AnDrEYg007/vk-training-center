## Компонент: Модальные окна

Модальные окна используются для изоляции пользователя в рамках конкретной задачи, такой как редактирование, подтверждение или просмотр деталей.

### 1. Общая структура и поведение

-   **Оверлей**: Темный, полупрозрачный фон (`bg-black bg-opacity-50`), который блокирует взаимодействие с остальным интерфейсом.
-   **Контейнер**:
    -   Белый фон (`bg-white`), скругленные углы (`rounded-lg`), тень (`shadow-xl`).
    -   Появляется с плавной анимацией (`animate-fade-in-up`).
-   **Структура контейнера**:
    -   **Header**: Заголовок и кнопка "Закрыть" (крестик).
    -   **Body**: Основной контент (формы, текст). Имеет вертикальный скролл, если контент не помещается.
    -   **Footer**: Кнопки действий (Сохранить, Отмена, Удалить).
-   **Закрытие**: Окно закрывается по клику на оверлей, кнопку "Закрыть" или кнопку "Отмена".

### 2. Типы модальных окон

#### a. Окно подтверждения (ConfirmationModal)

-   **Назначение**: Получение подтверждения от пользователя на выполнение потенциально деструктивного действия (удаление, перезапись).
-   **Контент**: Краткий заголовок, поясняющий текст и две кнопки ("Да"/"Нет", "Удалить"/"Отмена").
-   **Примеры**: `DeleteConfirmationModal`, `ConfirmMoveModal`, `BulkDeleteConfirmationModal`.

##### Паттерн: ConfirmMoveModal

`ConfirmMoveModal` — это специализированное окно подтверждения для операции Drag-and-Drop в календаре.
-   **Контекст**: Появляется, когда пользователь перетаскивает пост или заметку на другой день.
-   **Ключевые особенности**:
    1.  **Информативность**: Четко указывает, *что* перемещается и *куда*.
    2.  **Редактирование времени**: Содержит поле для ввода времени.
    3.  **Опция "Копировать"**: Содержит переключатель, позволяющий вместо перемещения создать копию.
    4.  **Условный UI**: Если активирована опция "Копировать" для **поста**, появляется **сегментированный переключатель** ("В систему" / "В отложку VK") для выбора места сохранения копии.

#### b. Окно просмотра/редактирования (DetailsModal)

-   **Назначение**: Просмотр и редактирование сущностей (посты, заметки).
-   **Контент**: Сложная форма с множеством полей, контролов, возможно, с табами или аккордеонами.
-   **Примеры**: `PostDetailsModal`, `NoteModal`.

##### Паттерн: PostDetailsModal

`PostDetailsModal` является одним из самых сложных компонентов этого типа. Его ключевые особенности:
-   **Два режима**: `view` (просмотр) и `edit` (редактирование).
-   **Централизованная логика**: Вся логика управления состоянием модального окна инкапсулирована в хуке `usePostDetails`.
-   **Декомпозиция**: Компонент разбит на множество дочерних (`PostTextSection`, `PostMediaSection`), каждый из которых инкапсулирует свою логику.
    -   `PostMediaSection.tsx`: Управляет **всем медиа-контентом**, включая загрузку файлов, Drag-and-Drop и интеграцию с `ImageGallery`. Он информирует родителя о своем внутреннем состоянии (например, `isUploading`) через колбэк `onUploadStateChange`.
    -   `PostTextSection.tsx`: Управляет текстовым полем, AI-помощником и переменными. Теперь является "управляемым" компонентом, получая состояние видимости панелей через `props`.
        -   **Контекстные ответы в AI-чате:** Компонент AI-помощника (`AIGenerator`) поддерживает функцию ответа на предыдущие сообщения. Двойной клик по сообщению AI активирует режим ответа, добавляя в поле ввода цитату. Клик по этой цитате плавно прокручивает историю чата к исходному сообщению, подсвечивая его.
        -   **Быстрые действия с результатом:** При наведении на сообщение AI в чате появляются кнопки-иконки для быстрых действий:
            -   **Копировать:** Копирует текст ответа в буфер обмена.
            -   **Добавить в пост:** Добавляет текст ответа в конец основного текста поста.
            -   **Сгенерировать заново:** Повторно отправляет исходный запрос с той же инструкцией, чтобы получить альтернативный вариант ответа.
-   **Контекстные действия**: Футер (`PostModalFooter.tsx`) динамически меняет набор и текст кнопок в зависимости от контекста (новый пост, копия, редактирование, режим публикации).
-   **Защита от потери данных:** Модальное окно запрашивает подтверждение закрытия, если в нем есть несохраненные изменения (`isDirty`) **или** если открыты панели "AI-помощник" или "Переменные".

##### Паттерн: Блокировка действий при фоновых операциях
Все основные кнопки действий в футере модального окна должны быть заблокированы (`disabled`) на время выполнения критических фоновых операций, инициированных дочерними компонентами (например, загрузка изображений).
-   **Пример**: Во время загрузки изображений в `PostMediaSection`, `PostDetailsModal` получает состояние `isUploading` и передает его в `PostModalFooter`, где кнопка "Сохранить" становится неактивной.
-   **Цель**: Предотвращение отправки неполных данных на сервер и предоставление пользователю четкой визуальной обратной связи.

##### Паттерн: Обработка изменяемых по высоте дочерних элементов
Компоненты внутри модального окна, которые могут изменять свою высоту (например, `textarea` с `resize` или динамически появляющиеся блоки), могут вызывать проблемы с макетом, "выталкивая" контент за пределы видимой области.
-   **Проблема**: В `PostDetailsModal` компонент `AIGenerator` содержит `textarea`, которую пользователь может растягивать по вертикали. Если родительский контейнер (`PostTextSection`) имеет ограниченную максимальную высоту (`max-h`), `textarea` при растягивании "упрется" в эту границу и начнет перекрывать нижестоящие элементы вместо того, чтобы их сдвигать.
-   **Решение**: Для родительского контейнера, содержащего такие элементы, необходимо задавать достаточно большую или неограниченную максимальную высоту (например, `max-h-screen`). Это позволяет ему свободно расширяться, корректно сдвигая остальной контент модального окна вниз.
-   **Пример**: В `features/posts/components/modals/PostTextSection.tsx` контейнеру, оборачивающему `AIGenerator`, задана высота `max-h-screen`.

#### c. Окно настроек (SettingsModal)

-   **Назначение**: Редактирование настроек (например, проекта).
-   **Контент**: Использует аккордеон для группировки настроек. Каждая секция содержит специализированные редакторы:
  - `VariablesEditor`: для локальных переменных проекта.
  - `TagsEditor`: для управления тегами.
  - `AiPromptPresetsEditor`: для шаблонов AI.
  - `GlobalVariablesEditor`: **(Улучшено)** теперь предоставляет полный функционал для управления глобальными переменными, позволяя не только задавать значения для проекта, но и создавать/редактировать определения переменных "на лету", не покидая окно настроек.
-   **Пример**: `ProjectSettingsModal`.

#### d. Окно предпросмотра изображений (ImagePreviewModal)

-   **Назначение**: Отображение одного изображения в полноэкранном режиме поверх **всего** остального интерфейса.
-   **Ключевая особенность (React Portal)**: Этот компонент использует `createPortal` для рендеринга своего содержимого напрямую в `document.body`. Это гарантирует, что он всегда будет отображаться поверх других модальных окон и их оверлеев.
-   **Поведение**:
    -   Закрывается по клику на темную область (оверлей) или на кнопку-крестик.
    -   Закрытие окна предпросмотра **не затрагивает** родительские модальные окна.
-   **Пример**: `shared/components/modals/ImagePreviewModal.tsx`.

#### e. Выпадающие меню и Popover'ы (Dropdowns & Popovers)

-   **Назначение:** Отображение контекстных меню или дополнительной информации, привязанной к конкретному элементу (триггеру).
-   **Ключевая особенность (React Portal):** Компоненты этого типа (`ActionsDropdown`, `ColorPickerDropdown`) **должны** использовать `createPortal` для рендеринга своего содержимого в `document.body`.
-   **Проблема, которую это решает:** Это позволяет избежать проблем с "контекстом наложения" (`stacking context`) и `overflow`, когда родительский контейнер (например, `PostCard` или другое модальное окно) "обрезает" выпадающее меню или заставляет его появляться под другими элементами.
-   **Поведение:**
    -   **Динамическое позиционирование:** Позиция меню вычисляется динамически относительно его кнопки-триггера.
    -   **Закрытие:** Меню закрывается по клику вне его области.
-   **Пример:** `features/posts/components/ActionsDropdown.tsx`.


---

### 3. Управление фокусом и клавиатурой (Accessibility)

Для обеспечения доступности все модальные окна **должны** следовать этим правилам:

1.  **Focus Trap (Ловушка фокуса)**:
    -   При открытии фокус должен автоматически перемещаться на первый интерактивный элемент.
    -   `Tab` должен циклически перемещать фокус **только** внутри модального окна.
    -   При закрытии фокус должен возвращаться на вызвавший элемент.

2.  **Закрытие по Escape**:
    -   Нажатие клавиши `Escape` должно закрывать активное модальное окно (при необходимости, с диалогом подтверждения).