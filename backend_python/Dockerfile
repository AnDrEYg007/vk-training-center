
# Шаг 1: Используем официальный, легковесный образ Python
# Обновлено до 3.11 для поддержки современных фич (например, Union Types X | Y)
FROM python:3.11-slim

# Шаг 2: Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# Шаг 3: Копируем файл с зависимостями и устанавливаем их
# Этот шаг выполняется отдельно, чтобы Docker мог кешировать этот слой,
# что ускорит последующие сборки, если зависимости не менялись.
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ШАГ 4: Копируем все остальные файлы приложения в рабочую директорию
# ВАЖНО: Копирование файла .env.txt было УДАЛЕНО.
# Секреты теперь должны передаваться как переменные окружения в среде выполнения (например, в Yandex Cloud Containers).
COPY . .

# Шаг 5: Сообщаем Docker, что наше приложение будет работать на порту, который предоставит облачная платформа
# Это поле больше информационное, основная логика в CMD.
EXPOSE 8000

# Шаг 6: Команда для запуска приложения при старте контейнера
# Используем Gunicorn как WSGI-сервер для запуска Uvicorn в продакшен-режиме.
# --bind 0.0.0.0:${PORT}: Ключевое изменение! Привязываемся к порту из переменной окружения PORT.
# --timeout 1200: Увеличено время ожидания воркера до 20 минут для тяжелых задач синхронизации.
# ВАЖНО: Команда обернута в `sh -c`, чтобы переменная ${PORT} корректно подставлялась.
CMD ["/bin/sh", "-c", "gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:${PORT} --timeout 1200"]
