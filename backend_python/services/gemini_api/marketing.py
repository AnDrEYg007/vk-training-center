
import json
from typing import List
from .client import generate_text

def generate_company_description(group_info: dict, existing_context_json: str, post_texts: List[str]) -> str:
    prompt = f"""
    Ты — профессиональный копирайтер и бренд-стратег. Твоя задача — составить поле "Описание компании" для контекста нейросети.
    Это описание будет использоваться другими AI для генерации постов, поэтому оно должно передавать СУТЬ бизнеса, его миссию и уникальность.

    ВХОДНЫЕ ДАННЫЕ:
    1. Данные из VK (Описание, Статус, Активность):
    ```json
    {json.dumps(group_info, indent=2, ensure_ascii=False)}
    ```
    2. Текущий контекст проекта (УЖЕ ЗАПОЛНЕННЫЕ ПОЛЯ):
    ```json
    {existing_context_json}
    ```
    3. Примеры текстов последних постов (для понимания духа компании):
    ```json
    {json.dumps(post_texts, indent=2, ensure_ascii=False)}
    ```

    ТВОЯ ЗАДАЧА:
    Сформируй текст "Описание компании".
    
    ГЛАВНОЕ ПРАВИЛО:
    Внимательно изучи "Текущий контекст проекта". Если там уже есть заполненное поле "Описание товаров и услуг" или подробный список товаров, **НЕ НУЖНО** дублировать эту информацию в описании компании.
    Вместо перечисления ассортимента (роллы, пицца, шины), сфокусируйся на:
    
    1. **Миссия:** Ради чего существует компания? Какой подход она исповедует? (например: "Мы делаем премиум доступным", "Скорость — наш приоритет").
    2. **Уникальность (УТП):** Чем она отличается от конкурентов на уровне сервиса или подхода?
    3. **История и Бэкграунд:** Если в данных есть информация о том, как давно они на рынке или какие у них достижения.
    4. **Атмосфера:** Какое настроение создает бренд?
    
    СТИЛЬ:
    - **Говори как с другом.** Используй простые слова и короткие предложения, всегда от 3-его лица.
    - **Без пафоса.** Запрещены слова: "шедевры", "вселенная вкуса", "проводник", "истинное наслаждение", "философия", "гастрономическое удовольствие".
    - **Факты.** Пиши о пользе: скорость, размер порций, свежесть. Не обещай эмоции, а описывай то, что их вызывает.
    - **Тон:** Честный, теплый, "по-людски".

    Верни ТОЛЬКО текст описания.
    """
    # Создание контекста - ANALYTICAL
    return generate_text(prompt, strategy='ANALYTICAL')

def generate_products_description(existing_context_json: str, albums: List[dict], items: List[dict]) -> str:
    # Ограничиваем количество товаров для промпта
    items_sample = items[:60]
    
    prompt = f"""
    Ты — аналитик данных. Твоя задача — составить сухую фактологическую справку о товарах и услугах компании.
    Этот текст будет использоваться как КОНТЕКСТ для другой нейросети, чтобы она знала, что продает компания.

    ВХОДНЫЕ ДАННЫЕ:
    1. Категории (Подборки):
    ```json
    {json.dumps(albums, indent=2, ensure_ascii=False)}
    ```
    2. Список товаров (выборка):
    ```json
    {json.dumps(items_sample, indent=2, ensure_ascii=False)}
    ```

    ТВОЯ ЗАДАЧА:
    Проанализируй список и верни структурированное описание ассортимента.

    СТРОГО ПРИДЕРЖИВАЙСЯ ЭТОГО ШАБЛОНА:
    Основные категории: [Перечислить главные группы товаров через запятую. Например: Роллы, Пицца, WOK]
    Ключевые особенности меню: [Что преобладает? Много ли сетов? Есть ли вегетарианское? Используются ли специфические ингредиенты (лосось, угорь, трюфель)?]
    Ценовой сегмент: [Проанализируй цены и напиши: Бюджетный / Средний / Премиум. Укажи примерный диапазон цен на основные блюда.]
    Дополнительно: [Напитки, десерты, закуски или сопутствующие товары, если есть]

    ЗАПРЕЩЕНО:
    - Использовать прилагательные оценки: "вкусный", "свежий", "аппетитный", "потрясающий".
    - Писать рекламный текст. Только факты.
    - Перечислять названия всех товаров подряд. Нужно обобщение.

    Верни только текст по шаблону.
    """
    # Создание контекста - ANALYTICAL
    return generate_text(prompt, strategy='ANALYTICAL')

def generate_brand_tone(existing_context_json: str, post_texts: List[str]) -> str:
    prompt = f"""
    Ты — бренд-стратег. Твоя задача — проанализировать тексты постов и кратко описать **Тональность бренда (Tone of Voice)**.
    Не пиши жестких инструкций, правил оформления, требований к структуре или использованию эмодзи. 
    Опиши только **характер** и **эмоциональную окраску** общения бренда со своей аудиторией.

    ВХОДНЫЕ ДАННЫЕ (Примеры постов):
    ```json
    {json.dumps(post_texts, indent=2, ensure_ascii=False)}
    ```

    ТВОЯ ЗАДАЧА:
    Сформулируй краткое описание тональности (2-3 предложения). Оно должно отвечать на вопросы:
    1. Какое настроение передает бренд? (Дружелюбное, заботливое, дерзкое, официальное, экспертное?)
    2. Как бренд обращается к подписчикам? (На "ты" или "вы", как к друзьям или клиентам?)
    3. Какой стиль речи? (Простой, сложный, с юмором, сухой?)

    Пример хорошего ответа:
    "Общение легкое, дружелюбное и энергичное, на 'ты'. Бренд ведет себя как хороший приятель, использует простой язык и умеренный юмор, создавая атмосферу уюта и доверия."

    Верни ТОЛЬКО описание тональности. Без вступлений и заголовков.
    """
    # Создание контекста - ANALYTICAL
    return generate_text(prompt, strategy='ANALYTICAL')
