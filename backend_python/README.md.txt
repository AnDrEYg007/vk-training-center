# Бэкенд на Python для VK Content Planner

Этот бэкенд является реализацией оригинальной логики из Google Apps Script с использованием современного стека Python: FastAPI, SQLAlchemy и SQLite/PostgreSQL.

## Технологии

- **FastAPI**: Высокопроизводительный веб-фреймворк для создания API.
- **SQLAlchemy**: ORM для взаимодействия с базой данных.
- **SQLite / PostgreSQL**: Поддержка двух СУБД для гибкой разработки и развертывания.
- **Pydantic**: Для валидации данных и управления настройками.
- **Uvicorn / Gunicorn**: ASGI-серверы для запуска FastAPI-приложения.

---

## 1. Подробная документация

**Вся подробная техническая документация по архитектуре, потокам данных, API и ключевым сервисам бэкенда теперь находится в папке `backend_python/docs/`.**

Рекомендуется начать знакомство с файла `backend_python/docs/DOCUMENTATION_MAP.md.txt`, который служит оглавлением для всей документации.

---

## 2. Первоначальная настройка (Локальная разработка)

### Шаг 1: Переименуйте файлы (ВАЖНО!)

Среда разработки сохраняет файлы Python с расширением `.py.txt`. Перед началом работы их нужно переименовать.

**В папке `backend_python` выполните одну из следующих команд (или переименуйте файлы вручную):**

```bash
# Для macOS / Linux (рекурсивно для всех папок)
find . -name "*.py.txt" -exec sh -c 'mv "$1" "${1%.txt}"' _ {} \;

# Для Windows в PowerShell (рекурсивно для всех папок)
Get-ChildItem -Recurse -Filter *.py.txt | ForEach-Object { Rename-Item -Path $_.FullName -NewName $_.Name.Replace(".py.txt", ".py") }
```
Также переименуйте `README.md.txt` в `README.md` и `Dockerfile.txt` в `Dockerfile`.

### Шаг 2: Установите Python

Убедитесь, что у вас установлен Python 3.8 или новее.

### Шаг 3: Создайте виртуальное окружение

В терминале, находясь в папке `backend_python`, выполните:

```bash
# Для macOS / Linux
python3 -m venv venv
source venv/bin/activate

# Для Windows
python -m venv venv
.\venv\Scripts\activate
```

### Шаг 4: Установите зависимости

Выполните команду для установки всех необходимых библиотек:

```bash
pip install -r requirements.txt
```

### Шаг 5: Настройте переменные окружения

1.  Создайте файл `.env` в папке `backend_python`, скопировав содержимое из `.env.example`.
2.  Откройте файл `.env` и вставьте ваши реальные токены и учетные данные:

    ```env
    # Сервисный токен пользователя VK с правами доступа к группам
    VK_USER_TOKEN="vk1.a.YOUR_VK_USER_TOKEN..."

    # Ваш API ключ от Google AI Studio для работы с Gemini
    GEMINI_API_KEY="AIzaSy...YOUR_GEMINI_KEY"
    
    # Учетные данные администратора по умолчанию
    ADMIN_USERNAME="admin"
    ADMIN_PASSWORD="admin"

    # (Опционально) URL SOCKS5 прокси-сервера для доступа к Gemini API.
    # Используется для обхода геоблокировок (например, на серверах Yandex.Cloud).
    # Мы используем сервис proxy.market.
    # Формат: http://user:password@proxy_address:port
    GEMINI_PROXY_URL="http://aEyuLv:wctbkg@196.18.224.143:8000"
    ```
    **Важно:** Для локальной разработки убедитесь, что переменная `DATABASE_URL` **отсутствует или закомментирована**. В этом режиме будет использоваться локальная база данных SQLite. Для работы прокси с вашего компьютера, ваш текущий IP-адрес должен быть "привязан" в панели управления прокси-сервиса.

---

## 3. Запуск сервера для локальной разработки

Находясь в папке `backend_python` с активированным виртуальным окружением, выполните команду:

```bash
uvicorn main:app --reload
```

- `--reload` автоматически перезапускает сервер при изменении кода.

Сервер будет доступен по адресу `http://127.0.0.1:8000`.

При первом запуске рядом с файлами бэкенда будет автоматически создан файл базы данных `vk_planner.db`.

---

## 4. Взаимодействие с API

### 4.1. Интерактивная документация (Swagger UI)

FastAPI автоматически генерирует интерактивную документацию. Чтобы ее увидеть и протестировать API:

1.  Запустите локальный сервер.
2.  Откройте в браузере `http://127.0.0.1:8000/docs`.

### 4.2. Подключение фронтенда

Чтобы фронтенд начал работать с вашим локальным бэкендом:
1. Запустите фронтенд-приложение (`npm run dev` в корневой папке).
2. На странице входа найдите переключатель **"Окружение API"**.
3. Выберите **"Локальный"**. Страница перезагрузится и начнет отправлять запросы на `http://127.0.0.1:8000/api`.

---

## 5. Развертывание (Production)

Приложение спроектировано для развертывания в виде Docker-контейнера (например, в Yandex Cloud Containers).

- **База данных**: В продакшен-среде используется PostgreSQL. Подключение настраивается через переменную окружения `DATABASE_URL`.
- **Секреты**: Все секретные ключи (`VK_USER_TOKEN`, `DATABASE_URL` и т.д.) передаются в контейнер через **переменные окружения**, а не через `.env` файл.
- **Подробности**: Полная инструкция по развертыванию находится в файле `DEPLOYMENT.md` в корне проекта.