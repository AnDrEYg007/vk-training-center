# 4. Основная логика: Сервисы и CRUD

Этот документ подробно описывает два ключевых слоя, составляющих бизнес-логику и логику доступа к данным приложения.

## 1. Слой доступа к данным (папка `crud/`)

Этот слой инкапсулирует всю логику SQLAlchemy-запросов. Его единственная задача — выполнять базовые операции с базой данных (Create, Read, Update, Delete). Функции здесь не содержат сложной бизнес-логики.

### `project_crud.py.txt`
<details>
<summary>Функции для работы с проектами.</summary>

- `get_all_projects(db)`: Получает все активные проекты.
- `get_archived_projects(db)`: Получает все архивированные проекты.
- `permanently_delete_project(db, project_id)`: Безвозвратно удаляет проект.
- `update_project_settings(db, project_data)`: Обновляет поля одного проекта.
</details>

### `post_crud.py.txt`
<details>
<summary>Функции для работы с постами (опубликованными, отложенными, предложенными).</summary>

- `get_posts_by_project_id(db, project_id)`: Получает опубликованные посты.
- `replace_published_posts(...)`: Атомарно заменяет все опубликованные посты для проекта.
- `upsert_post(...)`: "Умная" вставка или обновление одного поста.
- `get_all_publication_times_for_project(...)`: Получает все занятые временные слоты для проверки конфликтов.
</details>

### `system_post_crud.py.txt`
<details>
<summary>Функции для работы с системными постами.</summary>

- `create_or_update_system_post(...)`: Создает или обновляет системный пост.
- `delete_system_post(...)`: Удаляет системный пост.
</details>

### `market_crud.py.txt` (Товары)
<details>
<summary>Функции для работы с товарами, подборками и категориями.</summary>

- `replace_market_categories(...)`: Полная замена кеша глобальных категорий.
- `replace_market_albums_for_project(...)`: Полная замена кеша подборок для проекта.
- `replace_market_items_for_project(...)`: Атомарная замена всех товаров проекта.
- `update_market_item(db, item_data)`: Обновляет поля одного товара в кеше.
- `delete_market_item(db, item_pk)`: Удаляет товар из локальной БД.
- `decrement_market_album_count(db, album_pk)`: Уменьшает счетчик товаров в подборке.
</details>

---

## 2. Слой бизнес-логики (`services/`)

Это "сердце" приложения. Сервисы координируют работу, вызывая `crud` и внешние API.

### `market_service.py.txt` (Фасад для товаров)
Этот файл является точкой входа, импортирующей логику из специализированных подмодулей:

#### `market_retrieval_service.py.txt` (Получение данных)
-   **`get_market_data`**: "Умное" получение. Сначала проверяет свежесть кеша. Если данные актуальны, возвращает их из БД. Если нет — запускает `refresh_all_market_data`.
-   **`refresh_all_market_data`**: Полная синхронизация с VK. Последовательно запрашивает категории, подборки и все товары (с учетом "сирот" без подборок), после чего полностью перезаписывает кеш в БД.

#### `market_item_create.py.txt` (Создание товаров)
-   **`create_market_item`**: Создает один товар. Поддерживает загрузку фото как из файла (`UploadFile`), так и по URL. Выполняет `market.add` в VK, `market.addToAlbum` (если нужно) и создает запись в локальном кеше.
-   **`create_market_items`**: Массовое создание товаров.

#### `market_item_update.py.txt` (Обновление товаров)
-   **`update_market_item`**: "Умное" обновление.
    1.  Загружает новое фото (если есть).
    2.  **Оптимизация:** Сравнивает старые и новые данные. Вызывает `market.edit` **только если** изменились ключевые поля (название, цена, категория и т.д.).
    3.  Отдельно обновляет привязку к подборкам (`market.removeFromAlbum`, `market.addToAlbum`), если она изменилась.
    4.  Обновляет запись в локальном кеше.
-   **`update_market_items`**: Массовое обновление.

#### `market_item_delete.py.txt` (Удаление товаров)
-   **`delete_market_items`**: Массовое удаление.
    1.  Вызывает `market.delete` в VK.
    2.  Удаляет товар из локальной БД.
    3.  Вызывает `crud.decrement_market_album_count` для обновления счетчика в подборке.

### `market_ai_service.py.txt` (AI для товаров)
Содержит продвинутую логику использования Gemini для работы с товарами.

<details>
<summary><code>suggest_market_category(db, payload)</code></summary>
Подбор категории для одного товара. Работает в **два этапа** для повышения точности:
1.  AI выбирает 2-3 наиболее подходящие **родительские секции**.
2.  AI выбирает **финальную подкатегорию** только из списка категорий, принадлежащих этим секциям.
</details>

<details>
<summary><code>bulk_suggest_market_category(db, payload)</code></summary>
Оптимизированный пакетный подбор категорий. Также работает в два этапа, но с одним большим промптом на каждом:
1.  AI возвращает JSON-объект `{itemId: [sectionId1, sectionId2]}`.
2.  AI возвращает JSON-объект `{itemId: finalCategoryId}`.
</details>

<details>
<summary><code>bulk_correct_descriptions(db, payload)</code> / <code>bulk_correct_titles(db, payload)</code></summary>
Отправляет список описаний или названий в AI с инструкцией исправить орфографию и пунктуацию. Возвращает JSON-объект `{itemId: "исправленный текст"}`.
</details>
