# Интеграция глобальных переменных с проектами (User)

**Ключевой файл:** `backend_python/services/global_variable_service.py.txt`
**Роутер:** `backend_python/routers/global_variables.py.txt`

Этот раздел описывает, как пользователи (не администраторы) взаимодействуют с глобальными переменными в контексте конкретного проекта.

---

## 1. Основные функции

### `get_for_project(db, project_id)`
-   **Назначение:** Получить все необходимые данные о глобальных переменных для одного проекта.
-   **Эндпоинт:** `POST /api/global-variables/getForProject`.
-   **Логика:**
    1.  Вызывает `crud.get_all_definitions`, чтобы получить **полный список всех определений**, существующих в системе.
    2.  Вызывает `crud.get_values_by_project_id`, чтобы получить **только те значения**, которые были сохранены для данного `project_id`.
-   **Возвращает:** Объект `GetGlobalVariablesForProjectResponse`, содержащий два списка: `definitions` и `values`.
-   **Использование:** Вызывается при открытии модального окна "Настройки проекта" для заполнения раздела "Глобальные переменные".

### `update_for_project(db, project_id, values_data)`
-   **Назначение:** Сохранить значения глобальных переменных для одного проекта.
-   **Эндпоинт:** `POST /api/global-variables/updateForProject`.
-   **Логика (реализована в `crud/global_variable_crud.py.txt`):**
    -   Используется простой и надежный подход "замены" (replace).
    -   Сначала выполняются `DELETE FROM project_global_variable_values WHERE project_id = :project_id`.
    -   Затем создаются новые записи для всех значений, переданных в `values_data`.
-   **Использование:** Вызывается при сохранении "Настроек проекта", если в разделе глобальных переменных были внесены изменения.

---

## 2. Сценарий работы (User Flow)

1.  **[Frontend]** Пользователь открывает настройки проекта.
2.  **[Frontend]** `useProjectSettingsManager` вызывает `api.getGlobalVariablesForProject(projectId)`.
3.  **[Backend]** `get_for_project` возвращает список всех определений и сохраненные значения для этого проекта.
4.  **[Frontend]** Компонент `GlobalVariablesEditor` рендерит список полей, подставляя сохраненные значения в нужные инпуты.
5.  **[Frontend]** Пользователь изменяет значения.
6.  **[Frontend]** Пользователь нажимает "Сохранить" в футере модального окна.
7.  **[Frontend]** `useProjectSettingsManager` в рамках `handleSubmit` собирает измененные значения и вызывает `api.updateGlobalVariablesForProject`.
8.  **[Backend]** `update_for_project` перезаписывает все значения для данного проекта в таблице `project_global_variable_values`.