# Жизненный цикл Системного поста (Пост-трекер)

**Ключевой файл:** `backend_python/services/post_tracker_service.py.txt`

Этот фоновый сервис является "двигателем" для системных публикаций. Он запускается в отдельном потоке при старте бэкенда и работает непрерывно.

---

## 1. Общий цикл работы

Каждые **50 секунд** трекер выполняет две основные задачи последовательно: **Публикация** и **Верификация**.

## 2. Задача 1: Публикация (`_publication_check`)

-   **Цель:** Найти и опубликовать посты, время которых пришло.
-   **Пошаговая логика:**
    1.  **Поиск:** Находит в таблице `system_posts` все записи со статусом `pending_publication`, у которых `publication_date` меньше или равно текущему времени.
    2.  **Блокировка:** Для каждого найденного поста **немедленно** меняет его статус на `publishing`. Это атомарная операция, которая гарантирует, что другой процесс не захватит этот же пост.
    3.  **Подстановка переменных:** Вызывает `global_variable_service.substitute_global_variables` для замены плейсхолдеров `{global_...}` на реальные значения.
    4.  **Публикация:** Вызывает сервис `post_service.publish_now`, который отправляет пост в VK.
    5.  **Результат:**
        -   **Успех:** Если VK API возвращает `post_id`, этот ID сохраняется в поле `vk_post_id` системного поста.
        -   **Ошибка:** Если публикация не удалась, статус поста меняется на `error`.
    6.  **Уведомление:** В любом случае вызывает `update_tracker.add_updated_project`, чтобы фронтенд узнал об изменении статуса.

## 3. Задача 2: Верификация и Регенерация (`_verification_check`)

-   **Цель:** Убедиться, что посты со статусом `publishing` действительно появились на стене VK, и, если пост циклический, создать его следующую копию.
-   **Пошаговая логика:**
    1.  **Поиск:** Находит в таблице `system_posts` все записи со статусом `publishing`.
    2.  **Проверка таймаута:** Если с момента публикации прошло более **5 минут**, а пост так и не найден, его статус меняется на `possible_error`.
    3.  **Поиск на стене:** Проверяет последние посты на стене VK по `vk_post_id` или контенту.
    4.  **Если пост найден (Верифицирован):**
        -   **Шаг А: Обработка цикличности (Регенерация):**
            -   Проверяет флаг `is_cyclic`. Если `true`, запускается логика создания следующего поста.
            -   Вычисляет следующую дату публикации (`_calculate_next_occurrence`), используя `recurrence_interval` и `recurrence_type`.
            -   **Специальная логика для месяцев:** Использует функцию `_add_months` и учитывает флаги `recurrence_is_last_day` или `recurrence_fixed_day`, чтобы корректно переносить даты (например, 31 января -> 28 февраля).
            -   **Проверка лимитов:** Проверяет условия окончания цикла. Если `recurrence_end_type` равен `count`, уменьшает счетчик. Если `date`, проверяет, не вышла ли новая дата за предел.
            -   **Создание:** Если условия позволяют, создает **новую запись** в `system_posts` со статусом `pending_publication`, новой датой и унаследованными настройками.
        -   **Шаг Б: Очистка:**
            -   Трекер вызывает `crud.delete_system_post`, **полностью удаляя** текущую (уже опубликованную) запись из таблицы `system_posts`.
    5.  **Уведомление:** При любом изменении статуса или удалении вызывается `update_tracker.add_updated_project`.