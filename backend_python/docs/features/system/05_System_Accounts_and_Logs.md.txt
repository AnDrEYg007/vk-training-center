# Системные Аккаунты и Логирование

**Сервисы:** `services/system_accounts/account_service.py.txt`, `services/token_log_service.py.txt`
**Роутер:** `routers/system_accounts.py.txt`
**Таблицы:** `system_accounts`, `token_logs`

Этот модуль обеспечивает инфраструктуру для **ротации токенов**, повышения надежности запросов к VK API и аудита системы.

## 1. Системные Аккаунты (`SystemAccount`)

Это сущности, хранящие сервисные токены ВКонтакте. Они используются системой ("воркерами") для выполнения запросов на чтение и запись, когда основной токен недоступен или заблокирован.

### 1.1. Модель данных
*   `id`: UUID.
*   `vk_user_id`: ID пользователя VK.
*   `token`: Сам access_token (хранится в открытом виде для использования воркерами).
*   `status`:
    *   `active`: Токен проверен и работает.
    *   `error`: Токен невалиден или забанен.
    *   `unknown`: Статус неизвестен (после добавления).
*   `stats`: Динамическое поле (не хранится в БД), содержащее счетчики успешных и ошибочных запросов из таблицы логов.

### 1.2. Основные операции
*   **`add_accounts_by_urls`**: Парсит список ссылок, запрашивает данные профилей через `users.get` и создает записи в БД. Токены при этом не заполняются (пользователь должен авторизовать их вручную).
*   **`verifyToken`**: Проверяет токен, делая тестовый запрос к `users.get`. Сравнивает ID владельца токена с ID аккаунта в базе для защиты от ошибок.
*   **`verifyEnvToken`**: Специальная функция для проверки токена из `.env` файла.

---

## 2. Логирование Токенов (`TokenLog`)

Система записывает результат **каждого** запроса к VK API, проходящего через `api_client.py`.

### 2.1. Модель данных
*   `account_id`: Ссылка на системный аккаунт (или `NULL`, если токен неизвестен/удален).
*   `is_env_token`: Флаг, указывающий, что использовался токен из `.env`.
*   `method`: Название метода API (например, `wall.get`).
*   `status`: `success` или `error`.
*   `error_details`: Текст ошибки (если есть).
*   `timestamp`: Время запроса.

### 2.2. Логика записи (`log_api_call`)
Эта функция вызывается внутри `api_client.py` (в блоках `try/except`).
1.  Она определяет владельца токена:
    *   Сначала проверяет, совпадает ли токен с `.env`.
    *   Если нет, ищет токен в кеше в памяти (`_TOKEN_CACHE`).
    *   Если нет в кеше, ищет в БД и обновляет кеш.
2.  Создает запись в таблице `token_logs` в **отдельной сессии БД**, чтобы лог сохранился даже в случае отката основной транзакции.

### 2.3. Аналитика (`token_log_service.py`)
Бэкенд предоставляет мощные инструменты для анализа логов:
*   **`get_logs`**: Получение списка с пагинацией и фильтрацией (по аккаунту, статусу, поиску).
*   **`get_stats`**: Агрегированные счетчики (Total, Success, Error) и списки популярных методов для конкретного аккаунта.
*   **`get_chart_data`**: Данные для построения графика активности.
    *   Агрегирует логи по временным интервалам (час/день/неделя) в памяти Python.
    *   Формирует структуру для графика: `{ date: "12:00", methods: { "wall.get": 10, "likes.getList": 5 } }`.

---

## 3. Взаимодействие с фронтендом

*   **Task Monitor:** Фронтенд использует `ActiveTasksTab` для мониторинга фоновых задач (которые могут использовать эти аккаунты).
*   **Ротация:** Фронтенд не управляет ротацией напрямую. Он лишь настраивает аккаунты. Ротация происходит автоматически внутри `vk_service` и `list_sync_*.py` сервисов.