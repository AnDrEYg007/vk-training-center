# 4. Процессы запуска и Middleware

**Ключевой файл:** `backend_python/main.py.txt`

Этот документ описывает служебные процессы, которые происходят при запуске сервера, а также глобальные обработчики (middleware), которые применяются ко всем запросам.

---

## 1. Событие при запуске (`@app.on_event("startup")`)

Эта функция выполняется **один раз** при старте бэкенд-сервера. Она отвечает за подготовку приложения к работе.

### Задача 1: Миграции базы данных
-   **Действие:** Вызывается функция `run_migrations(engine)`.
-   **Назначение:** Проверяет схему базы данных и автоматически добавляет недостающие таблицы или колонки. Подробнее см. в документе `03_Migrations.md.txt`.

### Задача 2: Начальное заполнение БД (Seeding)
-   **Действие:** Проверяется, пуста ли таблица `projects`.
-   **Логика:** Если таблица пуста (при самом первом запуске), скрипт автоматически добавляет в нее **несколько тестовых проектов** с предустановленными данными.
-   **Назначение:** Это позволяет разработчику или новому пользователю начать работу с приложением **сразу после первого запуска**, не тратя время на ручное добавление проектов для тестирования.

### Задача 3: Запуск фоновых сервисов
-   **Действие:** Вызывается функция `post_tracker_service.start_post_tracker()`.
-   **Назначение:** Запускает в отдельном фоновом потоке "Пост-трекер", который отвечает за автоматическую публикацию и верификацию системных постов.

---

## 2. Глобальные обработчики (Middleware и Handlers)

### `add_no_cache_headers` (Middleware)
-   **Тип:** Middleware.
-   **Назначение:** Добавляет к **каждому** HTTP-ответу от сервера заголовки, запрещающие кэширование (`Cache-Control: no-cache`).
-   **Зачем это нужно:** Гарантирует, что фронтенд-приложение всегда получает самые свежие данные от API, а не их устаревшую версию из кэша браузера. Особенно полезно при разработке.

### `http_exception_handler` (Exception Handler)
-   **Тип:** Обработчик исключений.
-   **Назначение:** Перехватывает все ошибки `HTTPException`, которые генерируются в приложении (например, при отсутствии прав доступа или ненайденных данных), и форматирует ответ в единый стандарт.
-   **Особенность:** Для ошибок `401 Unauthorized` возвращает специальный JSON-формат `{"success": false, "error": "..."}`, который ожидает обработчик на странице входа (`LoginPage.tsx`).

### `get_db` (Dependency)
-   **Тип:** Зависимость (Dependency).
-   **Назначение:** Это стандартный для FastAPI паттерн, который предоставляет каждому API-эндпоинту свою собственную, изолированную сессию для работы с базой данных и гарантирует, что она будет корректно закрыта после завершения запроса.
