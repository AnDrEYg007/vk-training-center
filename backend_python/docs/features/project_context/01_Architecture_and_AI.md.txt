
# Контекст Проекта: Архитектура и AI

**Сервис:** `backend_python/services/project_context_service.py.txt`
**Роутер:** `backend_python/routers/project_context.py.txt`
**AI Модули:** `backend_python/services/gemini_api/analysis.py.txt`, `marketing.py.txt`

Модуль "Контекст проекта" хранит структурированные знания о каждом сообществе (бренд, тон, товары), которые используются нейросетями для повышения качества генерации.

---

## 1. Модель данных (Гибкая схема)

Вместо жестко заданных колонок в таблице проектов, используется EAV-подобная (Entity-Attribute-Value) схема, позволяющая динамически добавлять новые поля.

### Таблицы
1.  **`project_context_fields` (Поля):** Определения колонок.
    *   `name`: Название (например, "Тональность бренда").
    *   `description`: Инструкция для AI, объясняющая, что это за поле.
    *   `is_global`: Флаг видимости (для всех проектов или только для избранных).
2.  **`project_context_values` (Значения):** Конкретные данные.
    *   Связывает `project_id`, `field_id` и `value` (текст).
3.  **`project_context_field_visibility`:** Таблица связка для настройки видимости не-глобальных полей.

---

## 2. AI-Автозаполнение (`ai_autofill_project`)

Эта функция анализирует "сырые" данные из ВКонтакте и автоматически заполняет поля контекста.

### 2.1. Источники данных
Сервис собирает расширенное досье о группе через VK API:
*   `groups.getById`: Описание, статус, ссылки, сайт, контакты.
*   `groups.getAddresses`: Физические адреса и телефоны точек.

### 2.2. Стратегия и Промпт
Используется стратегия `ANALYTICAL`. Промпт в `analysis.py` содержит:
1.  JSON-дамп данных из VK.
2.  Список полей, которые нужно заполнить, с их описаниями.
3.  **Жесткие правила валидации** (см. ниже).

### 2.3. Правила валидации (Post-Processing)
Даже если AI вернул ответ, сервис `project_context_service.py` проводит строгую проверку критических полей через `_validate_ai_value`:

*   **Android:** Ссылка обязана начинаться с `https://play.google.com/store/apps/details?`.
*   **IOS:** Ссылка обязана быть на `apps.apple.com`.
*   **Dlvry (Приложение доставки):** Должна соответствовать формату `https://vk.com/app6408974_-...`.
*   **Сайт:** Не может быть ссылкой на приложение VK (`vk.com/app...`), это частая ошибка AI.
*   **Зона доставки:** Принимаются только ссылки на карты (Yandex, Google, 2GIS). Текстовые описания районов отбрасываются.

---

## 3. Специализированные Генераторы (`marketing.py`)

Для сложных текстовых полей используются отдельные "Экспертные" промпты:

### `generate_company_desc`
*   **Вход:** Данные VK + Тексты последних 50 постов.
*   **Задача:** Сформулировать миссию и УТП компании.
*   **Фильтр:** AI проинструктирован *не дублировать* перечень товаров, если они уже есть в другом поле.

### `generate_products_desc`
*   **Вход:** Реальные товары из каталога VK (Market items) и подборки.
*   **Задача:** Составить обобщенную справку об ассортименте и ценовом сегменте (Бюджет/Премиум).

### `generate_tone`
*   **Вход:** Тексты последних 50 постов.
*   **Задача:** Определить Tone of Voice (обращение на "ты"/"вы", уровень юмора, эмоциональность).
