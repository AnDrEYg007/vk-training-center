# Управление тегами

**Ключевой файл:** `backend_python/services/tag_service.py.txt`

Этот модуль содержит всю бизнес-логику для CRUD-операций с тегами и для процесса пере-тегирования постов.

---

## 1. Основные CRUD-функции

-   `get_tags_for_project(db, project_id)`
-   `create_tag(db, tag_data, project_id)`
-   `update_tag(db, tag_id, tag_data)`
-   `delete_tag(db, tag_id)`

Эти функции являются простыми обертками над соответствующими `crud`-функциями, преобразуя SQLAlchemy-модели в Pydantic-схемы для ответа API.

## 2. Основная бизнес-логика

### `retag_all_posts_for_project(db, project_id)`
-   **Назначение:** Принудительно запустить процесс пере-сканирования и пере-присвоения тегов для **всех** постов в проекте.
-   **Пошаговая логика:**
    1.  **Получение данных:** Загружает из БД все опубликованные посты, все отложенные посты и все теги для данного проекта.
    2.  **Итерация по постам:** Проходит по каждому посту в цикле.
    3.  **Сравнение:** Для каждого поста:
        -   Сохраняет текущий набор присвоенных ему тегов.
        -   Вызывает `assign_tags_to_post` (из `post_helpers`), которая определяет новый, правильный набор тегов на основе обновленных правил (ключевых слов).
        -   Сравнивает старый и новый наборы тегов.
    4.  **Обновление (если нужно):** Если наборы тегов отличаются, обновляет связь `post.tags`.
    5.  **Сохранение:** После проверки всех постов выполняет `db.commit()` для сохранения всех изменений в БД.
    6.  **Уведомление:** Вызывает `update_tracker.add_updated_project(project_id)`, чтобы фронтенд узнал о необходимости обновить календарь.
-   **Связи:**
    -   Вызывается из: `routers/tags.py.txt`.
    -   Вызывает: `crud.get_posts_by_project_id`, `crud.get_scheduled_posts_by_project_id`, `assign_tags_to_post`, `update_tracker.add_updated_project`.