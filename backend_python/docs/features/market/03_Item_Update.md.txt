# Обновление товаров

**Ключевой файл:** `backend_python/services/market_item_update.py.txt`

Этот модуль содержит логику для "умного" и эффективного обновления существующих товаров в VK Market.

---

## 1. Основные функции

### `update_market_item(db, project_id, item_data, user_token, file, photo_url)`
-   **Назначение:** Обновить один существующий товар.
-   **Логика "умного" обновления:**
    1.  **Загрузка фото (если нужно):** Аналогично `create_market_item`, обрабатывает `file` или `photo_url` для получения нового `main_photo_id`.
    2.  **Проверка изменений (Оптимизация):**
        -   Функция сравнивает данные из `item_data` (фронтенд) с данными из локальной БД (`original_db_item`).
        -   **Только если** изменились ключевые поля (название, описание, цена, категория, фото), вызывается метод `market.edit` VK API. Это экономит вызовы API, если изменились только, например, подборки.
    3.  **Обновление подборок:**
        -   Сравнивает старый и новый `album_ids`.
        -   Если есть расхождения, вызывает `market.removeFromAlbum` и/или `market.addToAlbum`.
        -   **Важно:** После этого обновляет счетчики `count` в таблице `market_albums` в локальной БД, чтобы UI на фронтенде оставался консистентным.
    4.  **Обновление локального кеша:** Вне зависимости от того, были ли вызовы к VK API, функция обновляет запись в таблице `market_items` через `crud.update_market_item`, чтобы отразить все изменения.
-   **Связи:**
    -   Вызывается из: `routers/market.py.txt`.
    -   Вызывает: `vk_service.upload_market_photo`, `vk_service.call_vk_api`, `crud.update_market_item`, `crud.decrement_market_album_count`.

### `update_market_items(db, project_id, items_data, user_token)`
-   **Назначение:** Массовое обновление товаров.
-   **Логика:** Итерирует по списку `items_data` и последовательно вызывает `update_market_item` для каждого.
-   **Связи:**
    -   Вызывается из: `routers/market.py.txt`.
    -   Вызывает: `update_market_item`.

### `upload_market_item_photo(db, project_id, item_id, file, user_token)`
-   **Назначение:** Специализированная функция для обновления **только** главного фото товара.
-   **Логика:**
    1.  Загружает фото (`vk_service.upload_market_photo`), получая `photo_id`.
    2.  Вызывает `market.edit`, передавая **только** `owner_id`, `item_id` и `main_photo_id`.
    3.  Обновляет поле `thumb_photo` в локальной БД.
-   **Связи:**
    -   Вызывается из: `routers/market.py.txt` (устаревший эндпоинт, может быть удален).
    -   Вызывает: `vk_service.upload_market_photo`, `vk_service.call_vk_api`.