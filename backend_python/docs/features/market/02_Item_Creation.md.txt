# Создание товаров

**Ключевой файл:** `backend_python/services/market_item_create.py.txt`

Этот модуль инкапсулирует всю логику, связанную с созданием новых товаров в VK Market и их последующим сохранением в локальный кеш.

---

## 1. Основные функции

### `create_market_item(db, project_id, item_data, user_token, file, photo_url)`
-   **Назначение:** Создать один новый товар. Это комплексная функция, выполняющая несколько шагов.
-   **Пошаговая логика:**
    1.  **Загрузка фото:**
        -   Определяет источник фото: `file` (загруженный файл) имеет приоритет над `photo_url` (ссылка).
        -   Если источник — ссылка, скачивает изображение с помощью `requests`.
        -   Вызывает `vk_service.upload_market_photo`, который реализует 3-шаговую загрузку фото в VK и возвращает `photo_id` и URL миниатюры.
    2.  **Создание товара в VK:**
        -   Формирует параметры для метода `market.add`.
        -   Цена конвертируется из копеек в рубли.
        -   Вызывает `vk_service.call_vk_api('market.add', ...)`.
        -   Получает в ответе `market_item_id`.
    3.  **Добавление в подборку:**
        -   Если в `item_data` передан `album_id`, вызывает `vk_service.call_vk_api('market.addToAlbum', ...)`.
    4.  **Сохранение в локальный кеш:**
        -   Формирует объект `models.MarketItem` на основе полученных от VK данных и `item_data`.
        -   Цена конвертируется обратно в копейки и сохраняется как JSON-строка.
        -   Объект категории находится в локальном кеше (`market_categories`) и сохраняется как JSON.
        -   Вызывает `db.add()` и `db.commit()` для сохранения в БД.
-   **Связи:**
    -   Вызывается из: `routers/market.py.txt`.
    -   Вызывает: `vk_service.upload_market_photo`, `vk_service.call_vk_api`, `crud.get_all_market_categories`.

### `create_market_items(db, project_id, items, user_token)`
-   **Назначение:** Массовое создание товаров.
-   **Логика:**
    -   Просто итерирует по списку `items` и последовательно вызывает `create_market_item` для каждого из них.
    -   Собирает статистику по успешным операциям и ошибкам.
-   **Обработка ошибок:** Если один товар не удалось создать, процесс не прерывается. Ошибка логируется, и функция переходит к следующему товару.
-   **Связи:**
    -   Вызывается из: `routers/market.py.txt`.
    -   Вызывает: `create_market_item`.