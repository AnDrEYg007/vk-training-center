# Логика работы с Галереей (Медиа)

**Ключевой файл:** `backend_python/services/media_service.py.txt`

Этот модуль отвечает за все операции, связанные с медиаконтентом: загрузку фото, создание альбомов и управление кешем галереи.

---

## 1. Основные функции

### `upload_photo(db, project_id, file)`
-   **Назначение:** Загрузить фото для прикрепления к посту (в альбом "Фото на стене").
-   **Логика:** Вызывает `vk_service.upload_wall_photo`, который инкапсулирует 3-шаговый процесс загрузки.
-   **Возвращает:** Объект `PhotoAttachment` с `id` и `url` для фронтенда.

### `create_album(db, project_id, title)`
-   **Назначение:** Создать новую подборку (фотоальбом) в VK.
-   **Логика:**
    1.  Вызывает `vk_service.call_vk_api('photos.createAlbum', ...)`.
    2.  После успешного создания в VK, форматирует ответ и создает новую запись в таблице `albums` в локальной БД.
-   **Связи:** Вызывается из `routers/media.py.txt`.

### `upload_photo_to_album(db, project_id, album_id, file)`
-   **Назначение:** Загрузить фото в конкретный альбом.
-   **Логика:**
    1.  Вызывает `vk_service.upload_album_photo`, который реализует 3-шаговую загрузку фото в альбом.
    2.  После успешной загрузки в VK, добавляет новую запись в таблицу `photos` и инкрементирует счетчик `size` в таблице `albums` в локальной БД.

### `get_albums(db, project_id)` / `refresh_albums(db, project_id)`
-   **Назначение:** Получить/обновить список альбомов.
-   **Логика:** `get_albums` сначала проверяет кеш в БД. Если он пуст, автоматически вызывает `refresh_albums`, который запрашивает данные из VK и полностью перезаписывает кеш.

### `get_photos(db, project_id, album_id, page)` / `refresh_photos(db, project_id, album_id)`
-   **Назначение:** Получить/обновить список фотографий в альбоме.
-   **Логика:** `get_photos` проверяет кеш. Если для первой страницы кеш пуст, он запускает `refresh_photos`, который загружает **все** фото из альбома VK (с пагинацией), сохраняет их в БД и возвращает первую страницу. Последующие страницы (`page > 1`) всегда берутся из кеша.