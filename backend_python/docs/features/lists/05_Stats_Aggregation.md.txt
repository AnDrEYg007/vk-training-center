
# Агрегация Статистики

**Файл:** `backend_python/crud/lists/stats_users.py.txt`
**Файл:** `backend_python/crud/lists/stats_posts.py.txt`

## 1. Статистика Постов
Агрегирует лайки, просмотры и другие метрики, группируя их по времени (день/неделя/месяц) с заполнением пропусков (Gap Filling).

## 2. Статистика Пользователей

Для списков людей (подписчики, рассылка, активности) сервис выполняет сложные агрегации на стороне БД и Python.

*   **Качество и Пол:** SQL `COUNT` с группировкой.
*   **Платформы:** Группировка по полю `platform` (1=Mob, 2=iPhone, 4=Android, 7=Web).
*   **Возраст и Дни рождения:**
    *   Поле `bdate` в VK хранится как строка ("D.M.YYYY" или "D.M").
    *   Сервис загружает `bdate` всех пользователей в память (для разумных объемов до 100-200к это эффективно).
    *   **Месяц:** Извлекается вторая часть строки `bdate`.
    *   **Возраст:** Если есть год, вычисляется возраст и инкрементируется соответствующий бакет (`u16`, `16-20`, `20-25`... `45p`).
*   **Онлайн:** SQL-запрос с `CASE`, группирующий пользователей по интервалам времени от `last_seen` до `now`.

### Специфика Рассылки (Mailing)
Для списка рассылки рассчитываются дополнительные метрики:

*   **Доступность ЛС:** Подсчет `can_access_closed` (True/False).
*   **Последний контакт (Last Contact):**
    *   Используется поле `last_message_date` (DateTime).
    *   SQL-запрос с `CASE` распределяет пользователей по "свежести" диалога:
        -   `today`: < 24 часов.
        -   `3_days`, `week`, `month_plus`...
        -   `year_plus`: Диалог был более года назад.
