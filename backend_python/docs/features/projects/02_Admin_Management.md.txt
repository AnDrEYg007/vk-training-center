# Массовое управление проектами (Admin)

**Ключевой файл:** `backend_python/services/management_service.py.txt`
**Роутер:** `backend_python/routers/management.py.txt`

Этот модуль предоставляет мощные инструменты для администраторов, позволяя выполнять массовые операции с проектами, такие как добавление по URL, архивация и безвозвратное удаление.

---

## 1. Основные функции

### `get_all_projects_for_management(db)` / `get_archived_projects(db)`
-   **Назначение:** Получить полный список активных или архивированных проектов для отображения на странице управления.
-   **Логика:** В отличие от `get_initial_data`, который может быть оптимизирован для быстрой загрузки, эти функции всегда возвращают полный и актуальный список из базы данных.

### `update_projects(db, projects_to_update)`
-   **Назначение:** Атомарно применить все изменения, сделанные в редактируемой таблице на фронтенде.
-   **Логика:** Итерирует по списку проектов и для каждого вызывает `crud.update_project_settings`.

### `permanently_delete_project(db, project_id)`
-   **Назначение:** Безвозвратно удалить проект и **все связанные с ним данные**.
-   **Логика каскадного удаления:** Благодаря настройке `ondelete="CASCADE"` в моделях SQLAlchemy (`models.py.txt`), при удалении проекта из таблицы `projects` база данных автоматически удаляет все связанные с ним записи из других таблиц:
    -   `posts` (опубликованные посты)
    -   `scheduled_posts` (отложенные посты VK)
    -   `system_posts` (системные посты)
    -   `suggested_posts` (предложенные посты)
    -   `notes` (заметки)
    -   `tags` (теги)
    -   `albums` и `photos` (кеш галереи)
    -   `market_albums` и `market_items` (кеш товаров)
    -   `project_global_variable_values` (значения глобальных переменных)
-   **Важно:** Это действие является **необратимым**.

### `add_projects_by_urls(db, urls_string, user_token)`
-   **Назначение:** Эффективно добавить в систему несколько новых проектов по списку ссылок.
-   **Пошаговая логика "умного" добавления:**
    1.  **Парсинг и очистка:** Функция принимает многострочный текст со ссылками, очищает его и создает список URL для обработки.
    2.  **Извлечение идентификаторов:** Из каждой ссылки извлекается "чистый" идентификатор сообщества (например, `durov` или `club12345`) с помощью `vk_service.extract_vk_group_identifier`.
    3.  **Разрешение имен (Screen Name Resolution):** Если идентификатор — это короткое имя (строка), вызывается `vk_service.resolve_screen_name` для получения его числового ID.
    4.  **Фильтрация дубликатов:** Функция получает из БД список всех уже существующих `vkProjectId` и отсеивает те проекты, которые уже есть в системе.
    5.  **Пакетный запрос к VK:** Все уникальные новые ID собираются в одну строку через запятую. Выполняется **один-единственный вызов** `groups.getById` для получения информации обо всех новых сообществах сразу. Это значительно эффективнее, чем делать по одному запросу на каждый URL.
    6.  **Создание в БД:** На основе ответа от VK создаются новые записи `models.Project` и сохраняются в базу данных одним `commit`.
-   **Возвращает:** Статистику `{"added": X, "skipped": Y, "errors": Z}` для отображения в UI.
