# Основная логика управления проектами

**Ключевой файл:** `backend_python/services/project_service.py.txt`
**Ключевой файл (управление):** `backend_python/services/management_service.py.txt`

Эти модули содержат бизнес-логику для получения, обновления и массового создания проектов.

---

## 1. `project_service.py` (Основные операции)

### `get_initial_data(db)`
-   **Назначение:** Получить первоначальный набор данных, необходимый для загрузки приложения.
-   **Логика:**
    1.  Вызывает `crud.get_all_projects` для получения списка всех активных проектов.
    2.  Вызывает `crud.get_suggested_post_counts` для получения количества предложенных постов (для счетчиков в сайдбаре).
-   **Возвращает:** Объект `InitialDataResponse`, содержащий `projects` и `suggestedPostCounts`.

### `update_project_settings(db, project_data)`
-   **Назначение:** Обновить данные одного проекта.
-   **Логика:** Просто вызывает `crud.update_project_settings`, который выполняет `UPDATE` в БД.

---

## 2. `management_service.py` (Массовые операции)

### `get_all_projects_for_management(db)`
-   **Назначение:** Получить список всех проектов для страницы "Управление базой проектов".
-   **Логика:** Вызывает `crud.get_all_projects`.

### `update_projects(db, projects_to_update)`
-   **Назначение:** Массово обновить данные для списка проектов.
-   **Логика:** Итерирует по списку и вызывает `crud.update_project_settings` для каждого проекта.

### `add_projects_by_urls(db, urls_string, user_token)`
-   **Назначение:** Массово добавить новые проекты по списку URL.
-   **Пошаговая логика:**
    1.  **Парсинг и фильтрация:**
        -   Разбивает многострочный `urls_string` на отдельные URL.
        -   Извлекает из каждого URL идентификатор группы (числовой или короткое имя).
        -   Для коротких имен вызывает `vk_service.resolve_screen_name`, чтобы получить числовой ID.
        -   Сравнивает полученные ID с уже существующими в БД (`crud.get_all_vk_project_ids`) и отсеивает дубликаты.
    2.  **Массовый запрос к VK:**
        -   Собирает все уникальные новые ID в одну строку через запятую.
        -   Вызывает `vk_service.call_vk_api('groups.getById', ...)` **один раз** для получения информации обо всех новых группах.
    3.  **Создание в БД:**
        -   Итерирует по ответу от VK.
        -   Для каждой группы создает новый объект `models.Project` с уникальным `uuid`.
        -   Вызывает `db.add_all()` и `db.commit()` для сохранения всех новых проектов одним запросом.
-   **Возвращает:** Статистику `{"added": X, "skipped": Y, "errors": Z}`.