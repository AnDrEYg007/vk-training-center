
# Клиент для Gemini API

**Ключевой файл:** `backend_python/services/gemini_api/client.py.txt`

Этот модуль является низкоуровневым клиентом для взаимодействия с Google Gemini API. Он отвечает за формирование HTTP-запросов, ротацию ключей, выбор стратегии модели и обработку ошибок.

---

## 1. Стратегии выбора моделей (Model Strategies)

Система не просто использует одну модель, а выбирает оптимальное семейство моделей в зависимости от типа задачи. Это определяется параметром `strategy` в функции `generate_text`.

### Семейства моделей
*   **GEMMA_SERIES:** Модели, оптимизированные для следования инструкциям и работы с JSON (`gemma-3-27b-it`, `gemma-3-12b-it` и др.).
*   **GEMINI_SERIES:** Модели, оптимизированные для креатива и понимания нюансов языка (`gemini-2.5-flash`, `gemini-2.0-flash` и др.).

### Доступные стратегии
1.  **`ANALYTICAL` (Аналитическая)**
    *   **Назначение:** Структурирование данных, работа с JSON, исправление ошибок, автозаполнение полей контекста, подбор категорий товаров.
    *   **Приоритет:** Сначала пробуются модели **Gemma** (от самой мощной к слабой), затем старые версии Gemini.
    *   **Особенность:** Для моделей Gemma системная инструкция "вшивается" в тело пользовательского промпта, так как они хуже поддерживают отдельное поле `systemInstruction`.

2.  **`CREATIVE` (Креативная)** - *По умолчанию*
    *   **Назначение:** Написание постов, рерайт, расширение текста, генерация идей.
    *   **Приоритет:** Сначала пробуются новейшие модели **Gemini** (2.5, 2.0), затем более слабые, и в конце Gemma.

---

## 2. Ротация API-ключей (Multi-Key Rotation)

Для обхода лимитов (Rate Limits) и повышения отказоустойчивости клиент реализует двухуровневую систему ключей.

### Источники ключей
1.  **ENV Key:** Основной ключ из переменной окружения `GEMINI_API_KEY`.
2.  **DB Tokens:** Дополнительные ключи, добавленные пользователями через интерфейс (таблица `ai_tokens`).

### Алгоритм выполнения запроса (Models -> Keys Loop)
Алгоритм оптимизирован для максимального использования квот наиболее подходящей модели.

1.  **Внешний цикл:** Перебор моделей из выбранной стратегии (от лучшей к худшей).
2.  **Внутренний цикл:** Перебор всех доступных API-ключей.
    *   Делается попытка запроса к текущей модели с текущим ключом.
    *   **Успех:** Результат возвращается немедленно.
    *   **Ошибка 429 (Quota Exceeded) или 403:** Клиент переходит к следующему ключу для **этой же** модели.
    *   **Ошибка 400 (Invalid Key):** Ключ помечается как невалидный и исключается из дальнейшего перебора в текущем запросе.
    *   **Ошибка 404 (Model Not Found):** Модель пропускается, цикл ключей прерывается, переход к следующей модели.

Этот подход гарантирует, что если у вас есть 5 ключей, и самый мощный `gemini-2.5-flash` доступен хотя бы на одном из них, будет использован именно он, а не более слабая модель.

---

## 3. Основные функции

### `generate_text(user_prompt, system_instruction, strategy)`
-   **Назначение:** Главная точка входа.
-   **Логика:** Запускает цикл перебора моделей и ключей.
-   **Обработка ошибок:**
    -   `503`: Временная недоступность -> Экспоненциальная задержка и повтор (в рамках одного ключа/модели).
    -   **Critical Failure:** Если перебраны все комбинации моделей и ключей, выбрасывается исключение, которое на фронтенде вызывает глобальное модальное окно ошибки.

### `_execute_single_request(...)`
-   **Назначение:** Выполняет один конкретный HTTP-запрос.
-   **Логика:** Содержит логику ретраев для сетевых ошибок и настройку прокси (SOCKS5), если `GEMINI_PROXY_URL` задан в конфигурации.
