# Низкоуровневый клиент: `api_client.py`

**Ключевой файл:** `backend_python/services/vk_api/api_client.py.txt`

Этот модуль является "сердцем" и единственной точкой для прямого взаимодействия с VK API. Вся его логика инкапсулирована в одной универсальной функции `call_vk_api`.

---

## 1. Функция `call_vk_api(method, params)`

-   **Назначение:** Выполнить любой метод VK API с максимальной надежностью.
-   **Входные данные:** `method` (строка, например, `'wall.get'`) и `params` (словарь с параметрами).

### 1.1. Логика повторных попыток (Exponential Backoff)

Это ключевая особенность, обеспечивающая стабильность приложения.

-   **Проблема:** Сеть может быть нестабильной, а серверы VK могут временно не отвечать (ошибки 5xx). Простой `requests.post` в таких случаях сразу же вызовет ошибку.
-   **Решение:** `call_vk_api` обернута в цикл, который делает до 5 попыток. В случае сетевой ошибки или ошибки сервера, функция не падает, а ждет некоторое время (1, 2, 4, 8... секунд) и пытается снова. Задержка между попытками увеличивается экспоненциально, чтобы не "заспамить" сервер VK.

### 1.2. "Умная" обработка ошибок

Не все ошибки требуют повторных попыток.

-   **Permanent Errors:** Функция содержит список "постоянных" кодов ошибок VK (например, `15 - Access denied`). Если VK возвращает такую ошибку, `call_vk_api` немедленно прекращает попытки и пробрасывает исключение `VkApiError`, так как повторный запрос с теми же параметрами даст тот же результат.
-   **`VkApiError`:** Это кастомное исключение, которое содержит не только текст, но и код ошибки от VK. Это позволяет вышестоящим сервисам принимать более осмысленные решения (например, обработать ошибку `214 - Time conflict`).

### 1.3. Логирование

-   Перед каждым запросом в консоль выводится подробная информация о вызываемом методе и параметрах (токен маскируется для безопасности).
-   После получения ответа в консоль выводится полный "сырой" JSON от VK.
-   Это критически важно для отладки и анализа проблем.

---

## 2. Сценарий работы

1.  Сервис (например, `post_retrieval_service`) вызывает `vk_service.call_vk_api('wall.get', ...)`.
2.  `api_client.py` формирует `POST` запрос на `https://api.vk.com/method/wall.get`.
3.  Происходит сетевая ошибка. `call_vk_api` ловит исключение, ждет 1 секунду.
4.  Вторая попытка. VK возвращает ошибку `503 Service Unavailable`. `call_vk_api` ловит ее, ждет 2 секунды.
5.  Третья попытка. VK возвращает успешный ответ с JSON.
6.  `call_vk_api` парсит JSON, проверяет отсутствие поля `error` и возвращает содержимое поля `response` в вызвавший сервис.
