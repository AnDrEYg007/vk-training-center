# Форматтеры данных: `formatters.py`

**Ключевой файл:** `backend_python/services/vk_api/formatters.py.txt`

Этот модуль решает одну из главных проблем при работе с внешними API — преобразование "сырых", часто неконсистентных данных в стандартизированную, предсказуемую структуру, используемую внутри нашего приложения.

---

## 1. Назначение

-   **Стандартизация:** Преобразовать объекты, полученные от VK API, в наши Pydantic-схемы (`schemas`).
-   **Изоляция:** Вся логика парсинга сложных структур (например, массива `attachments`) инкапсулирована здесь. Если VK изменит формат ответа, нам нужно будет поправить только этот файл.
-   **Очистка:** Извлечь только нужные поля, отбросив все лишнее.

---

## 2. Ключевые функции

### `format_vk_post(vk_post, is_published)`
-   **Назначение:** Преобразовать объект поста из `wall.get` в нашу внутреннюю структуру.
-   **Что делает:**
    -   Формирует `id` в формате `ownerId_postId`.
    -   Конвертирует `timestamp` в строку `ISO 8601`.
    -   Вызывает `_extract_photos` и `_extract_other_attachments` для парсинга вложений.
    -   Генерирует `vkPostUrl` — прямую ссылку на пост.

### `_extract_photos(attachments)`
-   **Назначение:** Извлечь из массива `attachments` только вложения типа `photo`.
-   **Логика:**
    -   Итерирует по массиву.
    -   Для каждой фотографии находит изображение с максимальным разрешением (`sizes`).
    -   Возвращает массив объектов `{ id: "photo...", url: "..." }`.

### `_extract_other_attachments(attachments)`
-   **Назначение:** Извлечь все остальные поддерживаемые типы вложений (видео, опросы, документы и т.д.).
-   **Логика:**
    -   Итерирует по массиву.
    -   Для каждого типа формирует понятное `description` (например, "Опрос: Как ваше настроение?").

### `format_market_item(vk_item)` / `format_market_album(vk_album)`
-   **Назначение:** Аналогичные функции для преобразования данных о товарах и подборках из VK Market API.

---

## 3. Пример "до" и "после"

**"Сырой" `attachment` от VK:**
```json
{
  "type": "photo",
  "photo": {
    "id": 12345,
    "owner_id": -98765,
    "sizes": [
      { "type": "s", "url": "..." },
      { "type": "x", "url": "..." }
    ],
    ...
  }
}
```

**Результат работы `_extract_photos`:**
```json
[{
  "id": "photo-98765_12345",
  "url": "..." // URL из 'x'
}]
```
