# 8. Справочник методов VK API

Этот документ содержит исчерпывающий список всех методов API ВКонтакте, которые используются в бэкенде приложения. Для каждого метода приведено описание его роли в системе, ключевых параметров и возвращаемых данных.

---

## 1. Группы и Пользователи (Core)

Эти методы используются для получения базовой информации о сообществах и пользователях, а также для служебных целей (резолвинг имен).

### `groups.getById`
*   **Зачем нужен:**
    1.  Получение информации о проекте (название, аватар) при добавлении по ссылке.
    2.  Получение `screen_name` группы для формирования AI-промптов.
*   **Как делается:** `POST` запрос.
    *   Параметры: `group_id` (или `group_ids` для списка), `fields` (например, 'screen_name,site').
*   **Что отдает:** Массив объектов `Group` с запрошенными полями.
*   **Альтернативы:**
    *   `utils.resolveScreenName` — если нужно просто узнать ID по короткому имени, но `groups.getById` дает больше деталей.

### `users.get`
*   **Зачем нужен:**
    1.  Обогащение данных в системных списках (лайки, комментарии, подписчики). Позволяет получить актуальное фото, статус блокировки, пол и время последнего захода.
*   **Как делается:** `POST` запрос.
    *   Параметры: `user_ids` (список через запятую), `fields` (sex, photo_100, last_seen, etc.).
*   **Что отдает:** Массив объектов `User`.
*   **Альтернативы:**
    *   Получение данных внутри других методов (например, `wall.getComments` с `extended=1`), что мы и делаем для оптимизации. `users.get` используется для массового обновления уже сохраненных ID.

### `groups.getMembers`
*   **Зачем нужен:** Полная синхронизация списка подписчиков сообщества.
*   **Как делается:** `POST` запрос.
    *   Параметры: `group_id`, `count` (до 1000), `offset`, `fields` (для получения деталей сразу).
*   **Что отдает:** Список ID пользователей (или объектов, если указаны `fields`) и общее количество `count`.
*   **Альтернативы:** Нет прямых альтернатив для получения полного списка участников.

### `utils.resolveScreenName`
*   **Зачем нужен:** Преобразование короткого имени (например, `durov` или `club123`) в числовой ID объекта. Используется при добавлении проектов по URL.
*   **Как делается:** `POST` запрос.
    *   Параметры: `screen_name`.
*   **Что отдает:** Объект `{ type: 'group'|'user', object_id: 123 }`.

---

## 2. Стена и Посты (Wall)

Самая активно используемая группа методов для работы с контентом.

### `wall.get`
*   **Зачем нужен:** Универсальный метод для получения списков постов.
    1.  **Опубликованные:** Вызывается без фильтров.
    2.  **Отложенные:** Вызывается с `filter='postponed'`.
    3.  **Предложенные:** Вызывается с `filter='suggests'`.
*   **Как делается:** `POST` запрос.
    *   Параметры: `owner_id` (отрицательный для групп), `count`, `offset`, `filter`.
*   **Что отдает:** Объект `{ count: 100, items: [PostObject, ...] }`.
*   **Альтернативы:**
    *   `wall.getById` — если известен конкретный ID поста.
    *   `newsfeed.get` — для получения ленты новостей пользователя (не подходит для управления группой).

### `wall.getById`
*   **Зачем нужен:** Получение данных **одного** конкретного поста сразу после его создания или публикации, чтобы сохранить в кеш полную структуру (с ссылками на фото и вложения).
*   **Как делается:** `POST` запрос.
    *   Параметры: `posts` (строка вида `ownerId_postId`).
*   **Что отдает:** Массив из одного объекта поста.

### `wall.post`
*   **Зачем нужен:**
    1.  Создание нового поста (опубликованного или отложенного).
    2.  Публикация системного поста в VK.
*   **Как делается:** `POST` запрос.
    *   Параметры: `owner_id`, `message`, `attachments`, `publish_date` (для отложки).
*   **Что отдает:** `{ post_id: 123 }`.

### `wall.edit`
*   **Зачем нужен:** Редактирование содержимого уже существующего поста (текст, медиа).
*   **Как делается:** `POST` запрос.
    *   Параметры: `owner_id`, `post_id`, `message`, ...
*   **Что отдает:** `{ success: 1 }`.

### `wall.delete`
*   **Зачем нужен:** Удаление поста со стены или из отложки VK.
*   **Как делается:** `POST` запрос.
    *   Параметры: `owner_id`, `post_id`.
*   **Что отдает:** `{ success: 1 }`.

---

## 3. Фотографии и Медиа (Photos)

Методы для работы с галереей и вложениями.

### `photos.getAlbums`
*   **Зачем нужен:** Получение списка фотоальбомов сообщества для отображения в галерее.
*   **Что отдает:** Список объектов альбомов (ID, название, размер).

### `photos.get`
*   **Зачем нужен:** Получение всех фотографий из конкретного альбома. Используется для наполнения галереи.
*   **Что отдает:** Список объектов фото с ссылками на разные размеры.

### `photos.createAlbum`
*   **Зачем нужен:** Создание нового фотоальбома.

### Процесс загрузки фото (Wall / Market / Album)
Загрузка фото в VK всегда происходит в 3 этапа. Мы используем разные методы для разных целей:

1.  **Получение сервера:**
    *   `photos.getWallUploadServer` — для фото к посту.
    *   `photos.getMarketUploadServer` — для фото товара.
    *   `photos.getUploadServer` — для фото в альбом.
2.  **Загрузка файла:** Стандартный HTTP POST запрос (не метод API) на полученный URL.
3.  **Сохранение результата:**
    *   `photos.saveWallPhoto`
    *   `photos.saveMarketPhoto`
    *   `photos.save` (для альбомов)

---

## 4. Товары (Market)

Методы для управления магазином сообщества.

### `market.getCategories`
*   **Зачем нужен:** Получение глобального дерева категорий товаров VK (нужно для создания товаров).
*   **Что отдает:** Список категорий с ID и названиями секций.

### `market.getAlbums`
*   **Зачем нужен:** Получение "подборок" товаров (аналог категорий внутри магазина).

### `market.get`
*   **Зачем нужен:** Получение списка товаров.
*   **Важная деталь:** Мы используем параметр `extended=1`.
    *   **Зачем:** В стандартном ответе нет поля `albums_ids` (привязка к подборкам). С флагом `extended` VK отдает это поле для каждого товара.
    *   **Оптимизация:** Это позволяет загрузить все товары и их связи за один проход, вместо того чтобы делать отдельный запрос для каждой подборки (`market.get` с `album_id`).

### `market.add` / `market.edit` / `market.delete`
*   **Зачем нужны:** Стандартные CRUD операции для товаров.

### `market.addToAlbum` / `market.removeFromAlbum`
*   **Зачем нужны:** Привязка и отвязка товаров от подборок.
*   **Особенность:** Это отдельные методы, они не являются частью `market.edit`. Наш бэкенд вызывает их автоматически при изменении состава подборок у товара.

---

## 5. Активности (Interactions)

Методы для сбора статистики и списков активных пользователей.

### `likes.getList`
*   **Зачем нужен:** Получение списка пользователей, лайкнувших пост.
*   **Параметры:** `type='post'`, `extended=1` (чтобы сразу получить профили пользователей, а не только ID).

### `wall.getComments`
*   **Зачем нужен:** Получение списка комментариев к посту.
*   **Параметры:** `extended=1` (возвращает поле `profiles` с данными авторов комментариев).

### `wall.getReposts`
*   **Зачем нужен:** Получение списка репостов.
*   **Параметры:** `extended=1`.

---

## Общая стратегия использования

1.  **Приоритет `extended=1`:** Везде, где возможно, мы используем расширенный формат ответа, чтобы получить данные профилей (имя, фото) или дополнительные поля (подборки товаров) за один запрос. Это снижает количество обращений к API и ускоряет работу.
2.  **Изоляция:** Все вызовы методов проходят через обертку `call_vk_api` (в `api_client.py`), которая обрабатывает капчу (в будущем), ошибки сети и лимиты запросов (Rate Limiting).
