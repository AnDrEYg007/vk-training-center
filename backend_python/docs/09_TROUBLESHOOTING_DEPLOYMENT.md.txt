# План тестирования и устранения проблем при деплое

Это классическая и очень коварная проблема при разработке, когда кажется, что все обновлено, но магии не происходит.

Если вы **100% уверены**, что выбрали правильный тег образа в Яндекс.Облаке (v22 или новее), то причина почти наверняка кроется в **файловой системе вашего компьютера** в момент сборки Docker-образа.

Вот 3 самые вероятные причины, от самой частой к более редким:

## Причина №1 (Самая вероятная): Конфликт файлов .py и .py.txt

Docker собирает образ из того, что лежит в папке.
Вспомните, как вы обновляли код. Вы скачивали файлы из нашего чата. Они скачиваются как `filename.py.txt`.

**Сценарий катастрофы:**
1. В папке `backend_python` у вас лежит старый файл `main.py` (от прошлой недели).
2. Вы скачали новый код, и он сохранился рядом как `main.py.txt`.
3. Вы запускаете `docker build`.
4. Docker копирует **ОБА** файла внутрь контейнера.
5. При запуске Python видит `main.py` и запускает его. **А это старый файл!** Новый `main.py.txt` просто лежит рядом мертвым грузом.

**Как проверить и исправить:**
1. Зайдите в папку `backend_python` на компьютере.
2. Удалите **ВСЕ** старые файлы с расширением `.py`.
3. Переименуйте все новые файлы `.py.txt` в `.py`.
4. **Особенно важно проверить папку `routers/`**. Если там лежит старый `lists.py` и новый `lists.py.txt`, сервер будет использовать старый, и вы получите 404 на новые эндпоинты.

## Причина №2: Изменился URL контейнера

Если вы удаляли контейнер и создавали его заново (а не просто делали новую ревизию), у него изменился публичный URL.

1. Зайдите в Яндекс.Облако -> Контейнер -> Обзор.
2. Скопируйте "Служебный домен" (URL).
3. Откройте код фронтенда: `shared/config.ts`.
4. Сравните переменную `PRE_PRODUCTION_API_URL` с тем, что вы скопировали. Они должны совпадать символ в символ.
5. Если изменили -> пересоберите фронтенд (`npm run build`) и залейте в S3.

## Причина №3: Кеш браузера (Frontend)

Иногда браузер агрессивно кеширует JS-файлы.

1. Откройте ваш сайт (предпрод).
2. Нажмите `F12` (DevTools).
3. Перейдите во вкладку **Network** (Сеть).
4. Поставьте галочку **Disable cache** (Отключить кеш).
5. Обновите страницу.
6. Проверьте, ушла ли ошибка.

---

## План действий ("Лечение")

1.  **Очистка:** В папке `backend_python` удалите все старые `.py` файлы и переименуйте новые `.py.txt` в `.py`.
2.  **Сборка:** Соберите новый образ с тегом **v25** (чтобы наверняка).
    ```cmd
    docker build -t vk-planner-backend-preprod .
    docker tag vk-planner-backend-preprod cr.yandex/crpq5n1men523nvih5j4/vk-planner-backend:v25
    docker push cr.yandex/crpq5n1men523nvih5j4/vk-planner-backend:v25
    ```
3.  **Деплой:** В Яндекс.Облаке создайте ревизию с образом `:v25`.
4.  **Проверка:** Откройте сайт, нажмите `Ctrl + F5` (жесткая перезагрузка) и попробуйте снова.

---

## Если это не помогло (Неочевидные причины)

Если вы уверены, что:
1.  Файлы на компьютере обновлены (и расширения `.txt` убраны).
2.  Образ собран с **новым тегом**.
3.  В Яндекс.Облаке создана ревизия именно с **этим новым тегом**.

...но код всё равно старый, вот список неочевидных причин, от самой частой к редкой:

### 1. Docker закешировал старые слои (Очень часто!)
Docker пытается оптимизировать сборку и не пересобирает слои, если считает, что файлы не изменились. Иногда он "ошибается" или не замечает изменений в файлах, если не изменились метаданные.

**Решение:**
Соберите образ с флагом отключения кеша. Это заставит Docker перечитать все файлы с диска заново.

```cmd
docker build --no-cache -t vk-planner-backend-preprod .
```
*(Дальше тегирование и пуш как обычно)*

### 2. Контейнер падает при старте (CrashLoopBackOff)
В Serverless Containers есть нюанс: если вы выкатываете новую ревизию, и она **падает с ошибкой при запуске** (например, синтаксическая ошибка в Python или забыли переменную окружения), Яндекс может:
а) Либо показать ошибку.
б) Либо (в некоторых конфигурациях) продолжить перенаправлять трафик на **последнюю живую ревизию**, чтобы сервис не лежал.

**Как проверить:**
1.  Зайдите в Яндекс.Консоль -> Контейнер -> **Логи**.
2.  Посмотрите самые свежие записи.
3.  Нет ли там ошибок Python (`SyntaxError`, `ImportError`, `ModuleNotFoundError`)?
4.  Если есть ошибка, значит новая версия "не взлетела", и вы видите старую версию, потому что новая умерла.

### 3. Вы забыли подключить роутер в `main.py`
Вы могли скачать новые файлы `routers/system_accounts.py`, но забыть обновить `main.py`.
FastAPI не подхватывает файлы магически. Их нужно явно импортировать и подключить.

**Проверьте локально файл `backend_python/main.py`:**
Убедитесь, что там есть эти строки:
```python
# Импорт
from routers import ..., system_accounts  # <--- Важно

# Подключение
app.include_router(system_accounts.router, prefix="/api", tags=["System Accounts"]) # <--- Важно
```
Если файла `system_accounts.py` физически нет в папке `routers` или он не подключен в `main.py` — вы получите 404.

### 4. Распределение трафика (Traffic Splitting)
В Serverless Containers можно распределять трафик между ревизиями.
Зайдите в Контейнер -> **Обзор**.
Убедитесь, что **100%** трафика направлено на тег `latest` (или на вашу конкретную последнюю ревизию). Иногда там может зависнуть старая ревизия как "фиксированная".

### 5. "Лайфхак" для проверки (Print Debugging)
Чтобы на 100% понять, какая версия кода сейчас работает в облаке, сделайте следующее:

1.  Откройте `backend_python/main.py`.
2.  В самом начале, где создается `app`, добавьте принт с версией:
    ```python
    app = FastAPI()
    print("!!! ЗАПУЩЕНА ВЕРСИЯ v26 - С ПРОВЕРКОЙ !!!") # Изменяйте текст каждый раз
    ```
3.  Сделайте `--no-cache` сборку, пуш, деплой.
4.  Откройте логи в Яндексе.
5.  Если вы **не видите** эту надпись при старте контейнера — значит, вы деплоите не то, что думаете (не та папка, не тот файл, кеш докера).
6.  Если **видите** — значит код обновился, и проблема в чем-то другом (например, вы забыли зарегистрировать роутер, см. пункт 3).
