# Схема Базы Данных (SQLAlchemy / SQLite & PostgreSQL)

Этот документ описывает принципы, по которым строится структура базы данных в новой архитектуре на Python.

## 1. Источник правды: Модели SQLAlchemy

В отличие от предыдущей версии, где схема была определена вручную в Google Sheets, теперь структура базы данных **определяется кодом**.

Единственным источником правды для схемы БД являются **ORM-модели SQLAlchemy**, которые находятся в файле:

-   **Файл**: `backend_python/models.py.txt`

### Ключевые модели (таблицы):

-   `Project`: Хранит все данные и настройки проектов.
-   `Post`: Используется как кеш для **опубликованных** постов.
-   `ScheduledPost`: Используется как кеш для **отложенных** постов.
-   `SystemPost`: Хранит **системные публикации**, управляемые внутренним планировщиком.
-   `SuggestedPost`: Хранит **предложенные** посты.
-   `Note`: Хранит заметки (стикеры) для календаря.
-   `Tag`: Хранит информацию о тегах (название, ключевое слово, цвет).
-   `AiPromptPreset`: Новая таблица для хранения шаблонов системных инструкций для AI.
-   `Album`: Хранит кеш метаданных фотоальбомов проекта.
-   `Photo`: Хранит кеш метаданных фотографий из альбомов.
-   `User`: Новая таблица для хранения учетных данных пользователей системы.
-   **`GlobalVariableDefinition`**: Новая таблица (глобальная). Хранит определения ("типы") глобальных переменных, такие как "Адрес", "Телефон" и их `placeholder_key` (например, `adress`).
-   **`ProjectGlobalVariableValue`**: Новая таблица. Хранит конкретные **значения** глобальных переменных для каждого проекта (например, "ул. Ленина, 1" для проекта А).

### Связь "многие-ко-многим" для тегов

Для реализации возможности присваивать посту несколько тегов используются две ассоциативные таблицы:
-   `published_post_tags`: Связывает опубликованные посты (`Post`) с тегами (`Tag`).
-   `scheduled_post_tags`: Связывает отложенные посты (`ScheduledPost`) с тегами (`Tag`).

## 2. Автоматическое создание и миграции

-   **Создание БД**: При первом запуске Python-бэкенда, файл базы данных `vk_planner.db` (SQLite) и все таблицы создаются **автоматически** на основе моделей в `models.py.txt`.
-   **Миграции**: Простые миграции (например, добавление новой колонки) выполняются автоматически при запуске сервера с помощью логики в `migrations.py.txt`. Это обеспечивает плавное обновление структуры БД при развертывании новых версий кода.

## 3. Как посмотреть актуальную схему?

1.  Откройте файл `backend_python/models.py.txt` и изучите классы, унаследованные от `Base`. Каждое поле класса (`Column(...)`) соответствует колонке в таблице базы данных.
2.  Используйте любой инструмент для просмотра баз данных SQLite (например, DB Browser for SQLite, DBeaver) и откройте файл `vk_planner.db`, который создается в папке `backend_python` после первого запуска сервера в локальном режиме.