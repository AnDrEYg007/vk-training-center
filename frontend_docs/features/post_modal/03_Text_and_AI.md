# Работа с текстом и AI в окне поста

**Компонент:** `features/posts/components/modals/PostTextSection.tsx`

## 1. Текстовый редактор
*   Используется стандартный `textarea`.
*   **Вставка:** Переменные и эмодзи вставляются в текущую позицию курсора (`selectionStart`). После вставки фокус возвращается в поле, курсор сдвигается.

## 2. Переменные (`VariablesSelector`)
*   **Типы:**
    *   **Локальные:** Хранятся в настройках проекта (строка в БД).
    *   **Глобальные:** Хранятся в таблице `global_variable_definitions`.
*   **Отображение:** Загружаются асинхронно. Глобальные переменные отображаются с префиксом `{global_...}`.
*   **Подстановка:** Происходит **на бэкенде** в момент публикации. В UI пользователь видит плейсхолдеры. Исключение — системные посты в календаре, там показывается превью с подставленными значениями.

## 3. AI-Помощник (`AIGenerator`)
**Хук:** `features/posts/hooks/useAIGenerator.ts`

### Управление историей (Chat)
*   История хранится локально в рамках сессии редактирования.
*   **Контекстные ответы:**
    *   Двойной клик по сообщению AI -> переводит поле ввода в режим "Ответ".
    *   В промпт добавляется контекст предыдущего сообщения.
    *   В UI отображается цитата. Клик по цитате скроллит к оригиналу.

### Шаблоны инструкций (Presets)
*   Пользователь может выбрать системный промпт из списка сохраненных.
*   **Сохранение на лету:** Если пользователь написал удачный промпт, он может нажать "Сохранить как шаблон". Появится инлайн-форма для ввода имени.
*   **API:** Использует `ai_preset.api.ts`.

### Генерация
*   Запрос отправляется на `/api/ai/generatePostText`.
*   Бэкенд использует прокси SOCKS5 для обхода ограничений Gemini.
*   Поддерживается кнопка "Сгенерировать заново" (повтор запроса с теми же параметрами).