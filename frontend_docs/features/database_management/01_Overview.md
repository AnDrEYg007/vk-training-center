
# Управление базой проектов

**Компонент:** `features/database-management/components/DatabaseManagementPage.tsx`
**Таблица:** `features/database-management/components/ProjectTable.tsx`

## 1. Редактируемая таблица (`ProjectTable`)

Это основной инструмент администратора.

### Управление колонками
*   Использует `localStorage` для запоминания состояния видимости колонок (`visibleColumns`) и их ширины.
*   Ресайз колонок реализован вручную через обработку событий мыши на заголовках таблицы.

### Безопасность отображения данных (Masking)
В таблице проектов отображаются чувствительные данные, такие как `communityToken`.
*   **Маскировка:** По умолчанию токен скрыт маской вида `vk1.a.*******A1b2`. Это реализовано функцией `maskToken` внутри компонента.
*   **Редактирование:**
    *   В обычном состоянии ячейка отображает маску и имеет стиль, похожий на `badge` (серый фон).
    *   При клике на ячейку она превращается в поле ввода (`input`), показывая **реальное значение** токена для редактирования.
    *   При потере фокуса (`onBlur`) поле снова превращается в замаскированный текст.
    *   Если токен не задан, отображается красная плашка "Не задан".

### Инлайн-редактирование
*   Изменения не отправляются на сервер мгновенно. Они накапливаются в состоянии `editedProjects` (объект `Record<projectId, Project>`).
*   Измененные строки подсвечиваются (`bg-amber-50`).
*   Кнопка "Сохранить" в хедере становится активной только при наличии изменений (`isDirty`).

### Авто-нумерация (`handleAutoNumbering`)
Функция "Auto №" автоматически заполняет поле `sort_order` для проектов, где оно пустое. Она находит максимальный текущий номер и продолжает нумерацию с него.

### Умная сортировка
При ручном изменении номера (`sort_order`) в ячейке таблицы, срабатывает алгоритм, который автоматически сдвигает номера других проектов вверх или вниз, чтобы освободить место и избежать дубликатов.

## 2. Добавление проектов (`AddProjectsModal`)
*   Позволяет массово добавлять проекты, вставляя список ссылок (по одной на строку).
*   **Бэкенд-логика:** Сервер парсит ссылки, получает ID групп через VK API, проверяет их на дубликаты в базе и создает новые записи.
*   **Обратная связь:** Пользователь получает детальный отчет: сколько добавлено, сколько пропущено (дубли), сколько ошибок.

## 3. Глобальные переменные (`GlobalVariablesManagement`)
Отдельный режим страницы (`viewMode === 'global-variables'`).
*   Позволяет администратору создавать и редактировать **определения** глобальных переменных (Название, Ключ, Заметка).
*   Содержит строгую валидацию уникальности ключей и названий перед сохранением.

## 4. Архив (`ArchivePage`)
Отдельный режим страницы.
*   Отображает таблицу проектов с флагом `archived: true`.
*   Позволяет **Восстановить** проект (снимает флаг архива).
*   Позволяет **Удалить навсегда** (физическое удаление из БД со всеми постами). Требует подтверждения в `ConfirmationModal`.
