# 8. Руководство: Шаблоны AI-инструкций (AI Prompt Presets)

Этот документ является техническим гайдом, описывающим реализацию функционала для сохранения и повторного использования системных инструкций (промптов) для AI-помощника.

## 1. Общая концепция и назначение

**Проблема:** Пользователи часто находят удачные системные инструкции для AI, которые дают хороший результат, но вынуждены копировать их вручную каждый раз.
**Решение:** Предоставить пользователям возможность сохранять эти инструкции в виде именованных **шаблонов (пресетов)**, привязанных к конкретному проекту, и быстро переключаться между ними при генерации контента.

## 2. Архитектура и поток данных

Функционал реализован по стандартной для приложения трехуровневой архитектуре:

**[Бэкенд: Модель и API] ↔ [Фронтенд: Сервисы API] ↔ [Фронтенд: Хуки и Компоненты]**

### 2.1. Бэкенд (Backend)

1.  **Модель данных (`models.py.txt`):**
    -   Создана новая SQLAlchemy-модель `AiPromptPreset`.
    -   **Ключевые поля:** `id`, `project_id`, `name` (название шаблона), `prompt` (текст инструкции).

2.  **Схемы Pydantic (`schemas/`):**
    -   Определены Pydantic-схемы `AiPromptPreset`, `AiPromptPresetCreate` и т.д., для валидации данных.

3.  **CRUD (`crud/ai_prompt_preset_crud.py.txt`):**
    -   Реализованы базовые функции для взаимодействия с таблицей `ai_prompt_presets`: `get_presets_by_project_id`, `create_preset`, `update_preset`, `delete_preset`.

4.  **Сервис и Роутер (`services/` и `routers/`):**
    -   Создан новый сервисный слой и роутер (`ai_prompt_preset_service.py.txt` и `ai_presets.py.txt`), которые предоставляют REST API для управления шаблонами.
    -   **Эндпоинты:** `/api/ai-presets/getForProject`, `/create`, `/update/{id}`, `/delete/{id}`.

### 2.2. Фронтенд (Frontend)

1.  **API-сервисы (`services/api/ai_preset.api.ts`):**
    -   Создан новый модуль, содержащий функции-клиенты (`getAiPresets`, `createAiPreset` и т.д.) для вызова соответствующих эндпоинтов бэкенда.

2.  **Хук `useProjectSettingsManager` (`features/projects/hooks/useProjectSettingsManager.ts`):**
    -   Этот хук был расширен для управления состоянием шаблонов внутри модального окна настроек проекта.
    -   Он загружает шаблоны при открытии окна и включает в `handleSubmit` логику для отправки запросов на их создание/обновление/удаление.

3.  **Компонент-редактор (`features/projects/components/modals/AiPromptPresetsEditor.tsx`):**
    -   Новый "глупый" компонент, который рендерит список полей для редактирования названий и текстов шаблонов.

4.  **Хук `useAIGenerator` (`features/posts/hooks/useAIGenerator.ts`):**
    -   Основной хук для AI-помощника. В него добавлена логика для:
        -   Загрузки списка доступных шаблонов (`aiPresets`).
        -   Управления выбором активного шаблона (`selectedPreset`).
        -   Сохранения или обновления шаблона "на лету" из интерфейса.

5.  **Компоненты UI:**
    -   **`ProjectSettingsModal.tsx`**: Интегрирует `AiPromptPresetsEditor` в новый аккордеон.
    -   **`SystemPromptControls.tsx`**: Отображает список кнопок-шаблонов и кнопку "Сохранить/Обновить шаблон" в интерфейсе AI-помощника.

## 3. Пользовательские сценарии (User Flows)

### 3.1. Управление шаблонами (в настройках проекта)

1.  Пользователь открывает настройки проекта.
2.  Открывает раздел "Шаблоны AI-инструкций".
3.  Нажимает "+ Добавить шаблон", заполняет поля.
4.  Нажимает "Сохранить" в футере модального окна.
5.  `useProjectSettingsManager` вызывает `handleSubmit`, который, в свою очередь, отправляет `api.createAiPreset` на бэкенд.

### 3.2. Использование шаблона (в AI-помощнике)

1.  Пользователь открывает `PostDetailsModal` -> `AIGenerator`.
2.  Активирует "Использовать свою системную инструкцию".
3.  `useAIGenerator` загружает шаблоны через `api.getAiPresets`.
4.  `SystemPromptControls` рендерит кнопки с названиями шаблонов.
5.  Пользователь кликает на кнопку-шаблон.
6.  `handleSelectPreset` обновляет `customSystemPrompt` текстом из выбранного шаблона.

### 3.3. Сохранение/обновление шаблона "на лету"

1.  Пользователь вводит или редактирует текст в `textarea` для кастомной инструкции.
2.  Кнопка "Сохранить как шаблон" / "Обновить шаблон" становится активной.
3.  При нажатии вызывается `handleSavePreset`.
4.  **Если шаблон не был выбран (`selectedPreset` is `null`):**
    -   Открывается `window.prompt` для ввода имени.
    -   Вызывается `api.createAiPreset`.
5.  **Если шаблон был выбран:**
    -   Открывается модальное окно `ConfirmationModal` с вопросом о перезаписи.
    -   При подтверждении вызывается `api.updateAiPreset`.
6.  В обоих случаях локальное состояние `aiPresets` обновляется, и UI немедленно отражает изменения.