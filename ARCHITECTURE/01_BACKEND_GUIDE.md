# Руководство по бэкенду (Python/FastAPI)

Этот документ описывает ключевые принципы и структуру бэкенда, реализованного на Python с использованием фреймворка FastAPI.

**Ключевая папка**: `backend_python/`
**➡️ Подробная документация**: Для глубокого погружения в каждый аспект бэкенда, обратитесь к файлам в папке `backend_python/docs/`.

## 1. Модульная структура

Бэкенд имеет четкую модульную структуру, где каждый файл и папка отвечают за свою зону ответственности:

-   **`main.py.txt`**: Главная точка входа. Инициализирует FastAPI приложение, настраивает CORS, подключает роутеры и запускает начальные миграции базы данных.
-   **`database.py.txt`**: Настраивает подключение к базе данных (SQLite или PostgreSQL) и создает фабрику сессий для SQLAlchemy.
-   **`models.py.txt`**: Определяет структуру таблиц базы данных с помощью ORM-моделей SQLAlchemy.
-   **Папка `schemas/`**: Определяет схемы данных для API (валидация запросов и форматирование ответов) с помощью Pydantic. Разделена на `base_models`, `api_payloads` и `api_responses`.
-   **Папка `crud/`**: Содержит слой доступа к данным (Data Access Layer). Логика разделена на модули по доменным областям (например, `project_crud.py.txt`, `market_crud.py.txt`).
-   **Папка `routers/`**: Каждый файл здесь определяет группу связанных API эндпоинтов (например, `projects.py.txt`, `market.py.txt`). Они отвечают за прием HTTP-запросов.
-   **Папка `services/`**: Содержит бизнес-логику. Функции в сервисах вызывают CRUD-функции и функции для работы с внешними API, координируя всю работу.
    -   **`vk_service.py.txt` (Фасад)**: Высокоуровневый сервис для сложных операций с VK (например, загрузка фото).
    -   **`vk_api/` (Пакет)**: Низкоуровневая, изолированная логика для взаимодействия с VK API (клиент с ретраями, форматтеры).
    -   **`market_service.py.txt` (Фасад)**: Точка входа для всех операций с товарами.
    -   **`market_retrieval_service.py.txt` и другие**: Специализированные сервисы для получения, обновления и создания товаров.
    -   **`post_tracker_service.py.txt`**: Фоновый сервис для публикации и верификации "системных постов".
    -   **`market_ai_service.py.txt`**: Логика для использования AI в контексте товаров (подбор категорий, коррекция).

## 2. Поток данных (Request Flow)

FastAPI использует декораторы для определения API эндпоинтов. Типичный запрос проходит следующий путь:

**`[Router]` -> `[Service]` -> `[CRUD / External API]`**

1.  **`routers/*.py.txt`**: Принимает HTTP-запрос, валидирует его тело с помощью Pydantic-схемы и вызывает соответствующую функцию в сервисном слое.
2.  **`services/*.py.txt`**: Выполняет бизнес-логику. Может вызывать:
    -   Функции из `crud/` для работы с локальной базой данных.
    -   Функции из `vk_service.py.txt` для взаимодействия с VK.
    -   Функции из `gemini_service.py.txt` для взаимодействия с AI.
3.  **`crud/*.py.txt`**: Выполняет конкретный SQLAlchemy-запрос к базе данных и возвращает результат.

## 3. Валидация и сериализация данных

Pydantic (папка `schemas/`) является основой для валидации данных.

-   **Входящие данные**: FastAPI автоматически парсит JSON из тела запроса и проверяет его соответствие Pydantic-модели, указанной в аргументах функции.
-   **Исходящие данные**: Данные, возвращаемые из эндпоинта, автоматически преобразуются в JSON в соответствии с моделью, указанной в `response_model`.

## 4. Конфигурация и безопасность

-   **`config.py.txt`**: Загружает конфигурацию (токены, пароли) из файла `.env` или переменных окружения.
-   **Никаких секретов в коде**: Все чувствительные данные хранятся вне системы контроля версий.
