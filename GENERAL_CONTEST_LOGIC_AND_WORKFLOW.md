# Техническое задание и Логика работы "Универсального конкурса" (General Contest)

Этот документ служит полным описанием структуры, логики и правил работы функционала "Универсальный конкурс". Документ будет дополняться по мере поступления информации от заказчика.

## 1. Общее описание
"Универсальный конкурс" (General Contest) — это самостоятельная сущность внутри проекта. В рамках проекта может быть создано и запущено множество независимых экземпляров таких конкурсов.

Основная цель сущности — автоматизировать проведение розыгрышей призов среди аудитории с четким жизненным циклом от анонса до выдачи призов.

## 2. Жизненный цикл конкурса (User & Public Flow)
С точки зрения пользователя и публичной активности (ВКонтакте), полный цикл выглядит следующим образом:

1.  **Публикация анонса (Start)**
    *   Публикуется пост с описанием призов (что дарим, количество).
    *   Указываются условия участия (что нужно сделать пользователю).
    *   Указывается точная дата и время подведения итогов.

2.  **Активная фаза**
    *   Пост доступен аудитории.
    *   Пользователи выполняют условия участия.

3.  **Подведение итогов (Deadline)**
    *   Наступает указанная в анонсе дата и время.
    *    Система обязана подвести итоги в соответствии с заданными правилами.

4.  **Публикация итогов (Results)**
    *   Публикуется **отдельный пост** с итогами.
    *   В посте упоминаются победители.
    *   Объявляется, что конкурс завершен.

5.  **Выдача призов**
    *   Победителям выдаются промокоды (механизм выдачи может варьироваться, но факт выдачи обязателен).

6.  **Завершение**
    *   После публикации анонса, подведения итогов и выдачи призов механика данного экземпляра конкурса считается полностью завершенной.

## 3. Структура данных (Сущность Конкурса)

### 3.1. Служебные поля (для пользователя системы)
Эти поля нужны только для внутреннего интерфейса пользователя, чтобы различать конкурсы между собой в списке. Они **не публикуются** во ВКонтакте.

*   **Название (Internal Name)**: Краткое наименование конкурса.
    *   *Пример*: "Новогодний розыгрыш", "Розыгрыш айфона".
    *   *Назначение*: Идентификация в списке конкурсов.
*   **Описание (Internal Description)**: Заметка или расширенное описание для самого себя.
    *   *Пример*: "Розыгрыш для привлечения новой аудитории из Москвы".
    *   *Назначение*: Напоминание о сути конкурса, чтобы не запутаться.

### 3.2. Публичные поля и настройки (Выбор источника и Стандартный сценарий)
В настройках конкурса пользователь выбирает способ старта через переключатель (тумблер):

#### Сценарий А: "Создать Новый Пост" (Стандартный / По умолчанию)
В этом режиме пользователь полностью формирует будущий пост внутри интерфейса конкурса.

1.  **Дата и время публикации**:
    *   Поле выбора даты и времени (локальное время).
    *   Определяет момент, когда пост попадет в ленту сообщества и конкурс начнется.
2.  **Текст поста**:
    *   Поле ввода основного контента.
    *   **Поддержка переменных**: Обязательная поддержка вставки локальных и глобальных переменных (например, `{WinnerCount}`, `{ProjectName}`).
    *   **UI**: Интерфейс должен иметь меню/кнопку для выбора и вставки переменных (как в "Отложенных записях").
3.  **Медиа-вложения**:
    *   Возможность загрузить и прикрепить изображения (Drag & Drop или выбор из устройств).
4.  **Результат**:
    *   Система создает запись в БД с типом `GENERAL_CONTEST_START`.
    *   Пост отображается в расписании.
    *   Автоматическая публикация произойдет в указанное время через планировщик.

#### Сценарий Б: "Выбрать Существующий Пост"
Позволяет привязать механику к уже опубликованному посту (созданному вручную или вне системы).

1.  **Способ 1: Вставка ссылки**:
    *   Поле ввода URL.
    *   Парсинг ID поста из ссылки.
    *   Подтягивание превью (текст, картинка) для верификации.
2.  **Способ 2: Выбор из базы**:
    *   Кнопка "Выбрать из списка".
    *   Модальное окно со списком опубликованных постов.
    *   Функция "Обновить список" (запрос последних 50-100 постов из API ВК) для поиска свежих публикаций.

*При выборе существующего поста статус конкурса может быть сразу переведен в "Запущен" (если пост валиден), а этап планирования пропускается.*

### 3.3. Условия и Призы (Логика выбора победителей)
_Ожидается описание правил выбора победителей и типов призов..._

### 3.4. Настройки Поста-Итогов (Results Post / End)
Это "финишная лента" конкурса. Технически это такая же сущность, как пост-старт (дата, текст, картинки), но с особыми свойствами.

1.  **Поля настройки**:
    *   **Дата и время**: Когда конкурс должен завершиться и объявить победителей.
    *   **Текст поста**: Шаблон финального сообщения.
    *   **Медиа-вложения**: Картинки поста итогов.
2.  **Специальные переменные**:
    *   В отличие от старта, здесь обязательна поддержка динамических переменных результатов:
        *   `{Winners}` / `{UserIDs}` — упоминания победителей (ссылки на аккаунты).
        *   `{PromoCodes}` / `{PrizeInfo}` — информация о выданных призах/кодах.
        *   Внутренние переменные описания.
3.  **Отображение в системе**:
    *   При сохранении появляется в Расписании.
    *   Имеет тип `GENERAL_CONTEST_END`.
    *   Визуально отличается: "Пост подведения итогов [Название конкурса]".
    *   Позволяет пользователю видеть в календаре, когда именно произойдет розыгрыш.

## 4. Архитектура и интеграция с расписанием

### 4.1. Связь "Конкурс <-> Пост"
*   **Генерация ID**: При создании конкурса ему присваивается уникальный внутренний идентификатор (`contest_id`).
*   **Создание Системного Поста**: При сохранении настроек конкурса, система автоматически создает запись (пост) в базе данных.
*   **Жесткая привязка**:
    *   Созданный пост помечается специальным флагом/типом `GENERAL_CONTEST_START`.
    *   В метаданных поста прописывается `contest_id` конкретного конкурса.
    *   Система должна однозначно идентифицировать пост как "Стартовый пост конкурса 'Розыгрыш айфона'".

### 4.2. Ограничения редактирования (UX в расписании)
*   Пост отображается в общем расписании.
*   **Визуализация**: Карточка поста в календаре должна отличаться от обычных постов. Пользователь должен видеть, что это "Универсальный конкурс" и видеть его внутреннее название.
*   **Защита целостности**:
    *   Прямое редактирование этого поста через обычный редактор запрещено.
    *   При клике на пост в календаре открывается модальное окно: "Этот пост является частью настройки Конкурса. Для изменения перейдите в настройки конкурса".
    *   Присутствует кнопка перехода к редактированию самого конкурса.
    *   *Аналогия*: Поведение идентично системным постам "Конкурс отзывов" или "AI Публикации".

### 4.3. Бэкенд-логика: Публикация и Активация
Процесс публикации поста-анонса запускает механику конкурса:

1.  **Tracker Detection**: Пост-трекер (планировщик) видит пост конкурса в расписании (по типу `GENERAL_CONTEST_START`).
2.  **Публикация в ВК**: Трекер отправляет запрос в API ВКонтакте на публикацию.
3.  **Обработка ответа ВК**: ВКонтакте возвращает `post_id` (ID опубликованного поста).
4.  **Обновление статуса Конкурса**:
    *   Система находит связанный конкурс по `contest_id`.
    *   **Сохранение ID**: Записывает полученный `vk_post_id` в базу данных конкурса (это "Source Post", источник для сбора участников).
    *   **Смена статуса**: Переводит статус конкурса в **"Запущен" (Active/Running)**.
5.  **Отображение**: В настройках конкурса теперь должна отображаться ссылка на реальный пост в ВК или его ID, подтверждая, что механизм запущен по конкретному посту.

### 4.4. Статус "Опубликован" и защита целостности в Расписании
После публикации поста и получения `vk_post_id`, пост в расписании переходит в статус "Опубликован", но сохраняет жесткую связь с конкурсом.

*   **Визуализация**:
    *   В сетке расписания (среди опубликованных) пост должен иметь метку "Используется в автоматизации" или иконку конкурса.
    *   Пользователь должен сразу видеть, что это не обычный пост.
*   **Блокировка действий (Locking)**:
    *   **Редактирование и Удаление**: Прямые действия по удалению или редактированию такого поста из расписания **заблокированы**.
    *   **Причина**: Удаление поста разрушит логику работы активной механики (сбор участников, подведение итогов).
*   **Workflow отключения**:
    *   При попытке удаления/редактирования из расписания должно появляться модальное окно/сообщение: *"Этот пост обеспечивает работу активного конкурса. Для изменений сначала остановите механику в настройках конкурса"*.
    *   **Правило**: Пока статус конкурса "Запущен" (активен) — пост в расписании заблокирован. Только ручная остановка механики (выключение тумблера активности) снимает блокировку с поста.

### 4.5. Бэкенд-логика: Пост-Итогов как Триггер
Логика публикации итогов кардинально отличается от обычной публикации.

1.  **Сущность в базе**: Пост-Итогов сохраняется в базе расписания (ScheduledPost) с типом `GENERAL_CONTEST_END` и `contest_id`.
2.  **Роль в Расписании**:
    *   Это не просто контент для публикации, это **Триггер события**.
    *   Он занимает слот в календаре, показывая пользователю, когда завершится конкурс.
3.  **Обработка Трекером (Tracker Execution)**:
    *   Когда подходит время, Пост-Трекер видит тип `GENERAL_CONTEST_END`.
    *   **Важно**: Он **НЕ публикует** этот пост через стандартный метод `api.wall.post`.
    *   Вместо этого он вызывает метод сервиса конкурсов: `ContestService.process_results(contest_id)`.
    *   Tracker на этом этапе считает свою задачу выполненной.
4.  **Логика Сервиса Конкурсов**:
    1.  Запускает алгоритм выбора победителей (согласно условиям).
    2.  Берет *текст шаблона* из Поста-Итогов.
    3.  Заменяет переменные (имена победителей, промокоды) на реальные данные.
    4.  Публикует финальный сформированный контент в ВК.
5.  **Очистка (Cleanup)**:
    *   Исходный *запланированный* пост-итогов ("триггер") удаляется из системы расписания, так как он "отработал".
    *   В истории или логах конкурса сохраняется ссылка на реально опубликованный пост с итогами.

## 5. Пользовательский интерфейс и UX

### 5.1. Интерфейс карточки конкурса (Статус: Запущен)
Когда механика перешла в статус "Запущена" (Active), интерфейс редактирования/просмотра конкурса должен изменяться:

*   **Индикатор статуса**: Явное визуальное отображение статуса "ЗАПУЩЕНА" (например, зеленый бейдж).
*   **Блок "Активный пост"**:
    *   Пользователь должен видеть, какой именно пост сейчас "в работе" у этой механики.
    *   Должна отображаться ссылка на пост ВКонтакте или превью поста.
    *   Текст: "Вот пост, который сейчас в работе у данной механики".
    *   Это дает пользователю уверенность, что система отслеживает правильную публикацию.

## 4. Логика работы (Backend/Frontend)
_Ожидается описание алгоритмов, последовательности действий и связей..._

## 5. Связи и зависимости
_Ожидается описание связей с другими модулями..._

---
**Статус**: Ожидание ввода данных от пользователя.
